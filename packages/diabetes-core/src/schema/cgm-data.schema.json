{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://o4o.com/schemas/diabetes-core/cgm-data.json",
  "title": "CGM Data Schema",
  "description": "DiabetesCare Core CGM 데이터 스키마",
  "version": "1.0.0",

  "definitions": {
    "CGMReading": {
      "type": "object",
      "description": "개별 CGM 측정값",
      "required": ["timestamp", "glucoseValue"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "측정 시간 (ISO 8601)"
        },
        "glucoseValue": {
          "type": "number",
          "minimum": 20,
          "maximum": 600,
          "description": "혈당값 (mg/dL)"
        },
        "trend": {
          "type": "number",
          "description": "변화율 (mg/dL per minute)"
        },
        "quality": {
          "type": "string",
          "enum": ["good", "acceptable", "poor", "invalid"],
          "default": "good"
        },
        "rawData": {
          "type": "object",
          "description": "기기별 원시 데이터"
        }
      }
    },

    "CGMIngestRequest": {
      "type": "object",
      "description": "CGM 데이터 수집 요청",
      "required": ["deviceType", "readings"],
      "properties": {
        "deviceType": {
          "type": "string",
          "enum": ["freestyle_libre", "dexcom", "medtronic", "other"],
          "description": "CGM 기기 종류"
        },
        "deviceSerial": {
          "type": "string",
          "description": "기기 시리얼 번호"
        },
        "sensorId": {
          "type": "string",
          "description": "센서 ID"
        },
        "pharmacyId": {
          "type": "string",
          "format": "uuid",
          "description": "약국 ID"
        },
        "readings": {
          "type": "array",
          "items": { "$ref": "#/definitions/CGMReading" },
          "minItems": 1,
          "description": "CGM 측정값 배열"
        }
      }
    },

    "DailyMetrics": {
      "type": "object",
      "description": "일일 혈당 메트릭스",
      "properties": {
        "date": {
          "type": "string",
          "format": "date"
        },
        "totalReadings": { "type": "integer", "minimum": 0 },
        "meanGlucose": { "type": "number" },
        "medianGlucose": { "type": "number" },
        "minGlucose": { "type": "number" },
        "maxGlucose": { "type": "number" },
        "stdDev": { "type": "number" },
        "cv": {
          "type": "number",
          "description": "Coefficient of Variation (%)"
        },
        "gmi": {
          "type": "number",
          "description": "Glucose Management Indicator (추정 HbA1c)"
        },
        "tirPercent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Time in Range (70-180 mg/dL) %"
        },
        "tirBelowPercent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Time below Range (<70 mg/dL) %"
        },
        "tirAbovePercent": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Time above Range (>180 mg/dL) %"
        },
        "mage": {
          "type": "number",
          "description": "Mean Amplitude of Glycemic Excursions"
        },
        "hypoEvents": { "type": "integer", "minimum": 0 },
        "hyperEvents": { "type": "integer", "minimum": 0 }
      }
    },

    "CGMEvent": {
      "type": "object",
      "description": "혈당 이벤트",
      "required": ["eventType", "startTime", "severity"],
      "properties": {
        "eventType": {
          "type": "string",
          "enum": [
            "hypoglycemia",
            "severe_hypoglycemia",
            "hyperglycemia",
            "severe_hyperglycemia",
            "rapid_rise",
            "rapid_fall",
            "meal_response",
            "nocturnal_hypo",
            "dawn_phenomenon"
          ]
        },
        "severity": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "startTime": { "type": "string", "format": "date-time" },
        "endTime": { "type": "string", "format": "date-time" },
        "durationMinutes": { "type": "integer" },
        "peakValue": { "type": "number" },
        "description": { "type": "string" }
      }
    },

    "PatternAnalysis": {
      "type": "object",
      "description": "패턴 분석 결과",
      "properties": {
        "patternType": {
          "type": "string",
          "enum": [
            "recurring_hypo",
            "recurring_hyper",
            "post_meal_spike",
            "nocturnal_hypo",
            "dawn_phenomenon",
            "exercise_drop",
            "weekend_pattern",
            "time_of_day_pattern",
            "meal_response_pattern",
            "high_variability"
          ]
        },
        "confidence": {
          "type": "string",
          "enum": ["low", "medium", "high"]
        },
        "confidenceScore": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "occurrenceCount": { "type": "integer" },
        "description": { "type": "string" },
        "recommendations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "enum": ["lifestyle", "medication", "monitoring", "consultation"]
              },
              "priority": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              },
              "text": { "type": "string" }
            }
          }
        }
      }
    },

    "LifestyleNote": {
      "type": "object",
      "description": "생활 기록",
      "required": ["noteType", "timestamp"],
      "properties": {
        "noteType": {
          "type": "string",
          "enum": ["meal", "exercise", "medication", "insulin", "stress", "sleep", "illness", "other"]
        },
        "timestamp": { "type": "string", "format": "date-time" },
        "content": { "type": "string" },
        "mealType": {
          "type": "string",
          "enum": ["breakfast", "lunch", "dinner", "snack"]
        },
        "carbsGrams": { "type": "integer", "minimum": 0 },
        "exerciseDurationMinutes": { "type": "integer", "minimum": 0 },
        "exerciseIntensity": {
          "type": "string",
          "enum": ["light", "moderate", "vigorous"]
        },
        "medicationName": { "type": "string" },
        "dosage": { "type": "number" },
        "insulinType": {
          "type": "string",
          "enum": ["rapid", "short", "intermediate", "long", "mixed"]
        },
        "glucoseAtTime": { "type": "number" }
      }
    }
  },

  "type": "object",
  "properties": {
    "ingestRequest": { "$ref": "#/definitions/CGMIngestRequest" },
    "dailyMetrics": { "$ref": "#/definitions/DailyMetrics" },
    "event": { "$ref": "#/definitions/CGMEvent" },
    "pattern": { "$ref": "#/definitions/PatternAnalysis" },
    "lifestyleNote": { "$ref": "#/definitions/LifestyleNote" }
  }
}
