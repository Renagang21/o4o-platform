name: Deploy Web Services (Cloud Run)

# Deploy web services to Cloud Run on push to main/develop
# H9-0: Docker(Container) 배포 방식으로 전환
# 변경된 웹서버만 배포됨

concurrency:
  group: deploy-web-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'services/web-neture/**'
      - 'services/web-k-cosmetics/**'
      - 'services/web-kpa-society/**'
      - 'services/web-glycopharm/**'
      - 'services/web-glucoseview/**'
      - '.github/workflows/deploy-web-services.yml'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all, neture, k-cosmetics, kpa-society, glycopharm, glucoseview)'
        required: false
        default: 'all'

env:
  PROJECT_ID: netureyoutube
  REGION: asia-northeast3
  # Default API URL (neture uses this)
  VITE_API_BASE_URL: https://api.neture.co.kr
  # Service-specific API URLs (same-origin for cookie auth)
  VITE_API_URL_GLYCOPHARM: https://api.neture.co.kr
  VITE_API_URL_KPA_SOCIETY: https://api.neture.co.kr
  VITE_API_URL_GLUCOSEVIEW: https://api.neture.co.kr
  VITE_API_URL_K_COSMETICS: https://api.neture.co.kr

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      neture: ${{ steps.changes.outputs.neture }}
      k-cosmetics: ${{ steps.changes.outputs.k-cosmetics }}
      kpa-society: ${{ steps.changes.outputs.kpa-society }}
      glycopharm: ${{ steps.changes.outputs.glycopharm }}
      glucoseview: ${{ steps.changes.outputs.glucoseview }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        run: |
          # For workflow_dispatch with specific service
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICE="${{ github.event.inputs.service }}"
            if [ "$SERVICE" = "all" ]; then
              echo "neture=true" >> $GITHUB_OUTPUT
              echo "k-cosmetics=true" >> $GITHUB_OUTPUT
              echo "kpa-society=true" >> $GITHUB_OUTPUT
              echo "glycopharm=true" >> $GITHUB_OUTPUT
              echo "glucoseview=true" >> $GITHUB_OUTPUT
            else
              echo "neture=$( [ "$SERVICE" = 'neture' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
              echo "k-cosmetics=$( [ "$SERVICE" = 'k-cosmetics' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
              echo "kpa-society=$( [ "$SERVICE" = 'kpa-society' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
              echo "glycopharm=$( [ "$SERVICE" = 'glycopharm' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
              echo "glucoseview=$( [ "$SERVICE" = 'glucoseview' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # For push events, detect actual changes
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check each service
          if echo "$CHANGED_FILES" | grep -q "^services/web-neture/"; then
            echo "neture=true" >> $GITHUB_OUTPUT
          else
            echo "neture=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^services/web-k-cosmetics/"; then
            echo "k-cosmetics=true" >> $GITHUB_OUTPUT
          else
            echo "k-cosmetics=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^services/web-kpa-society/"; then
            echo "kpa-society=true" >> $GITHUB_OUTPUT
          else
            echo "kpa-society=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^services/web-glycopharm/"; then
            echo "glycopharm=true" >> $GITHUB_OUTPUT
          else
            echo "glycopharm=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^services/web-glucoseview/"; then
            echo "glucoseview=true" >> $GITHUB_OUTPUT
          else
            echo "glucoseview=false" >> $GITHUB_OUTPUT
          fi

  deploy-neture:
    needs: detect-changes
    if: needs.detect-changes.outputs.neture == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push Docker image
        run: |
          echo "Building neture-web Docker image..."
          IMAGE_TAG="${{ github.sha }}"

          # Build from repo root with Dockerfile path (for workspace packages)
          docker build \
            --platform linux/amd64 \
            --build-arg VITE_API_BASE_URL=${{ env.VITE_API_BASE_URL }} \
            -f services/web-neture/Dockerfile \
            -t gcr.io/${{ env.PROJECT_ID }}/neture-web:${IMAGE_TAG} \
            -t gcr.io/${{ env.PROJECT_ID }}/neture-web:latest \
            .

          docker push gcr.io/${{ env.PROJECT_ID }}/neture-web:${IMAGE_TAG}
          docker push gcr.io/${{ env.PROJECT_ID }}/neture-web:latest

      - name: Deploy to Cloud Run
        run: |
          echo "Deploying neture-web to Cloud Run..."

          gcloud run deploy neture-web \
            --image=gcr.io/${{ env.PROJECT_ID }}/neture-web:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5

          echo "neture-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe neture-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "Service URL: ${SERVICE_URL}"

          if curl -sf "${SERVICE_URL}" > /dev/null; then
            echo "neture-web is accessible!"
          else
            echo "neture-web may need a moment to start"
          fi

  deploy-k-cosmetics:
    needs: detect-changes
    if: needs.detect-changes.outputs.k-cosmetics == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push Docker image
        run: |
          echo "Building k-cosmetics-web Docker image..."
          IMAGE_TAG="${{ github.sha }}"

          # Build from repo root with Dockerfile path (for workspace packages)
          docker build \
            --platform linux/amd64 \
            --build-arg VITE_API_BASE_URL=${{ env.VITE_API_URL_K_COSMETICS }} \
            -f services/web-k-cosmetics/Dockerfile \
            -t gcr.io/${{ env.PROJECT_ID }}/k-cosmetics-web:${IMAGE_TAG} \
            -t gcr.io/${{ env.PROJECT_ID }}/k-cosmetics-web:latest \
            .

          docker push gcr.io/${{ env.PROJECT_ID }}/k-cosmetics-web:${IMAGE_TAG}
          docker push gcr.io/${{ env.PROJECT_ID }}/k-cosmetics-web:latest

      - name: Deploy to Cloud Run
        run: |
          echo "Deploying k-cosmetics-web to Cloud Run..."

          gcloud run deploy k-cosmetics-web \
            --image=gcr.io/${{ env.PROJECT_ID }}/k-cosmetics-web:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5

          echo "k-cosmetics-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe k-cosmetics-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "Service URL: ${SERVICE_URL}"

  deploy-kpa-society:
    needs: detect-changes
    if: needs.detect-changes.outputs.kpa-society == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push Docker image
        run: |
          echo "Building kpa-society-web Docker image..."
          IMAGE_TAG="${{ github.sha }}"

          # Build from repo root with Dockerfile path (for workspace packages)
          docker build \
            --platform linux/amd64 \
            --build-arg VITE_API_BASE_URL=${{ env.VITE_API_URL_KPA_SOCIETY }} \
            -f services/web-kpa-society/Dockerfile \
            -t gcr.io/${{ env.PROJECT_ID }}/kpa-society-web:${IMAGE_TAG} \
            -t gcr.io/${{ env.PROJECT_ID }}/kpa-society-web:latest \
            .

          docker push gcr.io/${{ env.PROJECT_ID }}/kpa-society-web:${IMAGE_TAG}
          docker push gcr.io/${{ env.PROJECT_ID }}/kpa-society-web:latest

      - name: Deploy to Cloud Run
        run: |
          echo "Deploying kpa-society-web to Cloud Run..."

          gcloud run deploy kpa-society-web \
            --image=gcr.io/${{ env.PROJECT_ID }}/kpa-society-web:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5

          echo "kpa-society-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe kpa-society-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "Service URL: ${SERVICE_URL}"

  deploy-glycopharm:
    needs: detect-changes
    if: needs.detect-changes.outputs.glycopharm == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push Docker image
        run: |
          echo "Building glycopharm-web Docker image..."
          IMAGE_TAG="${{ github.sha }}"

          # Build from repo root with Dockerfile path (for workspace packages)
          docker build \
            --platform linux/amd64 \
            --build-arg VITE_API_BASE_URL=${{ env.VITE_API_URL_GLYCOPHARM }} \
            -f services/web-glycopharm/Dockerfile \
            -t gcr.io/${{ env.PROJECT_ID }}/glycopharm-web:${IMAGE_TAG} \
            -t gcr.io/${{ env.PROJECT_ID }}/glycopharm-web:latest \
            .

          docker push gcr.io/${{ env.PROJECT_ID }}/glycopharm-web:${IMAGE_TAG}
          docker push gcr.io/${{ env.PROJECT_ID }}/glycopharm-web:latest

      - name: Deploy to Cloud Run
        run: |
          echo "Deploying glycopharm-web to Cloud Run..."

          gcloud run deploy glycopharm-web \
            --image=gcr.io/${{ env.PROJECT_ID }}/glycopharm-web:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5

          echo "glycopharm-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe glycopharm-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "Service URL: ${SERVICE_URL}"

  deploy-glucoseview:
    needs: detect-changes
    if: needs.detect-changes.outputs.glucoseview == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io --quiet

      - name: Build and push Docker image
        run: |
          echo "Building glucoseview-web Docker image..."
          IMAGE_TAG="${{ github.sha }}"

          # Use service-specific API URL for same-origin cookie auth
          docker build \
            --platform linux/amd64 \
            --build-arg VITE_API_BASE_URL=${{ env.VITE_API_URL_GLUCOSEVIEW }} \
            -f services/web-glucoseview/Dockerfile \
            -t gcr.io/${{ env.PROJECT_ID }}/glucoseview-web:${IMAGE_TAG} \
            -t gcr.io/${{ env.PROJECT_ID }}/glucoseview-web:latest \
            .

          docker push gcr.io/${{ env.PROJECT_ID }}/glucoseview-web:${IMAGE_TAG}
          docker push gcr.io/${{ env.PROJECT_ID }}/glucoseview-web:latest

      - name: Deploy to Cloud Run
        run: |
          echo "Deploying glucoseview-web to Cloud Run..."

          gcloud run deploy glucoseview-web \
            --image=gcr.io/${{ env.PROJECT_ID }}/glucoseview-web:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5

          echo "glucoseview-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe glucoseview-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "Service URL: ${SERVICE_URL}"

          if curl -sf "${SERVICE_URL}" > /dev/null; then
            echo "glucoseview-web is accessible!"
          else
            echo "glucoseview-web may need a moment to start"
          fi

  summary:
    needs: [detect-changes, deploy-neture, deploy-k-cosmetics, deploy-kpa-society, deploy-glycopharm, deploy-glucoseview]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "Web Services Deployment Summary"
          echo "=========================================="
          echo ""
          echo "Services deployed:"
          echo "  - neture-web: ${{ needs.detect-changes.outputs.neture }}"
          echo "  - k-cosmetics-web: ${{ needs.detect-changes.outputs.k-cosmetics }}"
          echo "  - kpa-society-web: ${{ needs.detect-changes.outputs.kpa-society }}"
          echo "  - glycopharm-web: ${{ needs.detect-changes.outputs.glycopharm }}"
          echo "  - glucoseview-web: ${{ needs.detect-changes.outputs.glucoseview }}"
          echo ""
          echo "Time: $(date)"
          echo "Commit: ${{ github.sha }}"
          echo "Deployment: Docker (Container)"
          echo "=========================================="
