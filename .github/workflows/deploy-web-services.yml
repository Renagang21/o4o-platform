name: Deploy Web Services (Cloud Run)

# Deploy web services to Cloud Run on push to main/develop
# Phase 1: 4Í∞ú ÏõπÏÑúÎ≤Ñ ÏûêÎèô Î∞∞Ìè¨
# Î≥ÄÍ≤ΩÎêú ÏõπÏÑúÎ≤ÑÎßå Î∞∞Ìè¨Îê®

concurrency:
  group: deploy-web-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'services/web-neture/**'
      - 'services/web-k-cosmetics/**'
      - 'services/web-kpa-society/**'
      - 'services/web-glycopharm/**'
      - '.github/workflows/deploy-web-services.yml'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all, neture, k-cosmetics, kpa-society, glycopharm)'
        required: false
        default: 'all'

env:
  PROJECT_ID: netureyoutube
  REGION: asia-northeast3
  VITE_API_BASE_URL: https://o4o-core-api-117791934476.asia-northeast3.run.app

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      neture: ${{ steps.changes.outputs.neture }}
      k-cosmetics: ${{ steps.changes.outputs.k-cosmetics }}
      kpa-society: ${{ steps.changes.outputs.kpa-society }}
      glycopharm: ${{ steps.changes.outputs.glycopharm }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed services
        id: changes
        run: |
          # For workflow_dispatch with specific service
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICE="${{ github.event.inputs.service }}"
            if [ "$SERVICE" = "all" ]; then
              echo "neture=true" >> $GITHUB_OUTPUT
              echo "k-cosmetics=true" >> $GITHUB_OUTPUT
              echo "kpa-society=true" >> $GITHUB_OUTPUT
              echo "glycopharm=true" >> $GITHUB_OUTPUT
            else
              echo "neture=$( [ '$SERVICE' = 'neture' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
              echo "k-cosmetics=$( [ '$SERVICE' = 'k-cosmetics' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
              echo "kpa-society=$( [ '$SERVICE' = 'kpa-society' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
              echo "glycopharm=$( [ '$SERVICE' = 'glycopharm' ] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # For push events, detect actual changes
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check each service
          if echo "$CHANGED_FILES" | grep -q "^services/web-neture/"; then
            echo "neture=true" >> $GITHUB_OUTPUT
          else
            echo "neture=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^services/web-k-cosmetics/"; then
            echo "k-cosmetics=true" >> $GITHUB_OUTPUT
          else
            echo "k-cosmetics=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^services/web-kpa-society/"; then
            echo "kpa-society=true" >> $GITHUB_OUTPUT
          else
            echo "kpa-society=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^services/web-glycopharm/"; then
            echo "glycopharm=true" >> $GITHUB_OUTPUT
          else
            echo "glycopharm=false" >> $GITHUB_OUTPUT
          fi

  deploy-neture:
    needs: detect-changes
    if: needs.detect-changes.outputs.neture == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy neture-web
        run: |
          echo "üöÄ Deploying neture-web..."

          cd services/web-neture

          gcloud run deploy neture-web \
            --source . \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --set-env-vars="VITE_API_BASE_URL=${{ env.VITE_API_BASE_URL }}"

          echo "‚úÖ neture-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe neture-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "üåê Service URL: ${SERVICE_URL}"

          # Simple health check
          if curl -sf "${SERVICE_URL}" > /dev/null; then
            echo "‚úÖ neture-web is accessible!"
          else
            echo "‚ö†Ô∏è neture-web may need a moment to start"
          fi

  deploy-k-cosmetics:
    needs: detect-changes
    if: needs.detect-changes.outputs.k-cosmetics == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy k-cosmetics-web
        run: |
          echo "üöÄ Deploying k-cosmetics-web..."

          cd services/web-k-cosmetics

          gcloud run deploy k-cosmetics-web \
            --source . \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --set-env-vars="VITE_API_BASE_URL=${{ env.VITE_API_BASE_URL }}"

          echo "‚úÖ k-cosmetics-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe k-cosmetics-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "üåê Service URL: ${SERVICE_URL}"

  deploy-kpa-society:
    needs: detect-changes
    if: needs.detect-changes.outputs.kpa-society == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy kpa-society-web
        run: |
          echo "üöÄ Deploying kpa-society-web..."

          cd services/web-kpa-society

          gcloud run deploy kpa-society-web \
            --source . \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --set-env-vars="VITE_API_BASE_URL=${{ env.VITE_API_BASE_URL }}"

          echo "‚úÖ kpa-society-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe kpa-society-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "üåê Service URL: ${SERVICE_URL}"

  deploy-glycopharm:
    needs: detect-changes
    if: needs.detect-changes.outputs.glycopharm == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy glycopharm-web
        run: |
          echo "üöÄ Deploying glycopharm-web..."

          cd services/web-glycopharm

          gcloud run deploy glycopharm-web \
            --source . \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --set-env-vars="VITE_API_BASE_URL=${{ env.VITE_API_BASE_URL }}"

          echo "‚úÖ glycopharm-web deployed successfully!"

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe glycopharm-web \
            --region=${{ env.REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.url)")

          echo "üåê Service URL: ${SERVICE_URL}"

  summary:
    needs: [detect-changes, deploy-neture, deploy-k-cosmetics, deploy-kpa-society, deploy-glycopharm]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Summary
        run: |
          echo "=========================================="
          echo "üìã Web Services Deployment Summary"
          echo "=========================================="
          echo ""
          echo "Services deployed:"
          echo "  - neture-web: ${{ needs.detect-changes.outputs.neture }}"
          echo "  - k-cosmetics-web: ${{ needs.detect-changes.outputs.k-cosmetics }}"
          echo "  - kpa-society-web: ${{ needs.detect-changes.outputs.kpa-society }}"
          echo "  - glycopharm-web: ${{ needs.detect-changes.outputs.glycopharm }}"
          echo ""
          echo "üìÖ Time: $(date)"
          echo "üìù Commit: ${{ github.sha }}"
          echo "=========================================="
