name: Deploy Main Site (Production)

# ë©”ì¸ ì‚¬ì´íŠ¸ ì ì§„ì  ë°°í¬ ì›Œí¬í”Œë¡œìš°
# íŠ¸ë¦¬ê±°: apps/main-site ê²½ë¡œ ë³€ê²½ ì‹œ
# ë‹¨ê³„: Build â†’ Optimize â†’ Deploy â†’ Health Check

on:
  push:
    branches: [main]
    paths:
      - 'apps/main-site/**'
      - 'packages/**'
      - '.github/workflows/deploy-main-site.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy without path changes'
        required: false
        default: 'false'

concurrency:
  group: deploy-main-site-${{ github.ref }}
  cancel-in-progress: false

env:
  SERVICE_NAME: main-site
  SERVICE_PORT: 3000
  PM2_APP_NAME: o4o-main-site
  DEPLOY_PATH: /home/ubuntu/o4o-platform
  NODE_VERSION: '20.18.0'

jobs:
  # í’ˆì§ˆ ê²€ì¦ ë‹¨ê³„
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install
        bash scripts/setup-ci-env.sh
    
    - name: Build shared packages
      run: |
        echo "Building shared packages first..."
        bash scripts/build-packages.sh
    
    - name: Type check
      run: npm run type-check
    
    - name: Lint check
      run: npm run lint
    
    - name: Security audit
      run: npm audit --audit-level=high
      continue-on-error: true

  # ë‹¨ê³„ 1: ë¹Œë“œ ë° ìµœì í™”
  build-and-optimize:
    needs: quality-check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm install
        bash scripts/setup-ci-env.sh
        cd apps/main-site
        npm install
    
    - name: Build shared packages
      run: |
        echo "Building shared packages first..."
        bash scripts/build-packages.sh
        
    - name: TypeScript type check
      run: |
        cd apps/main-site
        npm run type-check
        
    - name: ESLint check
      run: |
        cd apps/main-site
        npm run lint
        
    - name: Build packages
      run: |
        bash scripts/build-packages.sh
        
    - name: Create production environment file
      run: |
        cd apps/main-site
        cat > .env.production << 'EOF'
        NODE_ENV=production
        VITE_API_BASE_URL=https://api.neture.co.kr
        VITE_APP_TITLE=O4O Platform
        VITE_ADMIN_URL=https://admin.neture.co.kr
        VITE_SITE_URL=https://neture.co.kr
        VITE_ENABLE_ANALYTICS=true
        VITE_ENABLE_ERROR_REPORTING=true
        VITE_BUILD_TIMESTAMP=${{ github.run_number }}
        EOF
        
    - name: Build application for production
      run: |
        cd apps/main-site
        npm run build
        
    - name: Analyze bundle size
      run: |
        cd apps/main-site
        npm run build:analyze || true
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: main-site-build
        path: |
          apps/main-site/dist/
          apps/main-site/package.json
          apps/main-site/package-lock.json
          apps/main-site/.env.production
        retention-days: 1
        
    - name: Upload build analysis
      uses: actions/upload-artifact@v4
      with:
        name: build-analysis
        path: |
          apps/main-site/dist/stats.html
          apps/main-site/dist/bundle-analyzer-report.html
        retention-days: 7
        if-no-files-found: ignore

  # ë‹¨ê³„ 2: ì„±ëŠ¥ ë° ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  performance-and-security-check:
    needs: build-and-optimize
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: main-site-build
        path: apps/main-site/
        
    - name: Setup Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x
      
    - name: Run Lighthouse CI
      run: |
        cd apps/main-site
        lhci autorun --config=../../.lighthouserc.json || true
        
    - name: Security audit
      run: |
        cd apps/main-site
        npm audit --audit-level=high || true

  # ë‹¨ê³„ 3: ìš´ì˜ ì„œë²„ ë°°í¬
  deploy:
    needs: [build-and-optimize, performance-and-security-check]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: main-site-build
        path: apps/main-site/
        
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.WEB_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo "SSH key setup completed"
        
    - name: Add SSH known hosts
      run: |
        ssh-keyscan -H ${{ secrets.WEB_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H neture.co.kr >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H admin.neture.co.kr >> ~/.ssh/known_hosts 2>/dev/null || true
        # Also add IP if available
        if [ -n "${{ secrets.WEB_HOST_IP }}" ]; then
          ssh-keyscan -H ${{ secrets.WEB_HOST_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
        fi
        chmod 644 ~/.ssh/known_hosts
        
    - name: Create backup of current deployment
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          if [ -d 'apps/main-site' ]; then
            echo 'Creating backup of current main-site...'
            rm -rf apps/main-site.backup
            cp -r apps/main-site apps/main-site.backup
          fi
        "
        
    - name: Create deployment directory
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          mkdir -p ${{ env.DEPLOY_PATH }}/apps/main-site
        "
        
    - name: Deploy static files to Nginx
      run: |
        # ì •ì  íŒŒì¼ì„ ë³„ë„ ë””ë ‰í† ë¦¬ì— ë°°í¬ (CDN ì—­í• )
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          sudo mkdir -p /var/www/neture.co.kr
          sudo chown -R ${{ secrets.WEB_USER }}:${{ secrets.WEB_USER }} /var/www/neture.co.kr
        "
        
        rsync -avz --delete --no-owner --no-group --no-perms \
          -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
          apps/main-site/dist/ \
          ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }}:/var/www/neture.co.kr/
          
        
    - name: Configure and verify Nginx
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} << 'ENDSSH'
          echo "ğŸ” Verifying Nginx configuration..."
          
          # Nginx ì„¤ì • íŒŒì¼ í™•ì¸
          if [ -f /etc/nginx/sites-available/neture.co.kr ]; then
            echo "âœ… Nginx site configuration exists"
          else
            echo "âŒ ERROR: Nginx configuration not found at /etc/nginx/sites-available/neture.co.kr"
            echo "Please create the Nginx configuration manually"
            exit 1
          fi
          
          # ì‚¬ì´íŠ¸ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          if [ -L /etc/nginx/sites-enabled/neture.co.kr ]; then
            echo "âœ… Site is enabled"
          else
            echo "âš ï¸  Site is not enabled, enabling now..."
            sudo ln -s /etc/nginx/sites-available/neture.co.kr /etc/nginx/sites-enabled/
          fi
          
          # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
          echo "ğŸ”§ Testing Nginx configuration..."
          sudo nginx -t
          
          # Nginx ë¦¬ë¡œë“œ
          echo "ğŸ”„ Reloading Nginx..."
          sudo systemctl reload nginx
          
          echo "âœ… Nginx setup completed"
        ENDSSH
        
    - name: Verify static files deployment
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          # ì •ì  íŒŒì¼ í™•ì¸
          if [ -d '/var/www/neture.co.kr' ]; then
            echo 'âœ… Static files directory exists'
            echo 'ğŸ“ Files in /var/www/neture.co.kr:'
            ls -la /var/www/neture.co.kr/ | head -10
            
            if [ -f '/var/www/neture.co.kr/index.html' ]; then
              echo 'âœ… index.html exists'
            else
              echo 'âŒ ERROR: index.html not found!'
              exit 1
            fi
          else
            echo 'âŒ ERROR: /var/www/neture.co.kr directory does not exist!'
            exit 1
          fi
        "
        
    - name: Verify deployment
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          echo 'ğŸ” Verifying deployment...'
          echo ''
          echo 'ğŸ“ Static files in /var/www/neture.co.kr:'
          ls -la /var/www/neture.co.kr/ | head -20
          echo ''
          echo 'ğŸ” Checking index.html:'
          if [ -f /var/www/neture.co.kr/index.html ]; then
            echo 'âœ… index.html exists'
            head -n 10 /var/www/neture.co.kr/index.html
          else
            echo 'âŒ ERROR: index.html not found!'
            exit 1
          fi
          echo ''
          echo 'ğŸŒ Testing local access:'
          curl -I http://localhost/ -H 'Host: neture.co.kr' || echo 'Local test failed'
          echo ''
          echo 'âœ… Deployment completed successfully'
        "

  # ë‹¨ê³„ 4: ë°°í¬ í›„ í—¬ìŠ¤ì²´í¬ ë° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  health-check:
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH key for health check
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.WEB_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.WEB_HOST }} >> ~/.ssh/known_hosts
        
    - name: Check Nginx configuration
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          echo 'ğŸ” Checking Nginx configuration...'
          echo ''
          echo 'ğŸ“„ Nginx site configuration for neture.co.kr:'
          sudo cat /etc/nginx/sites-available/neture.co.kr || echo 'Configuration not found'
          echo ''
          echo 'ğŸ” Testing Nginx configuration:'
          sudo nginx -t
          echo ''
          echo 'ğŸ” Reloading Nginx to ensure latest configuration:'
          sudo systemctl reload nginx
          echo ''
          echo 'ğŸ“ Checking static files:'
          ls -la /var/www/neture.co.kr/ | head -10
          echo ''
          echo 'ğŸ” Testing direct file access:'
          curl -I https://neture.co.kr:8443/index.html || echo 'Direct file access failed'
        "
    
    - name: Wait for service startup
      run: sleep 10
      
    - name: Basic health check
      run: |
        echo "ğŸ” Starting health check for neture.co.kr..."
        
        # ë¨¼ì € HTTPë¡œ í…ŒìŠ¤íŠ¸
        echo "Testing HTTP access..."
        curl -I http://neture.co.kr/ || echo "HTTP test failed"
        
        # HTTPSë¡œ í…ŒìŠ¤íŠ¸
        echo ""
        echo "Testing HTTPS access..."
        curl -I https://neture.co.kr:8443/ || echo "HTTPS test failed"
        
        # ì •ì  íŒŒì¼ ì§ì ‘ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
        echo ""
        echo "Testing direct static file access..."
        curl -I https://neture.co.kr:8443/index.html || echo "Direct file test failed"
        
        # ì‹¤ì œ í—¬ìŠ¤ì²´í¬
        echo ""
        echo "Running health check loop..."
        for i in {1..10}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            https://neture.co.kr:8443/ || echo "000")
            
          if [ "$response" = "200" ]; then
            echo "âœ… ë©”ì¸ ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‘ë‹µ ì½”ë“œ: $response)"
            break
          else
            echo "â³ ë©”ì¸ ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„ $i/10, ì‘ë‹µ ì½”ë“œ: $response)"
            
            # 502 ì—ëŸ¬ì¸ ê²½ìš° ì¶”ê°€ ì§„ë‹¨
            if [ "$response" = "502" ]; then
              echo "ğŸ” 502 Bad Gateway detected - Nginx is trying to proxy to a backend"
              echo "âš ï¸  This suggests Nginx is not configured for static file serving"
              echo "ğŸ“ Please check Nginx configuration at /etc/nginx/sites-available/neture.co.kr"
            fi
            
            if [ $i -eq 10 ]; then
              echo "âŒ ë©”ì¸ ì‚¬ì´íŠ¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              echo ""
              echo "ğŸ“‹ Troubleshooting steps:"
              echo "1. Check if files exist in /var/www/neture.co.kr/"
              echo "2. Verify Nginx configuration is for static files, not proxy"
              echo "3. Ensure no PM2/Node.js process is expected"
              echo "4. Check Nginx error logs: sudo tail -f /var/log/nginx/error.log"
              exit 1
            fi
            sleep 10
          fi
        done
        
    - name: Static assets check
      run: |
        # ì£¼ìš” ì •ì  ìì› í™•ì¸
        assets=(
          "/assets/index.css"
          "/assets/index.js"
          "/favicon.ico"
        )
        
        for asset in "${assets[@]}"; do
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://neture.co.kr:8443$asset")
            
          if [ "$response" = "200" ]; then
            echo "âœ… ì •ì  ìì› í™•ì¸ ì„±ê³µ: $asset"
          else
            echo "âš ï¸  ì •ì  ìì› í™•ì¸ ì‹¤íŒ¨: $asset (ì‘ë‹µ ì½”ë“œ: $response)"
            # ì‹¤íŒ¨ ì‹œ ì¢…ë£Œí•˜ì§€ ì•Šê³  ê²½ê³ ë§Œ í‘œì‹œ
          fi
        done
        
    - name: Page load speed test
      run: |
        # í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •
        load_time=$(curl -s -o /dev/null -w "%{time_total}" https://neture.co.kr:8443/)
        
        echo "ğŸ“Š í˜ì´ì§€ ë¡œë“œ ì‹œê°„: ${load_time}ì´ˆ"
        
        # 3ì´ˆ ì´ìƒì´ë©´ ê²½ê³ 
        if (( $(echo "$load_time > 3.0" | bc -l) )); then
          echo "âš ï¸  í˜ì´ì§€ ë¡œë“œ ì‹œê°„ì´ ëŠë¦½ë‹ˆë‹¤ (${load_time}ì´ˆ)"
        else
          echo "âœ… í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì–‘í˜¸ (${load_time}ì´ˆ)"
        fi
        
    - name: API connectivity test
      run: |
        # ë©”ì¸ ì‚¬ì´íŠ¸ì—ì„œ API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        response=$(curl -s "https://api.neture.co.kr:8443/api/health" || echo "failed")
        
        if echo "$response" | grep -q "healthy"; then
          echo "âœ… API ì„œë²„ ì—°ê²° í™•ì¸ ì„±ê³µ"
        else
          echo "âš ï¸  API ì„œë²„ ì—°ê²° í™•ì¸ í•„ìš”"
        fi

  # ë‹¨ê³„ 5: SEO ë° ì ‘ê·¼ì„± ê²€ì‚¬
  seo-accessibility-check:
    needs: health-check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Lighthouse CI
      run: npm install -g @lhci/cli@0.12.x
      
    - name: Run production Lighthouse audit
      run: |
        lhci autorun \
          --config=.lighthouserc.json \
          --collect.url=https://neture.co.kr:8443 \
          --collect.url=https://neture.co.kr:8443/about \
          --collect.url=https://neture.co.kr:8443/products || true
          
    - name: Meta tags verification
      run: |
        # ì£¼ìš” ë©”íƒ€ íƒœê·¸ í™•ì¸
        content=$(curl -s https://neture.co.kr:8443/)
        
        if echo "$content" | grep -q "<title>"; then
          echo "âœ… Title íƒœê·¸ í™•ì¸"
        else
          echo "âŒ Title íƒœê·¸ ëˆ„ë½"
        fi
        
        if echo "$content" | grep -q "description"; then
          echo "âœ… Description ë©”íƒ€ íƒœê·¸ í™•ì¸"
        else
          echo "âŒ Description ë©”íƒ€ íƒœê·¸ ëˆ„ë½"
        fi
        
        if echo "$content" | grep -q "og:"; then
          echo "âœ… Open Graph íƒœê·¸ í™•ì¸"
        else
          echo "âŒ Open Graph íƒœê·¸ ëˆ„ë½"
        fi

  # ë‹¨ê³„ 6: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify:
    needs: [deploy, health-check, seo-accessibility-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment success notification
      if: needs.health-check.result == 'success'
      run: |
        echo "ğŸš€ ë©”ì¸ ì‚¬ì´íŠ¸ ë°°í¬ ì„±ê³µ!"
        echo "ğŸ“ ì„œë¹„ìŠ¤ URL: https://neture.co.kr"
        echo "ğŸ• ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“Š í—¬ìŠ¤ì²´í¬: í†µê³¼"
        echo "ğŸ” SEO ê²€ì‚¬: ì™„ë£Œ"
        
    - name: Deployment failure notification
      if: needs.health-check.result == 'failure' || needs.deploy.result == 'failure'
      run: |
        echo "âŒ ë©”ì¸ ì‚¬ì´íŠ¸ ë°°í¬ ì‹¤íŒ¨!"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
        exit 1

  # ë‹¨ê³„ 7: ë¡¤ë°± ì¤€ë¹„ (ì‹¤íŒ¨ ì‹œ)
  rollback:
    needs: [deploy, health-check]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.WEB_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo "SSH key setup completed"
        
    - name: Add SSH known hosts
      run: |
        ssh-keyscan -H ${{ secrets.WEB_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H neture.co.kr >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H admin.neture.co.kr >> ~/.ssh/known_hosts 2>/dev/null || true
        # Also add IP if available
        if [ -n "${{ secrets.WEB_HOST_IP }}" ]; then
          ssh-keyscan -H ${{ secrets.WEB_HOST_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
        fi
        chmod 644 ~/.ssh/known_hosts
        
    - name: Rollback to previous version
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          
          # ì´ì „ ë°±ì—…ì—ì„œ ë³µì›
          if [ -d 'apps/main-site.backup' ]; then
            echo 'ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°± ì¤‘...'
            rm -rf apps/main-site
            mv apps/main-site.backup apps/main-site
            
            # ì •ì  íŒŒì¼ë„ ë³µì›
            rsync -av apps/main-site/dist/ /var/www/neture.co.kr/
            
            # PM2 ì¬ì‹œì‘
            pm2 restart ${{ env.PM2_APP_NAME }}
            echo 'ë¡¤ë°± ì™„ë£Œ'
          else
            echo 'ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ë³µêµ¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
          fi
        "
        
    - name: Rollback notification
      run: |
        echo "ğŸ”„ ë©”ì¸ ì‚¬ì´íŠ¸ ë¡¤ë°± ì™„ë£Œ"
        echo "âš ï¸  ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."