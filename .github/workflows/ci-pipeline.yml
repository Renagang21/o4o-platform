name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.18.0'

jobs:
  # 1. Code Quality Checks
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Run TypeScript check (Frontend only)
      run: pnpm run type-check:frontend

    - name: Run TypeScript check (App Store packages)
      run: pnpm run typecheck:app-store-packages || echo "‚ö†Ô∏è App Store packages have type errors (non-blocking)"

    - name: Run ESLint
      run: pnpm run lint
    
    - name: Check for console.log statements
      run: |
        # Find all console.log statements, excluding comments, test files, CLI scripts, config files, migrations, and logger utilities
        # Also exclude main.tsx/main.ts files (entry points with startup logs)
        CONSOLE_LOGS=$(grep -r "console\.log" apps/ --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=dist \
          --exclude-dir=test --exclude-dir=e2e \
          --exclude-dir=scripts \
          --exclude-dir=cli \
          --exclude-dir=vscode-extension \
          --exclude="*test*" --exclude="*spec*" \
          --exclude="vite.config.ts" --exclude="*.config.ts" \
          --exclude="logger.ts" --exclude="*logger*.ts" \
          --exclude="cli.ts" \
          --exclude="main.tsx" \
          --exclude="main.ts" \
          --exclude="migrate.ts" \
          | grep -v "//.*console\.log" \
          | grep -v "^\s*//" \
          | grep -v "\*.*console\.log" \
          | grep -v "database/migrations/" || true)

        if [ -n "$CONSOLE_LOGS" ]; then
          echo "‚ùå Found console.log statements in production code:"
          echo "$CONSOLE_LOGS"
          exit 1
        else
          echo "‚úÖ No console.log statements found in production code"
        fi
    
    - name: Run tests (api-server Jest, serial to prevent OOM)
      run: cd apps/api-server && npx jest --maxWorkers=1

    - name: Run tests (admin-dashboard Vitest, serial to prevent OOM)
      run: cd apps/admin-dashboard && npx vitest run --passWithNoTests --pool=forks --poolOptions.forks.maxForks=1

    - name: Run tests (api-gateway Vitest)
      run: cd apps/api-gateway && npx vitest run --passWithNoTests

    - name: Run tests (multi-tenant Vitest)
      run: cd apps/api-server/tests/multi-tenant && npx vitest run --passWithNoTests

  # 2. Build all applications
  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: quality-check
    
    strategy:
      matrix:
        app: [main-site, admin-dashboard]
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Verify package builds
      run: |
        echo "üîç Verifying all build:packages dist directories..."
        MISSING_DIST=0

        # All packages built by build:packages (must stay in sync)
        for pkg in types appearance-system auth-client utils ui auth-context shortcodes block-renderer content-editor slide-app organization-core forum-core pharmacy-ai-insight yaksa-scheduler; do
          if [ ! -d "packages/$pkg/dist" ]; then
            echo "‚ùå packages/$pkg/dist not found!"
            MISSING_DIST=1
          else
            echo "‚úÖ packages/$pkg/dist exists"
          fi
        done

        if [ $MISSING_DIST -eq 1 ]; then
          echo "‚ùå Some dist directories are missing. Cannot proceed."
          exit 1
        fi

        echo "‚úÖ All build:packages outputs verified ($(echo types appearance-system auth-client utils ui auth-context shortcodes block-renderer content-editor slide-app organization-core forum-core pharmacy-ai-insight yaksa-scheduler | wc -w) packages)"

    - name: Build ${{ matrix.app }}
      run: bash scripts/ci-build-app.sh ${{ matrix.app }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.app }}-dist
        path: |
          apps/${{ matrix.app }}/dist
          apps/${{ matrix.app }}/build
        retention-days: 7

