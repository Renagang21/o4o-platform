name: Deploy API Server (Cloud Run)

# Deploy API server to Cloud Run on push to main branch
# Phase R5: Cloud Run ë‹¨ì¼ ë°°í¬ ì²´ê³„

concurrency:
  group: deploy-api-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api-server/**'
      - 'packages/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: 'false'

env:
  PROJECT_ID: netureyoutube
  REGION: asia-northeast3
  SERVICE_NAME: o4o-core-api
  REPOSITORY_NAME: o4o-api
  IMAGE_NAME: api-server

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'

    - name: Install pnpm
      run: npm install -g pnpm

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build packages
      run: pnpm run build:packages

    - name: Build API server
      run: |
        cd apps/api-server
        pnpm run build

        # Verify build output
        if [ ! -f "dist/main.js" ]; then
          echo "âŒ Build failed: dist/main.js not found"
          exit 1
        fi

        echo "âœ… API server build complete"
        echo "ğŸ“¦ Bundle size: $(du -h dist/main.js | cut -f1)"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
        service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build and Push Docker image
      run: |
        cd apps/api-server

        IMAGE_TAG="${{ github.sha }}"
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        LATEST_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:latest"

        echo "ğŸ³ Building Docker image..."
        docker build \
          --platform linux/amd64 \
          --tag "${FULL_IMAGE}" \
          --tag "${LATEST_IMAGE}" \
          --file Dockerfile \
          .

        echo "ğŸ“¤ Pushing to Artifact Registry..."
        docker push "${FULL_IMAGE}"
        docker push "${LATEST_IMAGE}"

        echo "âœ… Image pushed: ${FULL_IMAGE}"
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

    - name: Deploy to Cloud Run
      run: |
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

        echo "ğŸš€ Deploying to Cloud Run..."
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image="${FULL_IMAGE}" \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10 \
          --concurrency=80 \
          --timeout=300 \
          --set-env-vars="NODE_ENV=production" \
          --set-env-vars="PORT=8080" \
          --set-env-vars="GRACEFUL_STARTUP=true" \
          --set-env-vars="EMAIL_SERVICE_ENABLED=false"

    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."

        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --format="value(status.url)")

        echo "ğŸŒ Service URL: ${SERVICE_URL}"

        # Health check with retry
        for i in {1..5}; do
          echo "Health check attempt $i..."
          if curl -sf "${SERVICE_URL}/health" > /dev/null; then
            echo "âœ… Health check passed!"
            break
          fi
          if [ $i -eq 5 ]; then
            echo "âŒ Health check failed after 5 attempts"
            exit 1
          fi
          sleep 10
        done

        echo ""
        echo "=========================================="
        echo "âœ… API Server Deployed Successfully!"
        echo "=========================================="
        echo "ğŸŒ URL: ${SERVICE_URL}"
        echo "ğŸ¥ Health: ${SERVICE_URL}/health"
        echo "ğŸ“… Time: $(date)"
        echo "ğŸ“ Commit: ${{ github.sha }}"
