name: Deploy API Server (Cloud Run)

# Deploy API server to Cloud Run on push to main branch
# Phase R5: Cloud Run ë‹¨ì¼ ë°°í¬ ì²´ê³„
# Phase G1-2: Operational Mode (GRACEFUL_STARTUP=false, Cloud SQL ì—°ê²° í•„ìˆ˜)
#
# Migration Architecture:
# - Uses TypeORM CLI with lightweight migration-config.js (NO entity imports)
# - Avoids bundling 60+ entities that cause tsup compilation failures
# - migration-config.ts â†’ tsc â†’ migration-config.js â†’ TypeORM CLI
# - See: apps/api-server/src/database/migration-config.ts

concurrency:
  group: deploy-api-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api-server/**'
      - 'packages/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: 'false'

env:
  PROJECT_ID: netureyoutube
  REGION: asia-northeast3
  SERVICE_NAME: o4o-core-api
  REPOSITORY_NAME: o4o-api
  IMAGE_NAME: api-server

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'

    - name: Install pnpm
      run: npm install -g pnpm

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build shared packages (unified with CI)
      run: |
        echo "ğŸ”¨ Phase 1: Building shared packages (same as CI pipeline)..."
        echo "============================================================"
        pnpm run build:packages
        echo "âœ… Shared packages built (unified with CI)"

    - name: Build API-specific packages
      run: |
        echo "ğŸ”¨ Phase 2: Building API-server-specific packages..."
        echo "============================================================"
        echo "(These packages are only needed by api-server, not frontend)"
        echo ""

        # Infrastructure (depends on types/utils â€” already built in Phase 1)
        echo "ğŸ“¦ Infrastructure..."
        pnpm --filter '@o4o/cpt-registry' run build
        pnpm --filter '@o4o/ai-core' run build
        pnpm --filter '@o4o/security-core' run build
        pnpm --filter '@o4o/store-core' run build

        # Domain Core (depends on infrastructure)
        echo "ğŸ“¦ Domain Core..."
        pnpm --filter '@o4o/ecommerce-core' run build
        pnpm --filter '@o4o-apps/cms-core' run build
        pnpm --filter '@o4o/lms-core' run build
        pnpm --filter '@o4o/dropshipping-core' run build

        # Extensions & Features (depends on Domain Core)
        echo "ğŸ“¦ Extensions & Features..."
        pnpm --filter '@o4o-apps/digital-signage-core' run build
        pnpm --filter '@o4o-apps/signage' run build
        pnpm --filter '@o4o-extensions/organization-forum' run build
        pnpm --filter '@o4o/lms-marketing' run build
        pnpm --filter '@o4o/lms-yaksa' run build
        pnpm --filter '@o4o/membership-yaksa' run build
        pnpm --filter '@o4o/reporting-yaksa' run build
        pnpm --filter '@o4o/annualfee-yaksa' run build
        pnpm --filter '@o4o/groupbuy-yaksa' run build
        pnpm --filter '@o4o-apps/forum-yaksa' run build || true
        pnpm --filter '@o4o/market-trial' run build

        # Cosmetics Extensions
        echo "ğŸ“¦ Cosmetics Extensions..."
        pnpm --filter '@o4o/cosmetics-seller-extension' run build
        pnpm --filter '@o4o/cosmetics-supplier-extension' run build
        pnpm --filter '@o4o/cosmetics-sample-display-extension' run build

        echo ""
        echo "âœ… All API-specific packages built successfully!"

    - name: Build API server (bundled with tsup)
      run: |
        cd apps/api-server

        # ============================================================
        # Build Strategy:
        # 1. First build with tsc (compiles migrations with decorators)
        # 2. Backup migrations folder
        # 3. Build with tsup (creates bundled main.js, may clean dist)
        # 4. Restore migrations from backup
        # ============================================================

        # Step 1: Build everything with tsc first (handles decorators properly)
        echo "ğŸ”¨ Step 1: Building with tsc (includes migrations)..."
        pnpm run build

        # Step 2: Backup database folder before tsup cleans dist
        # Backup: migrations/*.js + migration-config.js (all compiled by tsc)
        echo "ğŸ“¦ Step 2: Backing up database folder (migrations + migration-config)..."
        mkdir -p /tmp/database-backup/migrations

        # Backup migration-config.js (required for TypeORM CLI)
        if [ -f "dist/database/migration-config.js" ]; then
          cp dist/database/migration-config.js /tmp/database-backup/
          cp dist/database/migration-config.js.map /tmp/database-backup/ 2>/dev/null || true
          echo "âœ… migration-config.js backed up"
        else
          echo "âš ï¸ WARNING: migration-config.js not found!"
        fi

        # Backup migration files
        if [ -d "dist/database/migrations" ]; then
          cp -r dist/database/migrations/* /tmp/database-backup/migrations/ 2>/dev/null || true
          MIGRATION_COUNT=$(ls /tmp/database-backup/migrations/*.js 2>/dev/null | wc -l)
          echo "âœ… Migrations backed up: ${MIGRATION_COUNT} files"
        else
          echo "âš ï¸ No migrations folder found"
        fi

        # Step 3: Build with tsup (creates bundled main.js)
        echo "ğŸ”¨ Step 3: Building API server with tsup (bundled build)..."
        pnpm run build:api

        # Step 4: Restore database folder (migrations + migration-config)
        echo "ğŸ“¦ Step 4: Restoring database folder..."

        # Create database folder structure
        mkdir -p dist/database/migrations

        # Restore migration-config.js
        if [ -f "/tmp/database-backup/migration-config.js" ]; then
          cp /tmp/database-backup/migration-config.js dist/database/
          cp /tmp/database-backup/migration-config.js.map dist/database/ 2>/dev/null || true
          echo "âœ… migration-config.js restored"
        else
          echo "âŒ ERROR: migration-config.js not in backup!"
          exit 1
        fi

        # Restore migration files
        if [ -d "/tmp/database-backup/migrations" ]; then
          cp -r /tmp/database-backup/migrations/* dist/database/migrations/ 2>/dev/null || true
          RESTORED_COUNT=$(ls dist/database/migrations/*.js 2>/dev/null | wc -l)
          echo "âœ… Migrations restored: ${RESTORED_COUNT} files"
        fi

        # List database folder contents
        echo "ğŸ“‹ dist/database/ contents:"
        ls -la dist/database/
        echo "ğŸ“‹ dist/database/migrations/ (first 10):"
        ls dist/database/migrations/*.js 2>/dev/null | head -10

        # Verify build output
        if [ ! -f "dist/main.js" ]; then
          echo "âŒ Build failed: dist/main.js not found"
          exit 1
        fi

        if [ ! -f "dist/migrate.js" ]; then
          echo "âŒ Build failed: dist/migrate.js not found"
          exit 1
        fi

        echo "âœ… API server build complete"

        # Final verification
        echo "ğŸ“‹ Final verification:"
        echo "  - main.js (Service entry): $(du -h dist/main.js | cut -f1)"
        echo "  - migrate.js (Job entry): $(du -h dist/migrate.js | cut -f1)"
        echo "  - migration-config.js: $(du -h dist/database/migration-config.js | cut -f1)"
        FINAL_MIGRATION_COUNT=$(ls dist/database/migrations/*.js 2>/dev/null | wc -l)
        echo "  - migrations: ${FINAL_MIGRATION_COUNT} files"

        # Verify all required files exist
        if [ ! -f "dist/database/migration-config.js" ]; then
          echo "âŒ ERROR: migration-config.js missing!"
          exit 1
        fi

        if [ "$FINAL_MIGRATION_COUNT" -eq 0 ]; then
          echo "âŒ ERROR: No migration files in final build!"
          exit 1
        fi

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build and Push Docker image
      run: |
        cd apps/api-server

        # Verify tsup bundles exist (main.js for Service, migrate.js for Job)
        echo "ğŸ“‚ Checking bundled output:"
        ls -la dist/main.js dist/main.js.map || (echo "âŒ main.js bundle not found!" && exit 1)
        ls -la dist/migrate.js dist/migrate.js.map || (echo "âŒ migrate.js bundle not found!" && exit 1)
        echo "ğŸ“¦ main.js (Service): $(du -h dist/main.js | cut -f1)"
        echo "ğŸ“¦ migrate.js (Job): $(du -h dist/migrate.js | cut -f1)"

        IMAGE_TAG="${{ github.sha }}"
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        LATEST_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:latest"

        echo "ğŸ³ Building Docker image..."
        docker build \
          --no-cache \
          --build-arg CACHEBUST=$(date +%s) \
          --platform linux/amd64 \
          --tag "${FULL_IMAGE}" \
          --tag "${LATEST_IMAGE}" \
          --file Dockerfile \
          .

        # Verify the image contains the bundle
        echo "ğŸ” Verifying Docker image contents..."
        docker run --rm "${FULL_IMAGE}" ls -la /app/dist/

        echo "ğŸ“¤ Pushing to Artifact Registry..."
        docker push "${FULL_IMAGE}"
        docker push "${LATEST_IMAGE}"

        echo "âœ… Image pushed: ${FULL_IMAGE}"
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

    - name: Deploy to Cloud Run
      run: |
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

        echo "ğŸš€ Deploying to Cloud Run..."

        # ============================================================
        # G1-2 Phase: Operational Mode - DB Connection Required
        # ============================================================
        # GRACEFUL_STARTUP=false means app will fail if DB is unavailable
        # This is the production-ready configuration
        # ============================================================

        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image="${FULL_IMAGE}" \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=1 \
          --max-instances=10 \
          --concurrency=80 \
          --timeout=300 \
          --set-env-vars="NODE_ENV=production" \
          --set-env-vars="GRACEFUL_STARTUP=false" \
          --set-env-vars="EMAIL_SERVICE_ENABLED=false" \
          --set-env-vars="COOKIE_DOMAIN=.neture.co.kr" \
          --set-env-vars="DB_HOST=/cloudsql/netureyoutube:asia-northeast3:o4o-platform-db" \
          --set-env-vars="DB_PORT=5432" \
          --set-env-vars="DB_USERNAME=${{ secrets.GCP_DB_USERNAME }}" \
          --set-env-vars="DB_PASSWORD=${{ secrets.GCP_DB_PASSWORD }}" \
          --set-env-vars="DB_NAME=${{ secrets.GCP_DB_NAME }}" \
          --set-env-vars="JWT_SECRET=${{ secrets.GCP_JWT_SECRET }}" \
          --set-env-vars="JWT_REFRESH_SECRET=${{ secrets.GCP_JWT_SECRET }}" \
          --add-cloudsql-instances=netureyoutube:asia-northeast3:o4o-platform-db

    - name: Run database migrations
      run: |
        echo "ğŸ”„ Running database migrations..."

        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

        # ============================================================
        # Migration Strategy: Use dedicated migrate.js entry point
        # ============================================================
        # - migrate.js is a standalone CLI that runs migrations and exits
        # - NO Express server, NO health endpoints, NO PORT listening
        # - Exit 0 on success, Exit 1 on failure
        # - This ensures Cloud Run Job terminates properly
        # ============================================================

        # Create or update the migration job with node migrate.js command
        # Use ^::^ delimiter syntax to avoid issues with special characters in passwords
        # This is more reliable than multiple --set-env-vars flags
        gcloud run jobs create o4o-api-migrations \
          --image="${FULL_IMAGE}" \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --task-timeout=300 \
          --max-retries=1 \
          --set-env-vars="^::^NODE_ENV=production::DB_HOST=/cloudsql/netureyoutube:asia-northeast3:o4o-platform-db::DB_PORT=5432::DB_USERNAME=${{ secrets.GCP_DB_USERNAME }}::DB_PASSWORD=${{ secrets.GCP_DB_PASSWORD }}::DB_NAME=${{ secrets.GCP_DB_NAME }}" \
          --set-cloudsql-instances=netureyoutube:asia-northeast3:o4o-platform-db \
          --command="node" \
          --args="dist/migrate.js" \
          2>/dev/null || \
        gcloud run jobs update o4o-api-migrations \
          --image="${FULL_IMAGE}" \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --task-timeout=300 \
          --max-retries=1 \
          --set-env-vars="^::^NODE_ENV=production::DB_HOST=/cloudsql/netureyoutube:asia-northeast3:o4o-platform-db::DB_PORT=5432::DB_USERNAME=${{ secrets.GCP_DB_USERNAME }}::DB_PASSWORD=${{ secrets.GCP_DB_PASSWORD }}::DB_NAME=${{ secrets.GCP_DB_NAME }}" \
          --set-cloudsql-instances=netureyoutube:asia-northeast3:o4o-platform-db \
          --command="node" \
          --args="dist/migrate.js"

        # Execute the migration job
        echo "ğŸš€ Executing migration job..."
        gcloud run jobs execute o4o-api-migrations \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --wait

        echo "âœ… Migrations completed successfully"

    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."

        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --format="value(status.url)")

        echo "ğŸŒ Service URL: ${SERVICE_URL}"

        # Health check with retry
        for i in {1..5}; do
          echo "Health check attempt $i..."
          if curl -sf "${SERVICE_URL}/health" > /dev/null; then
            echo "âœ… Health check passed!"
            break
          fi
          if [ $i -eq 5 ]; then
            echo "âŒ Health check failed after 5 attempts"
            exit 1
          fi
          sleep 10
        done

        echo ""
        echo "=========================================="
        echo "âœ… API Server Deployed Successfully!"
        echo "=========================================="
        echo "ğŸŒ URL: ${SERVICE_URL}"
        echo "ğŸ¥ Health: ${SERVICE_URL}/health"
        echo "ğŸ“… Time: $(date)"
        echo "ğŸ“ Commit: ${{ github.sha }}"
