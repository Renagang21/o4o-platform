name: Deploy API Server (Cloud Run)

# Deploy API server to Cloud Run on push to main branch
# Phase R5: Cloud Run ë‹¨ì¼ ë°°í¬ ì²´ê³„
# Phase G1-2: Operational Mode (GRACEFUL_STARTUP=false, Cloud SQL ì—°ê²° í•„ìˆ˜)

concurrency:
  group: deploy-api-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches:
      - main
    paths:
      - 'apps/api-server/**'
      - 'packages/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: 'false'

env:
  PROJECT_ID: netureyoutube
  REGION: asia-northeast3
  SERVICE_NAME: o4o-core-api
  REPOSITORY_NAME: o4o-api
  IMAGE_NAME: api-server

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'

    - name: Install pnpm
      run: npm install -g pnpm

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build all packages for api-server
      run: |
        echo "ğŸ”¨ Building workspace packages required by api-server..."
        echo "============================================================"
        echo "Build order: foundational â†’ infra â†’ core â†’ extensions â†’ apps"
        echo "============================================================"

        # ============================================================
        # Layer 1: Foundational (no dependencies)
        # ============================================================
        echo ""
        echo "ğŸ“¦ Layer 1: Foundational packages..."
        pnpm --filter '@o4o/types' run build
        pnpm --filter '@o4o/utils' run build

        # ============================================================
        # Layer 2: Infrastructure Core (depends on types/utils only)
        # ============================================================
        echo ""
        echo "ğŸ“¦ Layer 2: Infrastructure Core packages..."
        pnpm --filter '@o4o/cpt-registry' run build
        pnpm --filter '@o4o/shortcodes' run build
        pnpm --filter '@o4o/auth-client' run build
        pnpm --filter '@o4o/block-renderer' run build
        pnpm --filter '@o4o/ui' run build

        # ============================================================
        # Layer 3: Domain Core (depends on Layer 1-2)
        # ============================================================
        echo ""
        echo "ğŸ“¦ Layer 3: Domain Core packages..."
        pnpm --filter '@o4o/organization-core' run build
        pnpm --filter '@o4o/ecommerce-core' run build
        pnpm --filter '@o4o-apps/cms-core' run build
        pnpm --filter '@o4o/forum-core' run build
        pnpm --filter '@o4o/lms-core' run build

        # ============================================================
        # Layer 4: Scheduler & Shared Services
        # ============================================================
        echo ""
        echo "ğŸ“¦ Layer 4: Scheduler & Shared Services..."
        pnpm --filter '@o4o/yaksa-scheduler' run build

        # ============================================================
        # Layer 5: Extensions & Features (depends on Core)
        # ============================================================
        echo ""
        echo "ğŸ“¦ Layer 5: Extensions & Features..."
        pnpm --filter '@o4o-apps/signage' run build
        pnpm --filter '@o4o-extensions/organization-forum' run build
        pnpm --filter '@o4o/lms-yaksa' run build
        pnpm --filter '@o4o/membership-yaksa' run build
        pnpm --filter '@o4o/reporting-yaksa' run build
        pnpm --filter '@o4o/annualfee-yaksa' run build
        pnpm --filter '@o4o/groupbuy-yaksa' run build
        pnpm --filter '@o4o-apps/forum-yaksa' run build || true

        # ============================================================
        # Layer 6: Cosmetics Extensions
        # ============================================================
        echo ""
        echo "ğŸ“¦ Layer 6: Cosmetics Extensions..."
        pnpm --filter '@o4o/cosmetics-seller-extension' run build
        pnpm --filter '@o4o/cosmetics-supplier-extension' run build
        pnpm --filter '@o4o/cosmetics-sample-display-extension' run build
        # Note: dropshipping-cosmetics is compiled by api-server (no independent build)

        echo ""
        echo "âœ… All required packages built successfully!"

    - name: Build API server (bundled with tsup)
      run: |
        cd apps/api-server

        # ============================================================
        # Build Strategy:
        # 1. First build with tsc (compiles migrations with decorators)
        # 2. Backup migrations folder
        # 3. Build with tsup (creates bundled main.js, may clean dist)
        # 4. Restore migrations from backup
        # ============================================================

        # Step 1: Build everything with tsc first (handles decorators properly)
        echo "ğŸ”¨ Step 1: Building with tsc (includes migrations)..."
        pnpm run build

        # Step 2: Backup migrations folder before tsup might clean dist
        echo "ğŸ“¦ Step 2: Backing up migrations..."
        if [ -d "dist/database/migrations" ]; then
          cp -r dist/database/migrations /tmp/migrations-backup
          echo "âœ… Migrations backed up: $(ls /tmp/migrations-backup/*.js 2>/dev/null | wc -l) files"
          ls -la /tmp/migrations-backup/
        else
          echo "âš ï¸ No migrations found to backup"
          ls -la dist/
        fi

        # Step 3: Build with tsup (creates bundled main.js)
        echo "ğŸ”¨ Step 3: Building API server with tsup (bundled build)..."
        pnpm run build:api

        # Step 4: Restore migrations from backup
        echo "ğŸ“¦ Step 4: Restoring migrations..."
        if [ -d "/tmp/migrations-backup" ]; then
          # Remove any existing migrations folder (may be empty from tsup)
          rm -rf dist/database/migrations
          mkdir -p dist/database
          # Copy backup contents to migrations folder
          cp -r /tmp/migrations-backup dist/database/migrations
          echo "âœ… Migrations restored: $(ls dist/database/migrations/*.js 2>/dev/null | wc -l) files"
          ls -la dist/database/migrations/ | head -10
        else
          echo "âš ï¸ No migrations backup found"
        fi

        # Verify build output
        if [ ! -f "dist/main.js" ]; then
          echo "âŒ Build failed: dist/main.js not found"
          exit 1
        fi

        echo "âœ… API server build complete"
        echo "ğŸ“¦ Bundle size: $(du -h dist/main.js | cut -f1)"

        # List generated files
        echo "ğŸ“‹ Generated files:"
        ls -la dist/
        echo ""
        echo "ğŸ“‹ Migrations:"
        ls -la dist/database/migrations/ 2>/dev/null || echo "âš ï¸ No migrations directory"

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build and Push Docker image
      run: |
        cd apps/api-server

        # Verify tsup bundle exists
        echo "ğŸ“‚ Checking bundled output:"
        ls -la dist/main.js dist/main.js.map || (echo "âŒ Bundle not found!" && exit 1)
        echo "ğŸ“¦ Bundle size: $(du -h dist/main.js | cut -f1)"

        IMAGE_TAG="${{ github.sha }}"
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
        LATEST_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:latest"

        echo "ğŸ³ Building Docker image..."
        docker build \
          --no-cache \
          --build-arg CACHEBUST=$(date +%s) \
          --platform linux/amd64 \
          --tag "${FULL_IMAGE}" \
          --tag "${LATEST_IMAGE}" \
          --file Dockerfile \
          .

        # Verify the image contains the bundle
        echo "ğŸ” Verifying Docker image contents..."
        docker run --rm "${FULL_IMAGE}" ls -la /app/dist/

        echo "ğŸ“¤ Pushing to Artifact Registry..."
        docker push "${FULL_IMAGE}"
        docker push "${LATEST_IMAGE}"

        echo "âœ… Image pushed: ${FULL_IMAGE}"
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

    - name: Deploy to Cloud Run
      run: |
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"

        echo "ğŸš€ Deploying to Cloud Run..."

        # ============================================================
        # G1-2 Phase: Operational Mode - DB Connection Required
        # ============================================================
        # GRACEFUL_STARTUP=false means app will fail if DB is unavailable
        # This is the production-ready configuration
        # ============================================================

        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image="${FULL_IMAGE}" \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=1Gi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=10 \
          --concurrency=80 \
          --timeout=300 \
          --set-env-vars="NODE_ENV=production" \
          --set-env-vars="GRACEFUL_STARTUP=false" \
          --set-env-vars="EMAIL_SERVICE_ENABLED=false" \
          --set-env-vars="DB_HOST=/cloudsql/netureyoutube:asia-northeast3:o4o-platform-db" \
          --set-env-vars="DB_PORT=5432" \
          --set-env-vars="DB_USERNAME=${{ secrets.GCP_DB_USERNAME }}" \
          --set-env-vars="DB_PASSWORD=${{ secrets.GCP_DB_PASSWORD }}" \
          --set-env-vars="DB_NAME=${{ secrets.GCP_DB_NAME }}" \
          --set-env-vars="JWT_SECRET=${{ secrets.GCP_JWT_SECRET }}" \
          --set-env-vars="JWT_REFRESH_SECRET=${{ secrets.GCP_JWT_SECRET }}" \
          --add-cloudsql-instances=netureyoutube:asia-northeast3:o4o-platform-db

    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."

        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --format="value(status.url)")

        echo "ğŸŒ Service URL: ${SERVICE_URL}"

        # Health check with retry
        for i in {1..5}; do
          echo "Health check attempt $i..."
          if curl -sf "${SERVICE_URL}/health" > /dev/null; then
            echo "âœ… Health check passed!"
            break
          fi
          if [ $i -eq 5 ]; then
            echo "âŒ Health check failed after 5 attempts"
            exit 1
          fi
          sleep 10
        done

        echo ""
        echo "=========================================="
        echo "âœ… API Server Deployed Successfully!"
        echo "=========================================="
        echo "ğŸŒ URL: ${SERVICE_URL}"
        echo "ğŸ¥ Health: ${SERVICE_URL}/health"
        echo "ğŸ“… Time: $(date)"
        echo "ğŸ“ Commit: ${{ github.sha }}"
