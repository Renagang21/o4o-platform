name: Direct Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.18.0'
    
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 10
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Build packages
      run: pnpm run build:packages
    
    - name: Build Admin Dashboard
      run: |
        cd apps/admin-dashboard
        NODE_OPTIONS='--max-old-space-size=4096' \
        GENERATE_SOURCEMAP=false \
        VITE_API_URL=https://api.neture.co.kr \
        pnpm run build
    
    - name: Deploy to Server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: admin.neture.co.kr
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "apps/admin-dashboard/dist/*"
        target: "/var/www/admin.neture.co.kr"
        strip_components: 3
        rm: true
    
    - name: Reload Nginx
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: admin.neture.co.kr
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sudo systemctl reload nginx
          echo "{\"version\": \"$(date +%s)\", \"commit\": \"${{ github.sha }}\"}" | sudo tee /var/www/admin.neture.co.kr/version.json