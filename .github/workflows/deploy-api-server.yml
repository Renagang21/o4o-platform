# o4o-apiserver ìë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
name: Deploy API Server to o4o-apiserver

on:
  push:
    branches: [main]
    paths: 
      - 'services/api-server/**'
      - 'scripts/**'
      - 'package.json'
      - 'package-lock.json'
      - '.env.example'
      - 'ecosystem.config.js'
      - '.github/workflows/deploy-api-server.yml'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      reason:
        description: 'ë°°í¬ ì´ìœ '
        required: false
        default: 'ìˆ˜ë™ ë°°í¬'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“‹ ë°°í¬ ì‹œì‘ ë¡œê·¸
      run: |
        echo "ğŸš€ o4o-apiserver ë°°í¬ ì‹œì‘"
        echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
        echo "ğŸ‘¤ ì‹¤í–‰ì: ${{ github.actor }}"
        echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
        echo "ğŸ”— ë¸Œëœì¹˜: ${{ github.ref }}"
        
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ”§ ì„œë²„ ë°°í¬ ë° sparse-checkout ì„¤ì •
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.APISERVER_HOST }}
        username: ${{ secrets.APISERVER_USER }}
        key: ${{ secrets.APISERVER_SSH_KEY }}
        timeout: 300s
        script: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨
          
          echo "=== ğŸ  ì‘ì—… ë””ë ‰í† ë¦¬ ì´ë™ ==="
          cd /home/ubuntu/o4o-platform || {
            echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          }
          
          echo "=== ğŸ“‹ í˜„ì¬ ìƒíƒœ í™•ì¸ ==="
          echo "ğŸ“ í˜„ì¬ ìœ„ì¹˜: $(pwd)"
          echo "ğŸ–¥ï¸ ì„œë²„ í˜¸ìŠ¤íŠ¸: $(hostname)"
          echo "â° ì„œë²„ ì‹œê°„: $(date)"
          
          echo "=== ğŸ’¾ í˜„ì¬ ì‘ì—… ë°±ì—… ==="
          git stash push -m "auto-backup-$(date +%Y%m%d_%H%M%S)" || echo "ë°±ì—…í•  ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          
          echo "=== ğŸ”§ sparse-checkout ì„¤ì • í™•ì¸ ë° ì ìš© ==="
          if ! git config core.sparseCheckout >/dev/null 2>&1; then
            echo "âš™ï¸ ìµœì´ˆ sparse-checkout ì„¤ì • ì¤‘..."
            git sparse-checkout init --cone
            git sparse-checkout set services/api-server scripts
            git sparse-checkout add package.json package-lock.json .env.example .gitignore README.md ecosystem.config.js
            echo "âœ… sparse-checkout ì„¤ì • ì™„ë£Œ"
          else
            echo "âœ… sparse-checkout ì´ë¯¸ ì„¤ì •ë¨"
            git sparse-checkout list
          fi
          
          echo "=== ğŸ“¥ ìµœì‹  ì½”ë“œ ë™ê¸°í™” ==="
          git fetch origin --prune
          echo "í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "ë™ê¸°í™” ì „ ì»¤ë°‹: $(git rev-parse HEAD)"
          
          git reset --hard origin/main
          echo "ë™ê¸°í™” í›„ ì»¤ë°‹: $(git rev-parse HEAD)"
          
          echo "=== ğŸ“Š ë³€ê²½ì‚¬í•­ í™•ì¸ ==="
          git status
          echo "í˜„ì¬ services í´ë” êµ¬ì¡°:"
          ls -la services/ || echo "services í´ë” ì—†ìŒ"
          
          echo "=== ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ==="
          cd services/api-server
          if [ -f package.json ]; then
            echo "ğŸ“¦ npm install ì‹¤í–‰ ì¤‘..."
            npm install --production
            echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
          else
            echo "âš ï¸ package.jsonì´ ì—†ìŠµë‹ˆë‹¤"
          fi
          
          echo "=== ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ==="
          # PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ìš°
          if command -v pm2 >/dev/null 2>&1; then
            echo "ğŸ”„ PM2ë¡œ ì¬ì‹œì‘..."
            pm2 restart api-server || pm2 start npm --name "api-server" -- start
            pm2 status
          else
            echo "âš ï¸ PM2ê°€ ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ. ìˆ˜ë™ ì¬ì‹œì‘ í•„ìš”"
          fi
          
          echo "=== âœ… ë°°í¬ ì™„ë£Œ ==="
          echo "ğŸ‰ o4o-apiserver ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ“Š ìµœì¢… Git ìƒíƒœ:"
          git log -1 --oneline
          
    - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "âœ… ë°°í¬ ì„±ê³µ!"
        echo "ğŸ”— ì„œë²„: ${{ secrets.APISERVER_HOST }}"
        echo "â° ì™„ë£Œ ì‹œê°„: $(date)"
        
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì²˜ë¦¬
      if: failure()
      run: |
        echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
