name: Deploy Admin Dashboard (Production)

# ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì ì§„ì  ë°°í¬ ì›Œí¬í”Œë¡œìš°
# íŠ¸ë¦¬ê±°: apps/admin-dashboard ê²½ë¡œ ë³€ê²½ ì‹œ
# ë‹¨ê³„: Build â†’ Security Check â†’ Deploy â†’ Health Check

on:
  push:
    branches: [main]
    paths:
      - 'apps/admin-dashboard/**'
      - 'packages/**'
      - '.github/workflows/deploy-admin-dashboard.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy without path changes'
        required: false
        default: 'false'

concurrency:
  group: deploy-admin-dashboard-${{ github.ref }}
  cancel-in-progress: false

env:
  SERVICE_NAME: admin-dashboard
  SERVICE_PORT: 3001
  PM2_APP_NAME: o4o-admin-dashboard
  DEPLOY_PATH: /home/ubuntu/o4o-platform
  NODE_VERSION: '20.18.0'

jobs:
  # ë‹¨ê³„ 1: ë¹Œë“œ ë° ë³´ì•ˆ ê²€ì‚¬
  build-and-security:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        npm ci
        bash scripts/setup-ci-env.sh
    
    - name: Build shared packages
      run: |
        echo "Building shared packages first..."
        bash scripts/build-packages.sh
        
    - name: Install admin dashboard dependencies
      run: |
        cd apps/admin-dashboard
        npm ci
        
    - name: TypeScript type check
      run: |
        npm run type-check --workspace=@o4o/admin-dashboard
        
    - name: ESLint security check
      run: |
        npm run lint --workspace=@o4o/admin-dashboard
        
    - name: Security audit (Admin specific)
      run: |
        npm audit --audit-level=moderate --workspace=@o4o/admin-dashboard
        
    - name: Build packages
      run: |
        bash scripts/build-packages.sh
        
    - name: Create production environment file
      run: |
        cd apps/admin-dashboard
        cat > .env.production << 'EOF'
        NODE_ENV=production
        VITE_API_BASE_URL=https://api.neture.co.kr
        VITE_APP_TITLE=O4O Admin Dashboard
        VITE_MAIN_SITE_URL=https://neture.co.kr
        VITE_ADMIN_URL=https://admin.neture.co.kr
        VITE_ENABLE_ANALYTICS=false
        VITE_ENABLE_DEBUG=false
        VITE_SECURITY_MODE=strict
        VITE_SESSION_TIMEOUT=3600
        VITE_BUILD_TIMESTAMP=${{ github.run_number }}
        EOF
        
    - name: Build application for production
      run: |
        cd apps/admin-dashboard
        npm run build
        
    - name: Security headers validation
      run: |
        cd apps/admin-dashboard/dist
        # CSP ë° ë³´ì•ˆ í—¤ë” ì„¤ì • í™•ì¸
        if grep -r "Content-Security-Policy" . || grep -r "csp" . >/dev/null 2>&1; then
          echo "âœ… CSP ì„¤ì • í™•ì¸ë¨"
        else
          echo "âš ï¸  CSP ì„¤ì • ê¶Œì¥"
        fi
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: admin-dashboard-build
        path: |
          apps/admin-dashboard/dist/
          apps/admin-dashboard/package.json
          apps/admin-dashboard/package-lock.json
          apps/admin-dashboard/.env.production
        retention-days: 1

  # ë‹¨ê³„ 2: ì¶”ê°€ ë³´ì•ˆ ë° ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
  security-compliance:
    needs: build-and-security
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: admin-dashboard-build
        path: apps/admin-dashboard/
        
    - name: OWASP ZAP baseline scan preparation
      run: |
        echo "ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë³´ì•ˆ ìŠ¤ìº” ì¤€ë¹„ ì™„ë£Œ"
        echo "ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” OWASP ZAP ë˜ëŠ” ìœ ì‚¬í•œ ë„êµ¬ ì‚¬ìš© ê¶Œì¥"
        
    - name: Dependency vulnerability check
      run: |
        cd apps/admin-dashboard
        # ê³ ìœ„í—˜ ì·¨ì•½ì  ê²€ì‚¬
        npm audit --audit-level=high --production
        
    - name: Bundle analysis for security
      run: |
        cd apps/admin-dashboard
        # ë²ˆë“¤ í¬ê¸° ë° ì˜ì¡´ì„± ë¶„ì„
        npm run build:analyze || true

  # ë‹¨ê³„ 3: ìš´ì˜ ì„œë²„ ë°°í¬ (ë³´ì•ˆ ê°•í™”)
  deploy:
    needs: [build-and-security, security-compliance]
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: admin-dashboard-build
        path: apps/admin-dashboard/
        
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.WEB_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.WEB_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        echo "SSH key setup completed"
        
    - name: Create backup of current deployment
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          if [ -d 'apps/admin-dashboard' ]; then
            echo 'Creating backup of current admin-dashboard...'
            rm -rf apps/admin-dashboard.backup
            cp -r apps/admin-dashboard apps/admin-dashboard.backup
          fi
        "
        
    - name: Create deployment directory
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          mkdir -p ${{ env.DEPLOY_PATH }}/apps/admin-dashboard
        "
        
    - name: Deploy static files to secured directory
      run: |
        # ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ì •ì  íŒŒì¼ ë°°í¬
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          mkdir -p /var/www/admin.neture.co.kr
          chmod 750 /var/www/admin.neture.co.kr
        "
        
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
          apps/admin-dashboard/dist/ \
          ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }}:/var/www/admin.neture.co.kr/
          
    - name: Deploy application files
      run: |
        rsync -avz --delete \
          -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
          apps/admin-dashboard/ \
          ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }}:${{ env.DEPLOY_PATH }}/apps/admin-dashboard/
          
    - name: Install production dependencies
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/apps/admin-dashboard
          npm ci --only=production
        "
        
    - name: Setup PM2 ecosystem file (Admin Security)
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cat > ${{ env.DEPLOY_PATH }}/admin-dashboard.ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: '${{ env.PM2_APP_NAME }}',
              script: 'serve',
              args: [
                'dist',
                '-s',
                '-l', '${{ env.SERVICE_PORT }}',
                '--cors',
                '--single'
              ],
              cwd: '${{ env.DEPLOY_PATH }}/apps/admin-dashboard',
              instances: 2,
              exec_mode: 'cluster',
              max_memory_restart: '256M',
              error_file: '${{ env.DEPLOY_PATH }}/logs/admin-dashboard-error.log',
              out_file: '${{ env.DEPLOY_PATH }}/logs/admin-dashboard-out.log',
              log_file: '${{ env.DEPLOY_PATH }}/logs/admin-dashboard-combined.log',
              time: true,
              autorestart: true,
              max_restarts: 5,
              min_uptime: '10s',
              kill_timeout: 30000,
              restart_delay: 5000,
              env: {
                NODE_ENV: 'production',
                PORT: '${{ env.SERVICE_PORT }}',
                ADMIN_MODE: 'true'
              }
            }]
          };
          EOF
        "
        
    - name: Set secure file permissions
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cd ${{ env.DEPLOY_PATH }}/apps/admin-dashboard
          
          # ë³´ì•ˆ ê°•í™”ëœ ê¶Œí•œ ì„¤ì •
          chmod -R 640 .
          chmod -R +X .
          chmod 644 package*.json
          chmod -R 644 dist/
          
          # ë¡œê·¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ
          mkdir -p ${{ env.DEPLOY_PATH }}/logs
          chmod 750 ${{ env.DEPLOY_PATH }}/logs
        "
        
    - name: Deploy with PM2 (Zero-downtime)
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          
          # PM2 í”„ë¡œì„¸ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if pm2 describe ${{ env.PM2_APP_NAME }} > /dev/null 2>&1; then
            echo 'Reloading existing PM2 process...'
            pm2 reload admin-dashboard.ecosystem.config.js --update-env
          else
            echo 'Starting new PM2 process...'
            pm2 start admin-dashboard.ecosystem.config.js
          fi
          
          # PM2 ìƒíƒœ ì €ì¥
          pm2 save
        "

  # ë‹¨ê³„ 4: ë³´ì•ˆ ë° ì ‘ê·¼ í…ŒìŠ¤íŠ¸
  security-health-check:
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for service startup
      run: sleep 30
      
    - name: Basic health check
      run: |
        for i in {1..10}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            https://admin.neture.co.kr/ || echo "000")
            
          if [ "$response" = "200" ]; then
            echo "âœ… ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‘ë‹µ ì½”ë“œ: $response)"
            break
          else
            echo "â³ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„ $i/10, ì‘ë‹µ ì½”ë“œ: $response)"
            if [ $i -eq 10 ]; then
              echo "âŒ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              exit 1
            fi
            sleep 10
          fi
        done
        
    - name: Security headers verification
      run: |
        echo "ë³´ì•ˆ í—¤ë” í™•ì¸ ì¤‘..."
        headers=$(curl -s -I https://admin.neture.co.kr/)
        
        if echo "$headers" | grep -i "strict-transport-security"; then
          echo "âœ… HSTS í—¤ë” í™•ì¸"
        else
          echo "âš ï¸  HSTS í—¤ë” ëˆ„ë½"
        fi
        
        if echo "$headers" | grep -i "x-frame-options"; then
          echo "âœ… X-Frame-Options í—¤ë” í™•ì¸"
        else
          echo "âš ï¸  X-Frame-Options í—¤ë” ëˆ„ë½"
        fi
        
        if echo "$headers" | grep -i "x-content-type-options"; then
          echo "âœ… X-Content-Type-Options í—¤ë” í™•ì¸"
        else
          echo "âš ï¸  X-Content-Type-Options í—¤ë” ëˆ„ë½"
        fi
        
    - name: Login page accessibility test
      run: |
        # ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
        content=$(curl -s https://admin.neture.co.kr/login || echo "failed")
        
        if echo "$content" | grep -q "login\|ë¡œê·¸ì¸"; then
          echo "âœ… ë¡œê·¸ì¸ í˜ì´ì§€ ì ‘ê·¼ í™•ì¸"
        else
          echo "âš ï¸  ë¡œê·¸ì¸ í˜ì´ì§€ í™•ì¸ í•„ìš”"
        fi
        
    - name: API connectivity test (Admin)
      run: |
        # ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ API ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
        response=$(curl -s -w "%{http_code}" \
          -H "Origin: https://admin.neture.co.kr" \
          "https://api.neture.co.kr/health" || echo "000")
          
        if [[ "$response" == *"200" ]]; then
          echo "âœ… ê´€ë¦¬ì â†’ API ì„œë²„ ì—°ê²° í™•ì¸"
        else
          echo "âš ï¸  ê´€ë¦¬ì â†’ API ì„œë²„ ì—°ê²° í™•ì¸ í•„ìš”"
        fi
        
    - name: Admin routes protection test
      run: |
        # ë³´í˜¸ëœ ê´€ë¦¬ì ë¼ìš°íŠ¸ í…ŒìŠ¤íŠ¸
        routes=("/admin" "/dashboard" "/users" "/settings")
        
        for route in "${routes[@]}"; do
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://admin.neture.co.kr$route" || echo "000")
            
          # 401 ë˜ëŠ” 403 ë˜ëŠ” 200(ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜)ì´ë©´ ì •ìƒ
          if [[ "$response" =~ ^(200|401|403)$ ]]; then
            echo "âœ… ë³´í˜¸ëœ ë¼ìš°íŠ¸ í™•ì¸: $route (ì‘ë‹µ: $response)"
          else
            echo "âš ï¸  ë³´í˜¸ëœ ë¼ìš°íŠ¸ í™•ì¸ í•„ìš”: $route (ì‘ë‹µ: $response)"
          fi
        done

  # ë‹¨ê³„ 5: ì„±ëŠ¥ ë° ì‚¬ìš©ì„± í…ŒìŠ¤íŠ¸
  performance-check:
    needs: security-health-check
    runs-on: ubuntu-latest
    
    steps:
    - name: Page load performance test
      run: |
        # ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •
        load_time=$(curl -s -o /dev/null -w "%{time_total}" \
          https://admin.neture.co.kr/)
        
        echo "ğŸ“Š ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì‹œê°„: ${load_time}ì´ˆ"
        
        # 5ì´ˆ ì´ìƒì´ë©´ ê²½ê³  (ê´€ë¦¬ì í˜ì´ì§€ëŠ” ì¢€ ë” ê´€ëŒ€)
        if (( $(echo "$load_time > 5.0" | bc -l) )); then
          echo "âš ï¸  ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì‹œê°„ì´ ëŠë¦½ë‹ˆë‹¤ (${load_time}ì´ˆ)"
        else
          echo "âœ… ê´€ë¦¬ì í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì–‘í˜¸ (${load_time}ì´ˆ)"
        fi
        
    - name: Admin dashboard functionality test
      run: |
        echo "ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        echo "ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë‹¤ìŒì„ ì¶”ê°€ë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”:"
        echo "- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥"
        echo "- ì‚¬ìš©ì ê´€ë¦¬ ê¸°ëŠ¥"
        echo "- ë°ì´í„° ì¡°íšŒ/ìˆ˜ì • ê¸°ëŠ¥"
        echo "- ê¶Œí•œë³„ ì ‘ê·¼ ì œì–´"

  # ë‹¨ê³„ 6: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
  notify:
    needs: [deploy, security-health-check, performance-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment success notification
      if: needs.security-health-check.result == 'success'
      run: |
        echo "ğŸš€ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë°°í¬ ì„±ê³µ!"
        echo "ğŸ“ ì„œë¹„ìŠ¤ URL: https://admin.neture.co.kr"
        echo "ğŸ• ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”’ ë³´ì•ˆ ê²€ì‚¬: í†µê³¼"
        echo "ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ì™„ë£Œ"
        echo ""
        echo "âš ï¸  ë³´ì•ˆ ì•Œë¦¼:"
        echo "- ê´€ë¦¬ì ê³„ì • ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ í•„ìš”"
        echo "- ê¶Œí•œë³„ ì ‘ê·¼ ì œì–´ í™•ì¸ í•„ìš”"
        echo "- IP ê¸°ë°˜ ì ‘ê·¼ ì œí•œ ì„¤ì • ê²€í† "
        
    - name: Deployment failure notification
      if: needs.security-health-check.result == 'failure' || needs.deploy.result == 'failure'
      run: |
        echo "âŒ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë°°í¬ ì‹¤íŒ¨!"
        echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”."
        echo "ğŸ”’ ë³´ì•ˆìƒ ì¤‘ìš”í•œ ì„œë¹„ìŠ¤ì´ë¯€ë¡œ ì‹ ì¤‘í•˜ê²Œ ê²€í† í•˜ì„¸ìš”."
        exit 1

  # ë‹¨ê³„ 7: ë¡¤ë°± ì¤€ë¹„ (ì‹¤íŒ¨ ì‹œ)
  rollback:
    needs: [deploy, security-health-check]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.WEB_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.WEB_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        echo "SSH key setup completed"
        
    - name: Rollback to previous version
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.WEB_USER }}@${{ secrets.WEB_HOST }} "
          cd ${{ env.DEPLOY_PATH }}
          
          # ì´ì „ ë°±ì—…ì—ì„œ ë³µì›
          if [ -d 'apps/admin-dashboard.backup' ]; then
            echo 'ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°± ì¤‘...'
            rm -rf apps/admin-dashboard
            mv apps/admin-dashboard.backup apps/admin-dashboard
            
            # ì •ì  íŒŒì¼ë„ ë³µì›
            rsync -av apps/admin-dashboard/dist/ /var/www/admin.neture.co.kr/
            
            # PM2 ì¬ì‹œì‘
            pm2 restart ${{ env.PM2_APP_NAME }}
            echo 'ë¡¤ë°± ì™„ë£Œ'
          else
            echo 'ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ë³µêµ¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
          fi
        "
        
    - name: Rollback notification
      run: |
        echo "ğŸ”„ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë¡¤ë°± ì™„ë£Œ"
        echo "âš ï¸  ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
        echo "ğŸ”’ ë³´ì•ˆìƒ ì¤‘ìš”í•˜ë¯€ë¡œ ì¦‰ì‹œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."