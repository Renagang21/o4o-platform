name: Selective Deployment to AWS Lightsail

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-server-changed: ${{ steps.changes.outputs.api-server }}
      web-server-changed: ${{ steps.changes.outputs.web-server }}
      shared-changed: ${{ steps.changes.outputs.shared }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          api-server:
            - 'services/api-server/**'
          web-server:
            - 'services/main-site/**'
            - 'services/crowdfunding/**'
            - 'services/ecommerce/**'
            - 'services/forum/**'
            - 'services/signage/**'
          shared:
            - 'package.json'
            - 'package-lock.json'
            - 'docker-compose.production.yml'
            - 'Dockerfile'
            - '.env.example'
            - 'scripts/**'

  deploy-api-server:
    needs: detect-changes
    if: needs.detect-changes.outputs.api-server-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to o4o-apiserver
      run: |
        echo "🚀 API 서버 배포 시작..."
        
        # SSH를 통한 서버 접속 및 배포
        echo "SSH_HOST: ${{ secrets.API_SERVER_HOST }}"
        echo "SSH_USER: ${{ secrets.SSH_USER }}"
        
        # 실제 API 서버 배포 명령어
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.API_SERVER_HOST }} "
          set -e
          echo '🔄 API 서버 배포 프로세스 시작...'
          cd /home/ubuntu/o4o-platform || { echo '❌ 프로젝트 디렉토리 없음'; exit 1; }
          
          echo '📥 최신 코드 가져오기...'
          git fetch origin  
          git reset --hard origin/main
          
          echo '🐳 API 서비스 재시작...'
          docker-compose -f docker-compose.production.yml stop api-server || true
          docker-compose -f docker-compose.production.yml rm -f api-server || true
          docker-compose -f docker-compose.production.yml build api-server
          docker-compose -f docker-compose.production.yml up -d api-server
          
          echo '⏱️ 서비스 안정화 대기...'
          sleep 30
          
          echo '🏥 헬스체크 수행...'
          curl -f http://localhost:3000/api/health || { echo '❌ API 헬스체크 실패'; exit 1; }
          
          echo '✅ API 서버 배포 완료!'
        "

  deploy-web-server:
    needs: detect-changes  
    if: needs.detect-changes.outputs.web-server-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to o4o-webserver
      run: |
        echo "🚀 웹 서버 배포 시작..."
        
        # SSH를 통한 서버 접속 및 배포
        echo "SSH_HOST: ${{ secrets.API_SERVER_HOST }}"
        echo "SSH_USER: ${{ secrets.SSH_USER }}"
        
        # 실제 배포 명령어 실행
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.API_SERVER_HOST }} "
          set -e
          echo '🔄 서버 배포 프로세스 시작...'
          cd /home/ubuntu/o4o-platform || { echo '❌ 프로젝트 디렉토리 없음'; exit 1; }
          
          echo '📥 최신 코드 가져오기...'
          git fetch origin
          git reset --hard origin/main
          
          echo '🐳 웹 서비스 재시작...'
          docker-compose -f docker-compose.production.yml stop web-app || true
          docker-compose -f docker-compose.production.yml rm -f web-app || true
          docker-compose -f docker-compose.production.yml build web-app
          docker-compose -f docker-compose.production.yml up -d web-app
          
          echo '⏱️ 서비스 안정화 대기...'
          sleep 30
          
          echo '🏥 헬스체크 수행...'
          curl -f http://localhost/health || { echo '❌ 헬스체크 실패'; exit 1; }
          
          echo '✅ 웹 서버 배포 완료!'
        "

  notify-deployment:
    needs: [deploy-api-server, deploy-web-server]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Deployment Summary
      run: |
        echo "📊 배포 완료 요약:"
        echo "API 서버: ${{ needs.deploy-api-server.result }}"
        echo "웹 서버: ${{ needs.deploy-web-server.result }}"
