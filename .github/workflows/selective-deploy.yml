name: Selective Deployment to AWS Lightsail

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-server-changed: ${{ steps.changes.outputs.api-server }}
      web-server-changed: ${{ steps.changes.outputs.web-server }}
      shared-changed: ${{ steps.changes.outputs.shared }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          api-server:
            - 'services/api-server/**'
          web-server:
            - 'services/main-site/**'
          shared:
            - 'package.json'
            - 'package-lock.json'
            - 'docker-compose.production.yml'
            - 'Dockerfile'
            - '.env.example'
            - 'scripts/**'

  deploy-api-server:
    needs: detect-changes
    if: needs.detect-changes.outputs.api-server-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to o4o-apiserver
      run: |
        echo "ğŸš€ API ì„œë²„ ë°°í¬ ì‹œì‘..."
        
        # SSHë¥¼ í†µí•œ ì„œë²„ ì ‘ì† ë° ë°°í¬
        # ì‹¤ì œ ë°°í¬ì‹œì—ëŠ” ì—¬ê¸°ì— SSH í‚¤ì™€ ì„œë²„ ì •ë³´ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤
        echo "SSH_HOST: ${{ secrets.API_SERVER_HOST }}"
        echo "SSH_USER: ${{ secrets.SSH_USER }}"
        
        # ì˜ˆì‹œ ë°°í¬ ëª…ë ¹ì–´ (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
        # ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.API_SERVER_HOST }} "
        #   cd /path/to/o4o-platform &&
        #   git pull origin main &&
        #   bash setup-apiserver-sync.sh &&
        #   docker-compose -f docker-compose.production.yml up -d api-server
        # "

  deploy-web-server:
    needs: detect-changes  
    if: needs.detect-changes.outputs.web-server-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to o4o-webserver
      run: |
        echo "ğŸš€ ì›¹ ì„œë²„ ë°°í¬ ì‹œì‘..."
        
        # SSHë¥¼ í†µí•œ ì„œë²„ ì ‘ì† ë° ë°°í¬
        echo "SSH_HOST: ${{ secrets.WEB_SERVER_HOST }}"
        echo "SSH_USER: ${{ secrets.SSH_USER }}"
        
        # ì˜ˆì‹œ ë°°í¬ ëª…ë ¹ì–´ (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
        # ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.WEB_SERVER_HOST }} "
        #   cd /path/to/o4o-platform &&
        #   git pull origin main &&
        #   bash setup-webserver-sync.sh &&
        #   docker-compose -f docker-compose.production.yml up -d web-server
        # "

  notify-deployment:
    needs: [deploy-api-server, deploy-web-server]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Deployment Summary
      run: |
        echo "ğŸ“Š ë°°í¬ ì™„ë£Œ ìš”ì•½:"
        echo "API ì„œë²„: ${{ needs.deploy-api-server.result }}"
        echo "ì›¹ ì„œë²„: ${{ needs.deploy-web-server.result }}"
