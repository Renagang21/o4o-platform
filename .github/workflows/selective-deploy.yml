name: Selective Deployment to AWS Lightsail

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-server-changed: ${{ steps.changes.outputs.api-server }}
      web-server-changed: ${{ steps.changes.outputs.web-server }}
      shared-changed: ${{ steps.changes.outputs.shared }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          api-server:
            - 'services/api-server/**'
          web-server:
            - 'services/main-site/**'
            - 'services/crowdfunding/**'
            - 'services/ecommerce/**'
            - 'services/forum/**'
            - 'services/signage/**'
          shared:
            - 'package.json'
            - 'package-lock.json'
            - 'docker-compose.production.yml'
            - 'Dockerfile'
            - '.env.example'
            - 'scripts/**'

  deploy-api-server:
    needs: detect-changes
    if: needs.detect-changes.outputs.api-server-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to o4o-apiserver
      run: |
        echo "ğŸš€ API ì„œë²„ ë°°í¬ ì‹œì‘..."
        
        # SSHë¥¼ í†µí•œ ì„œë²„ ì ‘ì† ë° ë°°í¬
        echo "SSH_HOST: ${{ secrets.API_SERVER_HOST }}"
        echo "SSH_USER: ${{ secrets.SSH_USER }}"
        
        # ì‹¤ì œ API ì„œë²„ ë°°í¬ ëª…ë ¹ì–´
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.API_SERVER_HOST }} "
          set -e
          echo 'ğŸ”„ API ì„œë²„ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...'
          cd /home/ubuntu/o4o-platform || { echo 'âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ'; exit 1; }
          
          echo 'ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°...'
          git fetch origin  
          git reset --hard origin/main
          
          echo 'ğŸ³ API ì„œë¹„ìŠ¤ ì¬ì‹œì‘...'
          docker-compose -f docker-compose.production.yml stop api-server || true
          docker-compose -f docker-compose.production.yml rm -f api-server || true
          docker-compose -f docker-compose.production.yml build api-server
          docker-compose -f docker-compose.production.yml up -d api-server
          
          echo 'â±ï¸ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°...'
          sleep 30
          
          echo 'ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰...'
          curl -f http://localhost:3000/api/health || { echo 'âŒ API í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨'; exit 1; }
          
          echo 'âœ… API ì„œë²„ ë°°í¬ ì™„ë£Œ!'
        "

  deploy-web-server:
    needs: detect-changes  
    if: needs.detect-changes.outputs.web-server-changed == 'true' || needs.detect-changes.outputs.shared-changed == 'true'
    runs-on: ubuntu-latest
    steps:
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to o4o-webserver
      run: |
        echo "ğŸš€ ì›¹ ì„œë²„ ë°°í¬ ì‹œì‘..."
        
        # SSHë¥¼ í†µí•œ ì„œë²„ ì ‘ì† ë° ë°°í¬
        echo "SSH_HOST: ${{ secrets.API_SERVER_HOST }}"
        echo "SSH_USER: ${{ secrets.SSH_USER }}"
        
        # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ ì‹¤í–‰
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.API_SERVER_HOST }} "
          set -e
          echo 'ğŸ”„ ì„œë²„ ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘...'
          cd /home/ubuntu/o4o-platform || { echo 'âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ'; exit 1; }
          
          echo 'ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°...'
          git fetch origin
          git reset --hard origin/main
          
          echo 'ğŸ³ ì›¹ ì„œë¹„ìŠ¤ ì¬ì‹œì‘...'
          docker-compose -f docker-compose.production.yml stop web-app || true
          docker-compose -f docker-compose.production.yml rm -f web-app || true
          docker-compose -f docker-compose.production.yml build web-app
          docker-compose -f docker-compose.production.yml up -d web-app
          
          echo 'â±ï¸ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°...'
          sleep 30
          
          echo 'ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰...'
          curl -f http://localhost/health || { echo 'âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨'; exit 1; }
          
          echo 'âœ… ì›¹ ì„œë²„ ë°°í¬ ì™„ë£Œ!'
        "

  notify-deployment:
    needs: [deploy-api-server, deploy-web-server]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Deployment Summary
      run: |
        echo "ğŸ“Š ë°°í¬ ì™„ë£Œ ìš”ì•½:"
        echo "API ì„œë²„: ${{ needs.deploy-api-server.result }}"
        echo "ì›¹ ì„œë²„: ${{ needs.deploy-web-server.result }}"
