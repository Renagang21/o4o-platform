name: Deploy Main Site (Production V2)

# SSH ì—°ê²° ë¬¸ì œë¥¼ í•´ê²°í•œ ê°œì„ ëœ ë°°í¬ ì›Œí¬í”Œë¡œìš°

on:
  push:
    branches: [main]
    paths:
      - 'apps/main-site/**'
      - 'packages/**'
      - '.github/workflows/deploy-main-site-v2.yml'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force deployment even without changes'
        required: false
        default: 'false'

concurrency:
  group: deploy-main-site-${{ github.ref }}
  cancel-in-progress: false

env:
  SERVICE_NAME: main-site
  SERVICE_DOMAIN: neture.co.kr
  SERVICE_URL: https://neture.co.kr
  DEPLOY_PATH: /var/www/neture.co.kr
  NODE_VERSION: '22.18.0'

jobs:
  # ë‹¨ê³„ 1: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Validate environment
      run: |
        echo "ðŸ” Validating build environment..."
        node --version
        npm --version
        
    - name: Install dependencies
      run: |
        npm ci
        
    - name: Build shared packages
      run: |
        echo "ðŸ“¦ Building shared packages..."
        ./scripts/dev.sh build:packages
        
    - name: Create production environment
      run: |
        cd apps/main-site
        cat > .env.production << 'EOF'
        NODE_ENV=production
        VITE_API_BASE_URL=https://api.neture.co.kr
        VITE_APP_TITLE=O4O Platform
        VITE_ADMIN_URL=https://admin.neture.co.kr
        VITE_SITE_URL=https://neture.co.kr
        VITE_ENABLE_ANALYTICS=true
        VITE_ENABLE_ERROR_REPORTING=true
        VITE_BUILD_TIMESTAMP=${{ github.run_number }}
        EOF
        
    - name: Build application
      run: |
        cd apps/main-site
        npm run build
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: main-site-build
        path: apps/main-site/dist/
        retention-days: 1

  # ë‹¨ê³„ 2: ë°°í¬
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: main-site-build
        path: dist/
        
    # SSH ì„¤ì • ê°œì„  - ë” ì•ˆì •ì ì¸ ì—°ê²°ì„ ìœ„í•´
    - name: Setup SSH with error handling
      run: |
        echo "ðŸ” Setting up SSH connection..."
        
        # SSH ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # SSH í‚¤ ì„¤ì •
        echo "${{ secrets.WEB_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
        # SSH ì„¤ì • íŒŒì¼ ìƒì„±
        cat > ~/.ssh/config << EOF
        Host web-server
          HostName ${{ secrets.WEB_HOST }}
          User ${{ secrets.WEB_USER }}
          Port 22
          IdentityFile ~/.ssh/id_rsa
          StrictHostKeyChecking no
          UserKnownHostsFile=/dev/null
          ServerAliveInterval 60
          ServerAliveCountMax 3
          ConnectTimeout 10
          ConnectionAttempts 3
        EOF
        chmod 600 ~/.ssh/config
        
        echo "âœ… SSH configuration completed"
        
    # SSH ì—°ê²° í…ŒìŠ¤íŠ¸ - ì‹¤íŒ¨ ì‹œ ìž¬ì‹œë„
    - name: Test SSH connection with retries
      run: |
        echo "ðŸ” Testing SSH connection..."
        MAX_ATTEMPTS=5
        ATTEMPT=1
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
          
          if ssh -o ConnectTimeout=10 web-server "echo 'SSH connection successful'"; then
            echo "âœ… SSH connection verified"
            break
          else
            echo "âš ï¸ Connection attempt $ATTEMPT failed"
            ATTEMPT=$((ATTEMPT + 1))
            
            if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
              echo "Waiting 10 seconds before retry..."
              sleep 10
            else
              echo "âŒ All SSH connection attempts failed"
              exit 1
            fi
          fi
        done
        
    # ëŒ€ì²´ ë°°í¬ ë°©ë²• 1: tarë¥¼ ì‚¬ìš©í•œ ë°°í¬
    - name: Deploy using tar archive
      run: |
        echo "ðŸ“¦ Creating deployment archive..."
        tar -czf deploy.tar.gz -C dist .
        
        echo "ðŸ“¤ Uploading to server..."
        scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
          deploy.tar.gz web-server:/tmp/
        
        echo "ðŸ“‚ Extracting on server..."
        ssh web-server << 'ENDSSH'
          # ë°±ì—… ìƒì„±
          if [ -d "${{ env.DEPLOY_PATH }}" ]; then
            sudo mv ${{ env.DEPLOY_PATH }} ${{ env.DEPLOY_PATH }}.backup.$(date +%Y%m%d_%H%M%S)
          fi
          
          # ìƒˆ ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p ${{ env.DEPLOY_PATH }}
          
          # ì••ì¶• í•´ì œ
          sudo tar -xzf /tmp/deploy.tar.gz -C ${{ env.DEPLOY_PATH }}
          
          # ê¶Œí•œ ì„¤ì •
          sudo chown -R www-data:www-data ${{ env.DEPLOY_PATH }}
          sudo chmod -R 755 ${{ env.DEPLOY_PATH }}
          
          # ìž„ì‹œ íŒŒì¼ ì‚­ì œ
          rm /tmp/deploy.tar.gz
          
          echo "âœ… Deployment completed"
        ENDSSH
        
    # ëŒ€ì²´ ë°°í¬ ë°©ë²• 2: rsync with retry
    - name: Deploy using rsync (fallback)
      if: failure()
      run: |
        echo "ðŸ”„ Trying alternative deployment with rsync..."
        
        # rsync with custom options
        MAX_ATTEMPTS=3
        ATTEMPT=1
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "Rsync attempt $ATTEMPT/$MAX_ATTEMPTS..."
          
          if rsync -avz --delete \
            --timeout=30 \
            --contimeout=10 \
            -e "ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10" \
            dist/ web-server:${{ env.DEPLOY_PATH }}/; then
            echo "âœ… Rsync deployment successful"
            break
          else
            echo "âš ï¸ Rsync attempt $ATTEMPT failed"
            ATTEMPT=$((ATTEMPT + 1))
            
            if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
              sleep 5
            else
              echo "âŒ All rsync attempts failed"
              exit 1
            fi
          fi
        done
        
    # ê¶Œí•œ ì„¤ì •
    - name: Set correct permissions
      run: |
        ssh web-server << 'ENDSSH'
          echo "ðŸ”§ Setting permissions..."
          sudo chown -R www-data:www-data ${{ env.DEPLOY_PATH }}
          sudo chmod -R 755 ${{ env.DEPLOY_PATH }}
          echo "âœ… Permissions set"
        ENDSSH
        
    # Nginx ì„¤ì • í™•ì¸ ë° ë¦¬ë¡œë“œ
    - name: Verify and reload Nginx
      run: |
        ssh web-server << 'ENDSSH'
          echo "ðŸ” Checking Nginx configuration..."
          
          # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
          if sudo nginx -t; then
            echo "âœ… Nginx configuration is valid"
            
            # Nginx ë¦¬ë¡œë“œ
            sudo systemctl reload nginx
            echo "âœ… Nginx reloaded"
          else
            echo "âŒ Nginx configuration error"
            exit 1
          fi
        ENDSSH

  # ë‹¨ê³„ 3: í—¬ìŠ¤ì²´í¬
  health-check:
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Wait for deployment
      run: sleep 30
      
    - name: Health check with retries
      run: |
        echo "ðŸ¥ Running health checks..."
        MAX_ATTEMPTS=10
        ATTEMPT=1
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            ${{ env.SERVICE_URL }} || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Site is responding (HTTP $HTTP_STATUS)"
            break
          else
            echo "âš ï¸ Site not ready (HTTP $HTTP_STATUS)"
            ATTEMPT=$((ATTEMPT + 1))
            
            if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
              echo "Waiting 10 seconds..."
              sleep 10
            else
              echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
              exit 1
            fi
          fi
        done
        
    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment..."
        
        # Check main resources
        for RESOURCE in "/" "/assets/index.js" "/assets/index.css"; do
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            ${{ env.SERVICE_URL }}$RESOURCE || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… $RESOURCE: OK (HTTP $HTTP_STATUS)"
          else
            echo "âŒ $RESOURCE: Failed (HTTP $HTTP_STATUS)"
          fi
        done

  # ë‹¨ê³„ 4: ì•Œë¦¼
  notify:
    needs: [deploy, health-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment status
      run: |
        if [ "${{ needs.health-check.result }}" = "success" ]; then
          echo "ðŸŽ‰ Deployment successful!"
          echo "ðŸŒ Site: ${{ env.SERVICE_URL }}"
          echo "ðŸ“… Time: $(date '+%Y-%m-%d %H:%M:%S')"
        else
          echo "âŒ Deployment failed!"
          echo "ðŸ“ Check logs for details"
        fi