name: ğŸš¨ Emergency Server Recovery

on:
  workflow_dispatch:
    inputs:
      server_type:
        description: 'ë³µêµ¬í•  ì„œë²„ ì„ íƒ'
        required: true
        default: 'webserver'
        type: choice
        options:
          - webserver
          - apiserver
          - both
      force_rebuild:
        description: 'ê°•ì œ ì´ë¯¸ì§€ ì¬ë¹Œë“œ'
        required: false
        default: false
        type: boolean

jobs:
  emergency-recovery:
    runs-on: ubuntu-latest
    name: ğŸš‘ Emergency Recovery - ${{ github.event.inputs.server_type }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        
    - name: ğŸŒ Web Server Recovery
      if: github.event.inputs.server_type == 'webserver' || github.event.inputs.server_type == 'both'
      run: |
        ssh-keyscan -H ${{ secrets.WEB_SERVER_HOST }} >> ~/.ssh/known_hosts
        echo "ğŸš‘ Web Server ì‘ê¸‰ ë³µêµ¬ ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.WEB_SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™..."
          cd /home/ubuntu/o4o-platform || { echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ"; exit 1; }
          
          echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ³ í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
          docker ps -a
          
          echo "ğŸ›‘ ê¸°ì¡´ ì›¹ ì„œë¹„ìŠ¤ ì¤‘ì§€..."
          docker-compose -f docker-compose.production.yml stop web-app || true
          docker-compose -f docker-compose.production.yml rm -f web-app || true
          
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "ğŸ”¨ ê°•ì œ ì´ë¯¸ì§€ ì¬ë¹Œë“œ..."
            docker-compose -f docker-compose.production.yml build --no-cache web-app
          fi
          
          echo "ğŸš€ ì›¹ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
          docker-compose -f docker-compose.production.yml up -d web-app
          
          echo "â±ï¸ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° (30ì´ˆ)..."
          sleep 30
          
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰..."
          for i in {1..5}; do
            if curl -f http://localhost/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
              break
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5)"
              sleep 10
            fi
          done
          
          echo "ğŸ“Š ìµœì¢… ìƒíƒœ í™•ì¸..."
          docker ps -f name=o4o-web-prod
          curl -I http://localhost/ || true
          
          echo "âœ… Web Server ë³µêµ¬ ì™„ë£Œ!"
        EOF

    - name: ğŸ”§ API Server Recovery  
      if: github.event.inputs.server_type == 'apiserver' || github.event.inputs.server_type == 'both'
      run: |
        ssh-keyscan -H ${{ secrets.API_SERVER_HOST }} >> ~/.ssh/known_hosts
        echo "ğŸš‘ API Server ì‘ê¸‰ ë³µêµ¬ ì‹œì‘..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.API_SERVER_HOST }} << 'EOF'
          set -e
          
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™..."
          cd /home/ubuntu/o4o-platform || { echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ"; exit 1; }
          
          echo "ğŸ”„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
          git fetch origin
          git reset --hard origin/main
          
          echo "ğŸ³ í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
          docker ps -a
          
          echo "ğŸ›‘ ê¸°ì¡´ API ì„œë¹„ìŠ¤ ì¤‘ì§€..."
          docker-compose -f docker-compose.production.yml stop api-server || true
          docker-compose -f docker-compose.production.yml rm -f api-server || true
          
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "ğŸ”¨ ê°•ì œ ì´ë¯¸ì§€ ì¬ë¹Œë“œ..."
            docker-compose -f docker-compose.production.yml build --no-cache api-server
          fi
          
          echo "ğŸš€ API ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
          docker-compose -f docker-compose.production.yml up -d api-server
          
          echo "â±ï¸ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° (30ì´ˆ)..."
          sleep 30
          
          echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰..."
          for i in {1..5}; do
            if curl -f http://localhost:3000/api/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
              break
            else
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ $i/5)"
              sleep 10
            fi
          done
          
          echo "ğŸ“Š ìµœì¢… ìƒíƒœ í™•ì¸..."
          docker ps -f name=o4o-api-prod
          
          echo "âœ… API Server ë³µêµ¬ ì™„ë£Œ!"
        EOF

    - name: ğŸ“Š Recovery Status Report
      run: |
        echo "ğŸ¯ === ì‘ê¸‰ ë³µêµ¬ ì™„ë£Œ ë³´ê³ ì„œ ==="
        echo "ë³µêµ¬ ëŒ€ìƒ: ${{ github.event.inputs.server_type }}"
        echo "ê°•ì œ ì¬ë¹Œë“œ: ${{ github.event.inputs.force_rebuild }}"
        echo "ì‹¤í–‰ ì‹œê°„: $(date)"
        echo "Git ì»¤ë°‹: ${{ github.sha }}"
        echo ""
        echo "âœ… ë³µêµ¬ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
        echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•˜ë ¤ë©´ ë‹¤ìŒ URLì„ í™•ì¸í•˜ì„¸ìš”:"
        echo "- ë©”ì¸ ì‚¬ì´íŠ¸: https://neture.co.kr"
        echo "- í—¬ìŠ¤ì²´í¬: https://neture.co.kr/health"
        echo "- ì§„ë‹¨ í˜ì´ì§€: https://neture.co.kr/health.html"
        
    - name: ğŸš¨ Notify on Failure
      if: failure()
      run: |
        echo "âŒ === ì‘ê¸‰ ë³µêµ¬ ì‹¤íŒ¨ ==="
        echo "ë³µêµ¬ ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        echo "ìˆ˜ë™ ê°œì…ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
        echo ""
        echo "ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”:"
        echo "1. ì„œë²„ì— ì§ì ‘ SSH ì ‘ì†"
        echo "2. ë¡œê·¸ í™•ì¸: docker logs o4o-web-prod"
        echo "3. ìˆ˜ë™ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
        echo "4. í•„ìš”ì‹œ ì„œë²„ ì¬ë¶€íŒ…"
