name: Deploy O4O Platform

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-api:
    name: Deploy API Server
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to API Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 43.202.242.215
          username: ubuntu
          key: ${{ secrets.API_SERVER_SSH_KEY }}
          script: |
            cd /home/ubuntu/o4o-platform
            git pull origin main
            cd apps/api-server
            npm install
            npm run build
            pm2 restart o4o-api || pm2 start dist/main.js --name o4o-api
            pm2 logs o4o-api --lines 10 --nostream

  deploy-web:
    name: Deploy Admin Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Web Server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: 13.125.144.8
          username: sohae21
          key: ${{ secrets.WEB_SERVER_SSH_KEY }}
          script: |
            cd /home/sohae21/o4o-platform
            git pull origin main
            npm install
            npm run build:admin