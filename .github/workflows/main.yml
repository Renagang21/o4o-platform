name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '22.18.0'

jobs:
  # 1. Code Quality Checks
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        cache-dependency-path: '**/pnpm-lock.yaml'
    
    - name: Complete CI Setup and Build
      run: bash scripts/ci-complete-setup.sh
    
    - name: Run TypeScript check (Frontend only)
      run: pnpm run type-check:frontend
    
    - name: Run ESLint
      run: pnpm run lint
    
    - name: Check for console.log statements
      run: |
        # Find all console.log statements, excluding comments, test files, CLI scripts, config files, and migrations
        CONSOLE_LOGS=$(grep -r "console\.log" apps/ --include="*.ts" --include="*.tsx" \
          --exclude-dir=node_modules --exclude-dir=dist \
          --exclude-dir=test --exclude-dir=e2e \
          --exclude-dir=scripts \
          --exclude="*test*" --exclude="*spec*" \
          --exclude="vite.config.ts" --exclude="*.config.ts" \
          | grep -v "//.*console\.log" \
          | grep -v "^\s*//" \
          | grep -v "\*.*console\.log" \
          | grep -v "database/migrations/" || true)

        if [ -n "$CONSOLE_LOGS" ]; then
          echo "‚ùå Found console.log statements in production code:"
          echo "$CONSOLE_LOGS"
          exit 1
        else
          echo "‚úÖ No console.log statements found in production code"
        fi
    
    - name: Run tests
      run: pnpm test

  # 2. Build all applications
  build:
    name: Build Applications
    runs-on: ubuntu-latest
    needs: quality-check
    
    strategy:
      matrix:
        app: [main-site, admin-dashboard, ecommerce, forum, digital-signage, crowdfunding]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
        cache-dependency-path: '**/pnpm-lock.yaml'
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Build packages
      run: |
        echo "üì¶ Building shared packages..."
        pnpm run build:packages || { echo "‚ùå Package build failed!"; exit 1; }
        echo ""
        echo "‚úÖ Packages built. Verifying dist directories..."

        # Verify critical dist directories exist
        MISSING_DIST=0

        if [ ! -d "packages/auth-client/dist" ]; then
          echo "‚ùå auth-client/dist not found!"
          MISSING_DIST=1
        else
          echo "‚úÖ auth-client/dist exists"
        fi

        if [ ! -d "packages/ui/dist" ]; then
          echo "‚ùå ui/dist not found!"
          MISSING_DIST=1
        else
          echo "‚úÖ ui/dist exists"
        fi

        if [ ! -d "packages/types/dist" ]; then
          echo "‚ùå types/dist not found!"
          MISSING_DIST=1
        else
          echo "‚úÖ types/dist exists"
        fi

        if [ ! -d "packages/shortcodes/dist" ]; then
          echo "‚ùå shortcodes/dist not found!"
          MISSING_DIST=1
        else
          echo "‚úÖ shortcodes/dist exists"
          ls -la packages/shortcodes/dist/
        fi

        if [ $MISSING_DIST -eq 1 ]; then
          echo "‚ùå Some dist directories are missing. Cannot proceed with app builds."
          exit 1
        fi

        echo ""
        echo "üîç Verifying shortcodes package.json..."
        cat packages/shortcodes/package.json | grep -A10 '"main"'

    - name: Build ${{ matrix.app }}
      run: bash scripts/ci-build-app.sh ${{ matrix.app }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.app }}-dist
        path: |
          apps/${{ matrix.app }}/dist
          apps/${{ matrix.app }}/build
        retention-days: 7

