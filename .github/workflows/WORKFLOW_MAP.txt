╔══════════════════════════════════════════════════════════════════════════════╗
║                    O4O PLATFORM - GITHUB ACTIONS WORKFLOWS                   ║
║                          Analysis & Reorganization Map                        ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│ CURRENT STRUCTURE (9 workflows, 949 lines)                                   │
└──────────────────────────────────────────────────────────────────────────────┘

.github/workflows/
├─ CI/CD CORE
│  ├─ main.yml (155L)              ⚙️  Quality checks, tests, builds
│  │  └─ Triggers: push(main/dev), PR, manual
│  │     ⚠️  ISSUE: No concurrency control
│  │
│  └─ codeql.yml (44L)             🔒 Security analysis
│     └─ Triggers: push, PR, weekly schedule
│
├─ DEPLOYMENT
│  ├─ deploy-admin.yml (212L)     📦 Admin Dashboard → Web Server
│  │  └─ Triggers: push(admin/**), manual
│  │     ⚠️  ISSUE: Inconsistent build order (missing slide-app)
│  │
│  ├─ deploy-api.yml (136L)       🖥️  API Server → API Server
│  │  └─ Triggers: push(api/**), manual
│  │     🔴 CRITICAL: SSH connection failures (documented as disabled)
│  │
│  ├─ deploy-main-site.yml (134L) 🌐 Main Site → Web Server
│  │  └─ Triggers: push(main-site/**), manual
│  │
│  └─ deploy-nginx.yml (89L)      🔧 Nginx Configs → Web Server
│     └─ Triggers: push(nginx-configs/**)
│
├─ AUTOMATION
│  ├─ pr-size-labeler.yml (71L)   🏷️  Auto-label PRs by size
│  │  └─ Triggers: PR opened/sync
│  │
│  └─ setup-labels.yml (72L)      🎨 Setup repository labels
│     └─ Triggers: manual, push(labeler.yml)
│
└─ SETUP/SHARED
   └─ setup-pnpm.yml (36L)        📦 Node+pnpm setup (REUSABLE)
      └─ Triggers: workflow_call
         ⚠️  ISSUE: Created but NEVER USED - code duplication instead


┌──────────────────────────────────────────────────────────────────────────────┐
│ PROPOSED STRUCTURE (11 workflows, ~800 lines)                                │
└──────────────────────────────────────────────────────────────────────────────┘

.github/workflows/
├─ ci/
│  ├─ main.yml                    ⚙️  Quality checks, tests, builds
│  │  └─ ✅ Fixed: Concurrency control added
│  │
│  └─ security.yml                🔒 Security analysis (renamed from codeql.yml)
│
├─ deploy/
│  ├─ admin.yml                   📦 Admin Dashboard
│  │  └─ ✅ Fixed: Uses build:packages script
│  │
│  ├─ api.yml                     🖥️  API Server
│  │  └─ 🔄 Fixed: Disabled with clear docs OR SSH retry logic
│  │
│  ├─ main-site.yml               🌐 Main Site
│  │  └─ ✅ Uses build:packages
│  │
│  └─ nginx.yml                   🔧 Nginx Configs
│
├─ automation/
│  ├─ pr-labeler.yml              🏷️  Auto-label PRs (renamed)
│  └─ repo-setup.yml              🎨 Setup labels (renamed)
│
├─ shared/
│  ├─ setup-node-pnpm.yml         📦 Node+pnpm (ACTUALLY USED NOW)
│  │  └─ ✅ Called by all workflows
│  │
│  └─ build-packages.yml          🔨 Package build (NEW)
│     └─ ✅ Ensures correct order, verifies dist
│
└─ README.md (CONSOLIDATED)       📖 Merged from 2 files


┌──────────────────────────────────────────────────────────────────────────────┐
│ CRITICAL ISSUES IDENTIFIED                                                    │
└──────────────────────────────────────────────────────────────────────────────┘

🔴 P1: Inconsistent Package Build Order
    File: deploy-admin.yml (lines 52-63)
    Problem: Lists individual commands, missing build:slide-app
    Impact: Build failures, missing dependencies
    Fix: Use "pnpm run build:packages" (1 line instead of 11)
    Effort: 1 day

🔴 P2: API Deployment SSH Failures
    File: deploy-api.yml
    Problem: SSH timeouts prevent automated deployment
    Impact: Manual deployment required, workflow doesn't work
    Fix: Disable (if: false) OR add retry logic
    Effort: 1-2 days

🔴 P3: No Concurrency Control in CI
    File: main.yml
    Problem: Multiple simultaneous CI runs waste resources
    Impact: Higher costs, potential cache conflicts
    Fix: Add concurrency group with cancel-in-progress
    Effort: 1 day

🟡 P4: Unused Reusable Workflow
    File: setup-pnpm.yml
    Problem: Created but never used, setup duplicated 4x
    Impact: Code duplication (~240 lines), maintenance burden
    Fix: Update workflow, use in all other workflows
    Effort: 3-4 days

🟡 P5: Hardcoded Environment Variables
    Files: deploy-admin.yml, deploy-main-site.yml
    Problem: API URLs hardcoded in workflow
    Impact: Security risk, inflexibility
    Fix: Move to GitHub Secrets
    Effort: 2 days


┌──────────────────────────────────────────────────────────────────────────────┐
│ BUILD PROCESS FLOW                                                            │
└──────────────────────────────────────────────────────────────────────────────┘

Correct Package Build Order (from package.json):
┌───────────────────────────────────────────────────────────────────────┐
│ 1. types          (no deps)                                           │
│      ↓                                                                 │
│ 2. auth-client    (depends: types)                                    │
│      ↓                                                                 │
│ 3. utils          (depends: types)                                    │
│      ↓                                                                 │
│ 4. ui             (depends: types, utils)                             │
│      ↓                                                                 │
│ 5. auth-context   (depends: auth-client)                              │
│      ↓                                                                 │
│ 6. shortcodes     (depends: types, utils)                             │
│      ↓                                                                 │
│ 7. block-renderer (depends: shortcodes)                               │
│      ↓                                                                 │
│ 8. slide-app      (depends: ui, auth-context, block-renderer)         │
│                                                                        │
│ ⚠️  deploy-admin.yml MISSING step 8 (slide-app)!                      │
└───────────────────────────────────────────────────────────────────────┘

Package.json Script (CORRECT):
  "build:packages": "pnpm run build:types && pnpm run build:auth-client && ..."

Deploy-admin.yml (WRONG):
  Manually lists steps 1-7, missing step 8


┌──────────────────────────────────────────────────────────────────────────────┐
│ CODE DUPLICATION ANALYSIS                                                     │
└──────────────────────────────────────────────────────────────────────────────┘

Setup Logic Duplicated 4 Times:
┌────────────────────────────────────────────────────────────────┐
│ deploy-admin.yml      (lines 36-50)   ~60 lines               │
│ deploy-api.yml        (lines 33-45)   ~60 lines               │
│ deploy-main-site.yml  (lines 27-34)   ~60 lines               │
│ main.yml              (lines 22-35)   ~60 lines               │
│                                                                │
│ Total Duplication: ~240 lines                                 │
│                                                                │
│ Exists as Reusable: setup-pnpm.yml    BUT NOT USED ❌         │
└────────────────────────────────────────────────────────────────┘

After Reorganization:
┌────────────────────────────────────────────────────────────────┐
│ shared/setup-node-pnpm.yml (36 lines)                          │
│   ↑                                                            │
│   ├─ called by: deploy/admin.yml                              │
│   ├─ called by: deploy/api.yml                                │
│   ├─ called by: deploy/main-site.yml                          │
│   └─ called by: ci/main.yml                                   │
│                                                                │
│ Total Duplication: 0 lines ✅                                  │
│ Savings: ~200 lines                                           │
└────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────┐
│ IMPLEMENTATION PHASES                                                         │
└──────────────────────────────────────────────────────────────────────────────┘

PHASE 1: CRITICAL FIXES (2-3 days) 🔴 DO FIRST
├─ ✅ Fix deploy-admin.yml build order
├─ ✅ Disable or fix deploy-api.yml SSH
└─ ✅ Add concurrency to main.yml
   └─ Outcome: Immediate reliability improvement

PHASE 2: REUSABLE WORKFLOWS (3-4 days) 🟡 HIGH VALUE
├─ ✅ Create shared/build-packages.yml
├─ ✅ Update shared/setup-node-pnpm.yml
├─ ✅ Update all workflows to use reusable components
└─ ✅ Consolidate documentation
   └─ Outcome: Reduce duplication by ~200 lines

PHASE 3: REORGANIZATION (3-4 days) 🟢 NICE TO HAVE
├─ ✅ Create ci/, deploy/, automation/, shared/ directories
├─ ✅ Move all workflows to new locations
├─ ✅ Move env vars to GitHub Secrets
└─ ✅ Update and consolidate docs
   └─ Outcome: Better organization, improved security


┌──────────────────────────────────────────────────────────────────────────────┐
│ METRICS                                                                       │
└──────────────────────────────────────────────────────────────────────────────┘

                            BEFORE   │  AFTER P1  │  AFTER P2  │  AFTER P3
────────────────────────────────────┼────────────┼────────────┼─────────────
Total Workflows                  9  │      9     │     11     │     11
Total Lines                    949  │    ~940    │    ~850    │    ~800
Code Duplication           240 lines│  240 lines │      0     │      0
Unused Workflows                 1  │      0     │      0     │      0
Hardcoded Env Vars               2  │      2     │      2     │      0
Concurrency Control            4/9  │     5/9    │     5/9    │     9/9
Build Order Consistency         ❌  │     ✅     │     ✅     │     ✅
Deployment Success Rate        85%  │    ~95%    │    ~95%    │    ~98%


┌──────────────────────────────────────────────────────────────────────────────┐
│ QUICK COMMANDS                                                                │
└──────────────────────────────────────────────────────────────────────────────┘

View Workflow Status:
  gh workflow list
  gh workflow view "Deploy Admin Dashboard"
  gh run watch

Manual Deployment:
  ./scripts/deploy-admin-manual.sh     # Admin dashboard
  ./scripts/deploy-api-local.sh        # API server
  ssh o4o-web && ./scripts/deploy-main-site.sh  # Main site

Verify Deployment:
  curl -s https://admin.neture.co.kr/version.json | jq
  curl -s https://neture.co.kr/version.json | jq
  curl -s https://api.neture.co.kr/api/health | jq

Trigger Workflow Manually:
  gh workflow run deploy-admin.yml


┌──────────────────────────────────────────────────────────────────────────────┐
│ DOCUMENTATION FILES                                                           │
└──────────────────────────────────────────────────────────────────────────────┘

📄 INDEX.md                   - Navigation guide (this file)
📄 EXECUTIVE_SUMMARY.md       - High-level overview (415 lines)
📄 ANALYSIS_REPORT.md         - Detailed technical analysis (986 lines)
📄 REORGANIZATION_PLAN.md     - Step-by-step implementation (646 lines)
📄 README.md                  - Current workflow docs (94 lines, Korean)
📄 README-CI-CD.md            - Current CI/CD guide (105 lines, Korean)


┌──────────────────────────────────────────────────────────────────────────────┐
│ RECOMMENDATION                                                                │
└──────────────────────────────────────────────────────────────────────────────┘

✅ IMMEDIATE ACTION: Implement Phase 1 (Critical Fixes) - 2-3 days
   - High impact, low risk
   - Fixes immediate reliability issues
   - Can stop here if time-constrained

🔄 MEDIUM TERM: Implement Phase 2 (Reusable Workflows) - 3-4 days
   - Significant maintenance improvement
   - Reduces duplication by ~200 lines
   - Better code organization

📈 LONG TERM: Implement Phase 3 (Reorganization) - 3-4 days
   - Better developer experience
   - Improved security
   - Clearer structure

TOTAL EFFORT: 2-3 weeks for complete reorganization
ROI: High - Pays off within 1-2 months through easier maintenance


╔══════════════════════════════════════════════════════════════════════════════╗
║                         END OF WORKFLOW MAP                                   ║
║                   For details, see: EXECUTIVE_SUMMARY.md                      ║
╚══════════════════════════════════════════════════════════════════════════════╝
