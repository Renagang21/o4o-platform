name: Deploy Neture Web (Cloud Run)

# Deploy Neture B2C Web to Cloud Run
# Phase G-1: neture.co.kr ë°°í¬

concurrency:
  group: deploy-neture-web-${{ github.ref }}
  cancel-in-progress: false

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/neture-web/**'
      - 'packages/**'
      - '.github/workflows/deploy-neture-web.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment'
        required: false
        default: 'false'

env:
  PROJECT_ID: netureyoutube
  REGION: asia-northeast3
  REPOSITORY_NAME: o4o-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
      with:
        node-version: '22.18.0'

    - name: Build neture-web
      run: |
        echo "ğŸ”¨ Building neture-web..."
        cd apps/neture-web

        # Run prebuild to generate version.json
        pnpm run prebuild

        # Build with production settings
        NODE_ENV=production \
        NODE_OPTIONS='--max-old-space-size=4096' \
        VITE_API_BASE_URL=https://api.neture.co.kr \
        pnpm run build:prod

        # Ensure version.json is in dist/
        if [ ! -f dist/version.json ] && [ -f public/version.json ]; then
          echo "ğŸ“‹ Copying version.json to dist..."
          cp public/version.json dist/version.json
        fi

        echo "ğŸ“‹ Build output:"
        ls -lh dist/

        echo "ğŸ“„ Version info:"
        cat dist/version.json

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v3
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build and Push Docker image
      run: |
        cd apps/neture-web

        IMAGE_TAG="${{ github.sha }}"
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/neture-web:${IMAGE_TAG}"
        LATEST_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/neture-web:latest"

        echo "ğŸ³ Building Docker image..."

        # Create production Dockerfile for pre-built assets
        cat > Dockerfile.cloudrun << 'EOF'
        FROM nginx:alpine

        # Copy pre-built assets
        COPY dist /usr/share/nginx/html

        # Nginx config for SPA routing
        RUN echo 'server { \
            listen 8080; \
            server_name _; \
            root /usr/share/nginx/html; \
            index index.html; \
            gzip on; \
            gzip_types text/plain text/css application/json application/javascript text/xml application/xml; \
            location / { \
                try_files $uri $uri/ /index.html; \
            } \
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ { \
                expires 1y; \
                add_header Cache-Control "public, immutable"; \
            } \
        }' > /etc/nginx/conf.d/default.conf

        EXPOSE 8080
        CMD ["nginx", "-g", "daemon off;"]
        EOF

        docker build \
          --platform linux/amd64 \
          --tag "${FULL_IMAGE}" \
          --tag "${LATEST_IMAGE}" \
          --file Dockerfile.cloudrun \
          .

        echo "ğŸ“¤ Pushing to Artifact Registry..."
        docker push "${FULL_IMAGE}"
        docker push "${LATEST_IMAGE}"

        echo "âœ… Image pushed: ${FULL_IMAGE}"
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

    - name: Deploy to Cloud Run
      run: |
        FULL_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/neture-web:${{ env.IMAGE_TAG }}"

        echo "ğŸš€ Deploying to Cloud Run..."

        gcloud run deploy neture-web \
          --image="${FULL_IMAGE}" \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --platform=managed \
          --allow-unauthenticated \
          --port=8080 \
          --memory=256Mi \
          --cpu=1 \
          --min-instances=0 \
          --max-instances=5 \
          --concurrency=80 \
          --timeout=60

    - name: Verify deployment
      run: |
        echo "ğŸ” Verifying deployment..."

        SERVICE_URL=$(gcloud run services describe neture-web \
          --region=${{ env.REGION }} \
          --project=${{ env.PROJECT_ID }} \
          --format="value(status.url)")

        echo "ğŸŒ Service URL: ${SERVICE_URL}"

        # Health check
        for i in {1..3}; do
          echo "Health check attempt $i..."
          if curl -sf "${SERVICE_URL}/" > /dev/null; then
            echo "âœ… Health check passed!"
            break
          fi
          if [ $i -eq 3 ]; then
            echo "âš ï¸ Health check did not succeed, but deployment completed"
          fi
          sleep 5
        done

        echo ""
        echo "=========================================="
        echo "âœ… Neture Web Deployed Successfully!"
        echo "=========================================="
        echo "ğŸŒ Cloud Run URL: ${SERVICE_URL}"
        echo "ğŸ“… Time: $(date)"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo ""
        echo "âš ï¸ Note: Domain mapping required for https://neture.co.kr"
