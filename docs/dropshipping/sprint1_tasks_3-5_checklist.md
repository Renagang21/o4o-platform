# Sprint 1 잔여 작업 체크리스트 (Task 3-5)

**작업 기간**: 2025-11-07 ~
**담당자**: Dev Team
**상태**: 🟡 준비 중

---

## 📋 0. 사전 동기화 및 안전장치 (필수)

### 동기화 체크
- [ ] 최신 main 브랜치 pull 완료
- [ ] `pnpm install` 완료
- [ ] 로컬 빌드 정상 (`pnpm run build`)

### DB 백업 체크
- [ ] 프로덕션 DB 최신 백업 확인 (백업 시각: _____________)
- [ ] 스테이징 DB 백업 확인
- [ ] 롤백 절차 문서 확인

### Feature Flag 초기값 점검
- [ ] `ENABLE_PARTNER_SETTLEMENT=false` 설정 확인
- [ ] `USE_REDIS_RATE_LIMIT` 현행 유지 확인
- [ ] 환경변수 파일 위치: `.env.production`, `.env.staging`

### 상태 로그
```
날짜: _____________
담당: _____________
결과: ✅ 동기화 완료 / ✅ 백업 확인 / ✅ 플래그 확인
```

---

## 📋 1. Task 3 — 파트너 정산 로직 활성화

### 1.1 주문 스키마 점검
- [ ] Order 엔티티에 `partnerId` 필드 존재 여부 확인
- [ ] Order 엔티티에 `partnerName` 필드 존재 여부 확인
- [ ] Order 엔티티에 `referralCode` 필드 존재 여부 확인
- [ ] 필드 누락 시 마이그레이션 파일 작성

**마이그레이션 파일 (필요 시)**:
```
파일명: apps/api-server/migrations/YYYYMMDD_add_partner_fields_to_orders.sql
작성일: _____________
```

### 1.2 정산 로직 구현
- [ ] `PaymentService.calculatePartnerSettlement()` 메서드 구현
- [ ] 정산 보류 기간 환경변수화 (`SETTLEMENT_HOLD_DAYS`, 기본값: 7)
- [ ] Feature Flag 분기 구현 (`ENABLE_PARTNER_SETTLEMENT`)
- [ ] 정산 금액 계산 로직 검증 (수수료율 적용)

### 1.3 테스트 케이스

#### 테스트 주문 1: 파트너 有 + 수수료 有
- [ ] 입력: 주문금액 100,000원, 파트너 수수료 10%
- [ ] 기대: 파트너 정산 10,000원, 플랫폼 수익 90,000원
- [ ] 실측: _____________
- [ ] 정산 스케줄: 주문일 + 7일 = _____________

#### 테스트 주문 2: 파트너 無
- [ ] 입력: 주문금액 100,000원
- [ ] 기대: 파트너 정산 0원, 플랫폼 수익 100,000원
- [ ] 실측: _____________

#### 테스트 주문 3: 수수료 無 (수수료율 0%)
- [ ] 입력: 주문금액 100,000원, 파트너 수수료 0%
- [ ] 기대: 파트너 정산 0원, 플랫폼 수익 100,000원
- [ ] 실측: _____________

### 1.4 검증 결과
- [ ] 정산 금액 오차 0건 확인
- [ ] 음수 정산 금액 0건 확인
- [ ] 과소/과대 분배 0건 확인

### 1.5 산출물
- [ ] 정산 미리보기 캡처 저장 (경로: `docs/dropshipping/screenshots/settlement_preview.png`)
- [ ] 테스트 케이스 표 작성 완료 (상기 표 작성)
- [ ] 체크리스트 승인 서명: _____________

---

## 📋 2. Task 4 — 웹훅 서명 보안 강화

### 2.1 타이밍-세이프 서명 비교
- [ ] `crypto.timingSafeEqual()` 적용
- [ ] 기존 `===` 비교 제거
- [ ] 서명 길이 불일치 처리 추가

### 2.2 타임스탬프 검증
- [ ] 웹훅 타임스탬프 파싱 구현
- [ ] Clock skew 허용치 환경변수화 (`WEBHOOK_CLOCK_SKEW_SECONDS`, 기본값: 300)
- [ ] 스큐 초과 시 403 응답 반환

### 2.3 에러 로깅 개선
- [ ] 서명 불일치 로그 레벨: `warn`
- [ ] 스큐 초과 로그 레벨: `warn`
- [ ] 헤더 누락 로그 레벨: `error`
- [ ] 민감정보 마스킹 확인 (서명 원문, IP 등)

### 2.4 보안 테스트

#### 시나리오 1: 정상 요청
- [ ] 유효한 서명 + 타임스탬프 → 200 OK
- [ ] 실행 결과: _____________

#### 시나리오 2: 서명 불일치
- [ ] 잘못된 서명 → 401 Unauthorized
- [ ] 로그 확인: "Webhook signature mismatch"
- [ ] 실행 결과: _____________

#### 시나리오 3: 타임스탬프 스큐 초과
- [ ] 현재 시각 - 400초 과거 타임스탬프 → 403 Forbidden
- [ ] 로그 확인: "Webhook timestamp skew exceeded"
- [ ] 실행 결과: _____________

#### 시나리오 4: 헤더 누락
- [ ] `X-Webhook-Signature` 헤더 없음 → 400 Bad Request
- [ ] 로그 확인: "Missing webhook signature header"
- [ ] 실행 결과: _____________

### 2.5 산출물
- [ ] 보안 테스트 시나리오 결과 표 작성 완료 (상기 표 작성)
- [ ] 운영 로깅 샘플 캡처 저장 (경로: `docs/dropshipping/screenshots/webhook_logs.png`)
- [ ] 개인정보 마스킹 확인 완료

---

## 📋 3. Task 5 — 크리티컬 인덱스 적용

### 3.1 인덱스 설계

#### 배치 트리거용 인덱스
- [ ] `idx_partner_commissions_pending_payout` 생성
  - 컬럼: `(status, scheduledPayoutDate)`
  - WHERE: `status = 'approved' AND scheduledPayoutDate <= CURRENT_DATE`

#### 멱등성 체크용 인덱스
- [ ] `idx_orders_unique_idempotency` 생성
  - 컬럼: `(idempotencyKey, createdAt)`
  - UNIQUE 제약

#### 클릭 중복 방지용 인덱스
- [ ] `idx_referral_clicks_dedup` 생성
  - 컬럼: `(referralCode, ip, clickedAt)`
  - WHERE: `clickedAt >= NOW() - INTERVAL '24 hours'`

### 3.2 마이그레이션 파일 작성
- [ ] 파일 생성: `apps/api-server/migrations/YYYYMMDD_add_critical_indexes.sql`
- [ ] 작성일: _____________
- [ ] Staging 적용 전 dry-run 테스트

### 3.3 실행 계획 비교

#### 배치 트리거 쿼리
**쿼리**:
```sql
SELECT * FROM partner_commissions
WHERE status = 'approved' AND scheduledPayoutDate <= CURRENT_DATE
LIMIT 100;
```

- [ ] **적용 전** 실행계획 캡처
  - Scan Type: _____________
  - Cost: _____________
  - Rows: _____________

- [ ] **적용 후** 실행계획 캡처
  - Scan Type: _____________
  - Cost: _____________
  - Rows: _____________

- [ ] 성능 개선: _______ 배

#### 멱등성 체크 쿼리
**쿼리**:
```sql
SELECT id FROM orders WHERE idempotencyKey = 'test-key-123' LIMIT 1;
```

- [ ] **적용 전** 실행계획 캡처
- [ ] **적용 후** 실행계획 캡처
- [ ] 성능 개선: _______ 배

#### 클릭 중복 체크 쿼리
**쿼리**:
```sql
SELECT id FROM referral_clicks
WHERE referralCode = 'REF123' AND ip = '1.2.3.4'
  AND clickedAt >= NOW() - INTERVAL '24 hours';
```

- [ ] **적용 전** 실행계획 캡처
- [ ] **적용 후** 실행계획 캡처
- [ ] 성능 개선: _______ 배

### 3.4 슬로우 쿼리 점검
- [ ] 슬로우 쿼리 로그 임계치 설정 확인 (1초)
- [ ] 적용 후 24시간 슬로우 쿼리 0건 확인
- [ ] 확인 날짜: _____________

### 3.5 산출물
- [ ] 전/후 실행계획 비교 캡처 3세트 저장
- [ ] 성능 수치 표 작성:

| 쿼리 유형 | 적용 전 (ms) | 적용 후 (ms) | 개선 배수 |
|-----------|--------------|--------------|-----------|
| 배치 트리거 | _________ | _________ | _____x |
| 멱등성 체크 | _________ | _________ | _____x |
| 클릭 중복 체크 | _________ | _________ | _____x |

- [ ] P95 레이턴시: _________ ms

---

## 📋 4. 스테이징 배포 및 모니터링

### 4.1 스테이징 배포
- [ ] 코드 배포 완료
- [ ] DB 마이그레이션 실행 (인덱스, Order 필드)
- [ ] 환경변수 설정:
  - `ENABLE_PARTNER_SETTLEMENT=false` (초기)
  - `SETTLEMENT_HOLD_DAYS=7`
  - `WEBHOOK_CLOCK_SKEW_SECONDS=300`

### 4.2 샘플 검증 (정산 플래그 OFF)
- [ ] 샘플 주문 3건 생성 (파트너 有/無)
- [ ] 웹훅 수신 정상 확인
- [ ] 정산 로직 미실행 확인 (플래그 OFF)

### 4.3 정산 플래그 활성화 (ON)
- [ ] `ENABLE_PARTNER_SETTLEMENT=true` 설정
- [ ] 애플리케이션 재시작
- [ ] 샘플 주문으로 정산 생성 확인
- [ ] 정산 금액 정확성 검증

### 4.4 24시간 모니터링

#### 모니터링 지표
- [ ] 에러율: _________ % (목표: < 0.1%)
- [ ] 웹훅 실패율: _________ % (목표: < 5%)
- [ ] P95 레이턴시: _________ ms (목표: < 200ms)
- [ ] 배치 처리량: _________ 건/분 (목표: 정상 완료)
- [ ] 정산 금액 오류: _________ 건 (목표: 0건)

#### 모니터링 기간
- 시작: _____________
- 종료: _____________
- 담당: _____________

### 4.5 산출물
- [ ] 24시간 대시보드 스냅샷 저장 (경로: `docs/dropshipping/screenshots/staging_monitoring_24h.png`)
- [ ] 이상 징후 보고:
```
1. _____________
2. _____________
3. _____________ (이상 없음 포함)
```

---

## 📋 5. 프로덕션 반영 (저부하 시간대)

### 5.1 사전 준비
- [ ] 프로덕션 DB 최종 백업 확인 (백업 시각: _____________)
- [ ] 롤백 스크립트 준비 완료
- [ ] 반영 시간대 확인: _____________ (저부하 시간대)
- [ ] On-call 담당자 대기 확인

### 5.2 순차 반영
- [ ] 코드 배포 완료
- [ ] DB 마이그레이션 실행
- [ ] 헬스 체크 정상 확인 (`/health`)
- [ ] 스모크 테스트 통과 (주문 생성, 조회, 정산 조회)

### 5.3 정산 플래그 점진 활성화

#### 10% 트래픽
- [ ] `ENABLE_PARTNER_SETTLEMENT=true` + 트래픽 10% 라우팅
- [ ] 모니터링 30분:
  - 에러율: _________ %
  - 웹훅 실패율: _________ %
  - P95: _________ ms
- [ ] 이상 없음 확인

#### 50% 트래픽
- [ ] 트래픽 50% 라우팅
- [ ] 모니터링 1시간:
  - 에러율: _________ %
  - 웹훅 실패율: _________ %
  - P95: _________ ms
- [ ] 이상 없음 확인

#### 100% 트래픽
- [ ] 트래픽 100% 전환
- [ ] 모니터링 2시간:
  - 에러율: _________ %
  - 웹훅 실패율: _________ %
  - P95: _________ ms
- [ ] 이상 없음 확인

### 5.4 검증 결과
- [ ] 고객 트래픽 지연 제로
- [ ] 고객 오류 제로
- [ ] 정산 금액 오류 제로

### 5.5 산출물

#### 단계별 전환 로그
| 단계 | 시간 | 트래픽 비율 | 에러율 | P95 | 상태 |
|------|------|-------------|--------|-----|------|
| 10%  | _______ | 10% | _____% | ___ms | ✅ |
| 50%  | _______ | 50% | _____% | ___ms | ✅ |
| 100% | _______ | 100% | _____% | ___ms | ✅ |

#### 완료 리포트 (5줄 요약)
```
1. 배포 완료 시각: _____________
2. 최종 지표: 에러율 _____%, P95 _____ms
3. 정산 건수: _____ 건, 금액 정확도: 100%
4. 이상 징후: _____________
5. 승인자: _____________
```

---

## 📋 6. 롤백 및 플래그 전략

### 롤백 1단계: 정산 플래그 OFF (즉시 효과)
- [ ] `ENABLE_PARTNER_SETTLEMENT=false` 설정
- [ ] 애플리케이션 재시작 (무중단 배포)
- [ ] 헬스 체크 정상 확인
- [ ] 롤백 완료 시각: _____________

### 롤백 2단계: 인덱스/스키마 롤백 (필요 시)
- [ ] 인덱스 DROP 마이그레이션 실행
- [ ] Order 필드 제거 마이그레이션 실행
- [ ] 데이터 정합성 확인
- [ ] 롤백 완료 시각: _____________

### 롤백 3단계: 이전 태그로 배포 (최후 수단)
- [ ] Git 태그 확인: _____________
- [ ] 이전 버전 배포 실행
- [ ] 전체 시스템 헬스 체크
- [ ] 롤백 완료 시각: _____________

### 롤백 완료 기준
- [ ] 헬스 체크 정상
- [ ] 스모크 테스트 통과
- [ ] 지표 정상 범위 복귀
- [ ] 원인 분석 메모 (3줄):
```
1. _____________
2. _____________
3. _____________
```

---

## 📋 7. Definition of Done (DoD)

### 테스트
- [ ] 단위 테스트 전부 통과 (`pnpm run test:unit`)
- [ ] 통합 테스트 전부 통과 (`pnpm run test:integration`)
- [ ] E2E 테스트 통과 (정산, 웹훅)

### 성능 증빙
- [ ] 전/후 실행계획 캡처 3세트 보관
- [ ] 성능 수치 표 작성 완료
- [ ] 슬로우 쿼리 0건 확인

### 배포 검증
- [ ] 스테이징 24시간 무이슈
- [ ] 프로덕션 점진 배포 완료
- [ ] 모니터링 지표 정상 범위 유지

### 문서화
- [ ] 체크리스트 전체 항목 완료
- [ ] 스크린샷 및 로그 저장 완료
- [ ] 최종 보고서 작성 (10줄 이내):

```
=== Sprint 1 잔여 작업 (Task 3-5) 최종 보고 ===

1. 작업 기간: _____________ ~ _____________
2. 완료 항목: Task 3 (정산), Task 4 (웹훅), Task 5 (인덱스)
3. 테스트 결과: 단위/통합/E2E 전부 통과
4. 성능 개선: 배치 _____배, 멱등성 _____배, 클릭 _____배
5. 스테이징 모니터링: 24h 무이슈, 에러율 _____%, P95 _____ms
6. 프로덕션 배포: 점진 배포 완료, 트래픽 100% 전환 성공
7. 정산 정확도: 100%, 오류 0건
8. 이상 징후: _____________
9. 승인자: _____________
10. 체크리스트: docs/dropshipping/sprint1_tasks_3-5_checklist.md

서명: _____________ / 날짜: _____________
```

---

## ✅ 전체 진행 상태

| Task | 상태 | 완료일 | 담당자 | 비고 |
|------|------|--------|--------|------|
| Task 0: 사전 동기화 | ⬜ 대기 | _______ | _______ | - |
| Task 3: 정산 로직 | ⬜ 대기 | _______ | _______ | - |
| Task 4: 웹훅 보안 | ⬜ 대기 | _______ | _______ | - |
| Task 5: 인덱스 적용 | ⬜ 대기 | _______ | _______ | - |
| Task 6: 스테이징 배포 | ⬜ 대기 | _______ | _______ | - |
| Task 7: 프로덕션 배포 | ⬜ 대기 | _______ | _______ | - |

**최종 승인**: _____________ / 날짜: _____________

---

**문서 버전**: 1.0
**작성일**: 2025-11-07
**작성자**: Claude Code (Sprint 1 Planner)
