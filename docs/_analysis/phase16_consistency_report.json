{
  "report_id": "phase16_consistency_report",
  "report_title": "Phase 16: Architecture ↔ Code Consistency Audit (2nd Pass)",
  "report_date": "2025-12-10",
  "document_base": "Phase 14 Updated Architecture Documents",
  "audit_scope": "Design docs vs Implementation alignment analysis (NO code modifications)",

  "executive_summary": {
    "overall_alignment_score": 48,
    "status": "SIGNIFICANT_GAPS_IDENTIFIED",
    "total_gaps_found": 19,
    "high_priority": 9,
    "medium_priority": 7,
    "low_priority": 3
  },

  "area_scores": {
    "module_loader_appmanager": {
      "score": 95,
      "status": "EXCELLENT",
      "summary": "Best aligned area. Clear separation of responsibilities."
    },
    "multi_tenancy": {
      "score": 45,
      "status": "PARTIAL",
      "summary": "Infrastructure exists (organizationId, TenantMiddleware) but not wired."
    },
    "sellerops_specs": {
      "score": 40,
      "status": "FIELD_MISMATCHES",
      "summary": "Multiple entity field name mismatches causing runtime issues."
    },
    "view_system": {
      "score": 35,
      "status": "SKELETON_NOT_INTEGRATED",
      "summary": "Components implemented but not connected to app activation flow."
    },
    "cms_core": {
      "score": 23,
      "status": "PHILOSOPHY_MISMATCH",
      "summary": "Docs describe WordPress-style; implementation is generic framework."
    },
    "partnerops_specs": {
      "score": 20,
      "status": "SKELETON_ONLY",
      "summary": "Stub implementations, missing documented features."
    }
  },

  "high_priority_issues": [
    {
      "id": "HP-001",
      "area": "SellerOps",
      "issue": "supplyPrice vs supplierPrice field mismatch",
      "impact": "OrderOpsService queries fail or return wrong data",
      "file": "packages/sellerops/src/services/OrderOpsService.ts:107"
    },
    {
      "id": "HP-002",
      "area": "SellerOps",
      "issue": "isActive (boolean) vs status (enum) type mismatch",
      "impact": "Product filtering logic broken",
      "file": "packages/dropshipping-core/src/entities/SupplierProductOffer.entity.ts"
    },
    {
      "id": "HP-003",
      "area": "SellerOps",
      "issue": "SettlementBatch missing sellerId and netAmount fields",
      "impact": "Settlement report queries broken",
      "file": "packages/sellerops/src/services/SettlementOpsService.ts"
    },
    {
      "id": "HP-004",
      "area": "View System",
      "issue": "ViewRegistry not integrated with AppManager activation",
      "impact": "App views not registered during lifecycle",
      "file": "packages/cms-core/src/view/ViewRegistry.ts"
    },
    {
      "id": "HP-005",
      "area": "View System",
      "issue": "Only 1 of 20+ apps uses viewTemplates",
      "impact": "View System effectively unused",
      "affected": "All apps except forum-app"
    },
    {
      "id": "HP-006",
      "area": "Multi-Tenancy",
      "issue": "TenantMiddleware not registered in AppModule",
      "impact": "No tenant context injection at runtime",
      "file": "apps/api-server/src/middleware/tenant-context.middleware.ts"
    },
    {
      "id": "HP-007",
      "area": "Multi-Tenancy",
      "issue": "No automatic organizationId query filtering",
      "impact": "Cross-tenant data leakage risk",
      "recommendation": "Implement TypeORM EntitySubscriber"
    },
    {
      "id": "HP-008",
      "area": "CMS Core",
      "issue": "Documentation describes concrete tables; implementation is generic framework",
      "impact": "Developer confusion, incorrect API expectations",
      "recommendation": "Update documentation to match generic CPT approach"
    },
    {
      "id": "HP-009",
      "area": "PartnerOps",
      "issue": "OrderRelay entity missing documented fields",
      "impact": "Partner order relay feature non-functional",
      "missing": ["relayedAt", "acceptedAt", "deliveryInfo", "partnerNotes"]
    }
  ],

  "medium_priority_issues": [
    {
      "id": "MP-001",
      "area": "View System",
      "issue": "DynamicRouter not connected to actual routing",
      "recommendation": "Wire DynamicRouter to React Router or remove from docs"
    },
    {
      "id": "MP-002",
      "area": "CMS Core",
      "issue": "Taxonomy (Category/Tag) documented but not implemented",
      "recommendation": "Implement or document as future feature"
    },
    {
      "id": "MP-003",
      "area": "CMS Core",
      "issue": "Media entity with thumbnail generation not found",
      "recommendation": "Document actual media handling approach"
    },
    {
      "id": "MP-004",
      "area": "Multi-Tenancy",
      "issue": "TenantContext not available in request object",
      "recommendation": "Implement TenantContextInterceptor"
    },
    {
      "id": "MP-005",
      "area": "Multi-Tenancy",
      "issue": "No per-tenant app installation (TenantAppInstance)",
      "recommendation": "Implement after core tenant isolation"
    },
    {
      "id": "MP-006",
      "area": "SupplierOps",
      "issue": "Similar field mismatches to SellerOps",
      "recommendation": "Align with SellerOps fixes"
    },
    {
      "id": "MP-007",
      "area": "CMS Core",
      "issue": "API endpoints in docs don't match implementation",
      "recommendation": "Update API documentation"
    }
  ],

  "low_priority_issues": [
    {
      "id": "LP-001",
      "area": "ModuleLoader",
      "issue": "JSDoc comments could be improved",
      "recommendation": "Add documentation to public methods"
    },
    {
      "id": "LP-002",
      "area": "ModuleLoader",
      "issue": "Error handling could be more granular",
      "recommendation": "Distinguish load errors from activation errors"
    },
    {
      "id": "LP-003",
      "area": "Multi-Tenancy",
      "issue": "Plan-based resource limits not implemented",
      "recommendation": "Future phase after core isolation"
    }
  ],

  "recommendations": {
    "immediate_actions": [
      {
        "priority": 1,
        "action": "Fix SellerOps entity field references",
        "scope": "Change supplyPrice → supplierPrice, stock → stockQuantity in services",
        "effort": "LOW",
        "impact": "HIGH"
      },
      {
        "priority": 2,
        "action": "Update CMS documentation to reflect generic CPT architecture",
        "scope": "Rewrite cms-cpt-overview.md to describe actual framework",
        "effort": "MEDIUM",
        "impact": "HIGH"
      },
      {
        "priority": 3,
        "action": "Register TenantMiddleware in AppModule",
        "scope": "Enable tenant context injection",
        "effort": "LOW",
        "impact": "HIGH"
      }
    ],
    "short_term": [
      {
        "action": "Wire View System to AppManager activation flow",
        "effort": "MEDIUM"
      },
      {
        "action": "Add missing fields to SettlementBatch entity",
        "effort": "MEDIUM"
      },
      {
        "action": "Implement TypeORM tenant filtering subscriber",
        "effort": "MEDIUM"
      }
    ],
    "long_term": [
      {
        "action": "Complete PartnerOps implementation",
        "effort": "HIGH"
      },
      {
        "action": "Implement per-tenant app activation",
        "effort": "HIGH"
      },
      {
        "action": "Add viewTemplates to all app manifests",
        "effort": "HIGH"
      }
    ]
  },

  "related_reports": [
    "docs/_analysis/architecture_code_alignment.json",
    "docs/_analysis/loader_manager_alignment.json",
    "docs/_analysis/cms_core_alignment.json",
    "docs/_analysis/specs_code_alignment.json",
    "docs/_analysis/multi_tenancy_alignment.json"
  ],

  "next_phase_suggestions": [
    "Phase 17: SellerOps/SupplierOps Entity Field Alignment (코드 수정)",
    "Phase 18: CMS Documentation Update (문서 수정)",
    "Phase 19: Multi-Tenancy Integration (코드 수정)",
    "Phase 20: View System Activation Integration (코드 수정)"
  ],

  "audit_metadata": {
    "auditor": "Claude Code",
    "methodology": "Design document review → Code grep/read analysis → Gap identification",
    "files_analyzed": 47,
    "entities_reviewed": 28,
    "services_reviewed": 15
  }
}
