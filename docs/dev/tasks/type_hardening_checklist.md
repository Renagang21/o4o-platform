# Type Hardening 실행 체크리스트

**목적**: 타입 불일치로 인한 예외를 0건으로 만들고 일관된 스키마 강제
**대상**: Astra Customizer 전체 (저장·프리셋·패널 전환)

---

## 🎯 목표

- **TypeError 0건**: `...reading 'desktop'` 등 타입 불일치 예외 완전 제거
- **스키마 일관성**: API ↔ 어댑터 ↔ 스토어 ↔ UI 경계에서 100% 일치
- **회귀 방지**: 런타임 가드 + 알림으로 재발 차단

---

## 📋 우선 정비 대상 (스코프)

### 1. 디바이스 3분기 객체형
**대상 필드**:
- `footer.widgets.columns`
- `container.spacing`
- `typography.fontSize`
- `typography.lineHeight`

**강제 형식**: `{ desktop: N, tablet: N, mobile: N }`

**금지 형식**:
- ❌ 숫자 (예: `columns: 4`)
- ❌ undefined
- ❌ 배열

---

### 2. 토큰형 값
**대상 필드**:
- `colors.*` (primary, accent, text, background, link)
- `typography.fontFamily.*`

**강제 형식**: 문자열 (예: `"#0073aa"`, `"system-ui"`)

**금지 형식**:
- ❌ 객체
- ❌ 배열
- ❌ 숫자

---

### 3. 식별자/URL형
**대상 필드**:
- `siteIdentity.logo.url`
- `siteIdentity.favicon`

**강제 형식**: 문자열 (URL)

**금지 형식**:
- ❌ 객체
- ❌ undefined (옵션 필드는 허용)

---

### 4. 빌더 배열형
**대상 필드**:
- `header.builder.*`
- `footer.widgets.layout`

**강제 형식**: 배열

**금지 형식**:
- ❌ 숫자 키 오염 (예: `{0: "...", 1: "..."}`)
- ❌ 객체 (배열 아닌)

---

## ✅ 체크리스트

### Phase 1: 스키마 확정 및 문서화 (1시간)

- [ ] `docs/dev/tasks/customizer_schema_spec.md` 최종판 업데이트
  - [ ] 모든 핵심 경로 (최소 10개) 표로 정리
  - [ ] 각 경로에 타입/필수여부/기본값/예시값 명시
  - [ ] 3분기 객체형 경로 명시적 표시
  - [ ] "어댑터에서 항상 보장" 규칙 문서화

**DoD**: 스키마 표에 현행 모든 핵심 경로 수록, 각 경로에 예상값 예시 포함

---

### Phase 2: 어댑터 경로 인벤토리 (30분)

**목적**: 어댑터를 우회하는 직접 주입 경로 발견

- [ ] 프리셋 적용 경로 확인
  - [ ] `PresetManager.tsx` 분석
  - [ ] 프리셋 데이터가 어댑터 통과하는지 확인

- [ ] 초기화 경로 확인
  - [ ] "초기화" 버튼 핸들러 분석
  - [ ] `getDefaultSettings` 직접 사용 여부 확인

- [ ] 저장 경로 확인 (✅ Phase 4에서 이미 확인)
  - [x] `handleSave`가 `normalizeCustomizerSettings` 사용 확인

- [ ] 로드 경로 확인
  - [ ] `loadSettings`가 응답을 어댑터 통과시키는지 확인

**DoD**: 우회 경로 인벤토리 작성 (파일:라인, 현황, 조치필요여부)

---

### Phase 3: 경계별 타입 강제 적용 (2시간)

#### 3.1 API 경계
- [x] 숫자 키 차단 (서버에서 이미 운영 중)
- [x] 타입 불일치 차단 (서버 검증)
- [ ] 응답 스냅샷 검증 (표본 5건)

#### 3.2 어댑터 경계
- [x] `normalizeCustomizerSettings` 함수 존재
- [ ] 모든 입력 경로가 어댑터 통과하는지 확인
  - [ ] 프리셋 → 어댑터
  - [ ] 초기화 → 어댑터
  - [ ] 로드 → 어댑터
  - [ ] 저장 → 어댑터 (✅ 이미 적용)

#### 3.3 스토어 경계
- [ ] 스토어 직접 병합 금지 확인
- [ ] 어댑터 출력물만 주입하는지 확인

#### 3.4 UI 경계
- [ ] UI가 타입 가드 없이 안전하게 렌더링하는지 확인
- [ ] 3분기 객체 접근 시 `?.desktop` 패턴 확인

**DoD**: 각 경계에서 타입 불일치 발생 가능성 0%

---

### Phase 4: 런타임 가드 구현 (1시간)

- [ ] 타입 가드 유틸리티 작성
  - [ ] `isResponsiveColumns(value)` 함수
  - [ ] `isValidColor(value)` 함수
  - [ ] `isValidURL(value)` 함수

- [ ] 섹션별 강등 로직 구현
  - [ ] 타입 위반 감지 시 섹션 비활성화
  - [ ] 사용자에게 "초기화 권고" 토스트 표시
  - [ ] 리로드 금지

- [ ] 로깅 구현
  - [ ] `typeguard.violation.{path}` 로그
  - [ ] `adapter.autoFix.{path}` 로그

**DoD**: 의도적 위반 주입 시 페이지 예외 없음, 섹션 강등만 작동

---

### Phase 5: 데이터 정합성 점검 (30분)

**표본 5건 실측**:

- [ ] 표본 1: 기본 설정 (초기 상태)
- [ ] 표본 2: 프리셋 적용 후
- [ ] 표본 3: 커스텀 수정 후
- [ ] 표본 4: 저장 후 재로드
- [ ] 표본 5: 시크릿 창 (캐시 없음)

**각 표본에서 확인**:
- [ ] `footer.widgets.columns`가 `{desktop, tablet, mobile}`
- [ ] `siteIdentity.logo.url`이 문자열
- [ ] `colors.*`가 문자열
- [ ] 빌더 경로가 배열
- [ ] 숫자 키 0건

**DoD**: 표본 5/5 일치, 숫자 키 재검출 0건

---

### Phase 6: 프리셋/초기화 경로 타입 보장 (1시간)

- [ ] 프리셋 적용 시 어댑터 강제
  - [ ] `PresetManager.tsx` 수정
  - [ ] 프리셋 데이터 → `normalizeCustomizerSettings` → 스토어

- [ ] 초기화 시 어댑터 강제
  - [ ] 초기화 버튼 핸들러 수정
  - [ ] `getDefaultSettings()` → `normalizeCustomizerSettings` → 스토어

- [ ] 단일 경로 원칙 문서화
  - [ ] "모든 설정 변경은 어댑터 경유 필수" 룰 추가

**DoD**: 프리셋 10회 반복 적용해도 TypeError/깜빡임 없음

---

### Phase 7: 테스트 시나리오 실행 (1시간)

#### T1. 3분기 고정성 테스트
- [ ] `columns` 수치 변경 → 저장 → 새로고침
- [ ] `spacing` 수치 변경 → 저장 → 새로고침
- [ ] `fontSize` 수치 변경 → 저장 → 새로고침
- [ ] 모든 경우 `{d, t, m}` 존재 확인

**Pass 기준**: 3회 모두 3분기 객체 형태 유지

#### T2. 프리셋 왕복 테스트
- [ ] 프리셋 1 적용
- [ ] 프리셋 2 적용
- [ ] 초기화
- [ ] 프리셋 3 적용
- [ ] 저장
- [ ] 새로고침
- [ ] 위 과정 10회 반복

**Pass 기준**: TypeError 0건, 값 일관성 유지

#### T3. 실패 품질 테스트
- [ ] 의도적 위반 주입 (숫자/undefined)
- [ ] 섹션 강등 확인
- [ ] 안내 토스트 확인
- [ ] 리로드 없음 확인

**Pass 기준**: 섹션 강등만 작동, 전체 페이지 안정

#### T4. 교차 섹션 조합 테스트
- [ ] 사이트정보 + 푸터 + 헤더 동시 변경
- [ ] 저장
- [ ] 새로고침
- [ ] 모든 섹션 값 유지 확인

**Pass 기준**: 3개 섹션 모두 값 유지

**전체 DoD**: T1~T4 모두 Pass

---

### Phase 8: 관측 및 알림 설정 (30분)

- [ ] 로그 키 정의
  - [ ] `typeguard.violation.{path}`: 경로, 타입, 수신값
  - [ ] `adapter.autoFix.{path}`: 자동 보정 카운트

- [ ] 알림 규칙 설정
  - [ ] 1주간 `typeguard.violation.* ≥ 1`이면 Slack 알림
  - [ ] 자동 보정 카운트 모니터링

**DoD**: 7일간 위반 0건, 자동 보정은 일시적으로만 관찰

---

## 🐛 버그 맵핑

### BUG-02: `TypeError: ... reading 'desktop'`
**해결 경로**: Phase 6 (프리셋/초기화 경로 타입 보장)
**원인 후보**: 어댑터 우회 직주입
**테스트**: T1, T2

### Astra Customizer 타입 불일치 전반
**해결 경로**: Phase 1-8 전체
**원인**: 경계별 타입 강제 부재
**테스트**: T1-T4

---

## 📊 수행 순서 (권장, 반나절)

1. **Phase 1**: 스키마 확정 문서 업데이트 (1시간)
2. **Phase 2**: 어댑터 우회 경로 인벤토리 (30분)
3. **Phase 3**: 경계별 타입 강제 적용 (2시간)
4. **Phase 5**: 표본 5건 실측 (30분)
5. **Phase 6**: 프리셋/초기화 경로 수정 (1시간)
6. **Phase 7**: 테스트 시나리오 실행 (1시간)
7. **Phase 4**: 런타임 가드 구현 (1시간) - 선택적
8. **Phase 8**: 알림 설정 (30분) - 선택적

**총 소요시간**: 6-8시간

---

## 📝 보고 양식

```markdown
### Type Hardening 완료 보고

#### 스키마 표 갱신
- 경로 총 N개
- 누락→추가 M개
- 3분기 객체형 K개 명시

#### 우회 경로 제거
- 프리셋 직주입: X건 → 어댑터 경유로 전환
- 초기화 직주입: Y건 → 어댑터 경유로 전환
- 로드 직주입: Z건 → 어댑터 경유로 전환

#### 표본 검사 (5/5)
- [ ] 표본 1: Pass/Fail
- [ ] 표본 2: Pass/Fail
- [ ] 표본 3: Pass/Fail
- [ ] 표본 4: Pass/Fail
- [ ] 표본 5: Pass/Fail

#### 테스트 시나리오
- [ ] T1 (3분기 고정성): Pass/Fail
- [ ] T2 (프리셋 왕복): Pass/Fail
- [ ] T3 (실패 품질): Pass/Fail
- [ ] T4 (교차 섹션): Pass/Fail

#### 알림 규칙
- [ ] 활성화 완료: 예/아니오
- [ ] 7일 모니터링 계획: 예/아니오
```

---

**다음 작업**: Phase 2 - 어댑터 우회 경로 인벤토리 작성
