openapi: 3.1.0
info:
  title: "{Business} API"
  description: |
    {Business} 도메인 공식 API 계약 (단일 진실 원본)

    ## 규칙
    - 이 문서에 정의된 엔드포인트만 구현 가능
    - OpenAPI에 없는 API 구현 절대 금지
    - 코드보다 이 계약이 우선함

    ## Scope
    - {business}:read - 조회
    - {business}:write - 수정
    - {business}:admin - 관리
  version: 1.0.0
  contact:
    name: O4O Platform Team
  license:
    name: Proprietary

servers:
  - url: "https://{business}-api.neture.co.kr"
    description: Production
  - url: "http://localhost:{port}"
    description: Development

tags:
  - name: Resources
    description: 리소스 관련 API (Public/Admin)

paths:
  /{business}/resources:
    get:
      operationId: listResources
      summary: 리소스 목록 조회
      description: 페이지네이션을 지원하는 리소스 목록 조회
      tags:
        - Resources
      security: []
      parameters:
        - name: page
          in: query
          description: 페이지 번호
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          description: 페이지당 항목 수
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: status
          in: query
          description: 상태 필터
          schema:
            $ref: '#/components/schemas/ResourceStatus'
        - name: sort
          in: query
          description: 정렬 필드
          schema:
            type: string
            enum: [created_at, name]
            default: created_at
        - name: order
          in: query
          description: 정렬 방향
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceListResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

  /{business}/resources/{id}:
    get:
      operationId: getResource
      summary: 리소스 상세 조회
      description: 단일 리소스의 상세 정보 조회
      tags:
        - Resources
      security: []
      parameters:
        - name: id
          in: path
          required: true
          description: 리소스 ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceDetailResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /{business}/admin/resources:
    post:
      operationId: createResource
      summary: 리소스 등록
      description: 새 리소스 등록 (Admin 권한 필요)
      tags:
        - Resources
      security:
        - bearerAuth: ["{business}:admin"]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateResourceRequest'
      responses:
        '201':
          description: 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceDetailResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /{business}/admin/resources/{id}:
    put:
      operationId: updateResource
      summary: 리소스 수정
      description: 기존 리소스 정보 수정 (Admin 권한 필요)
      tags:
        - Resources
      security:
        - bearerAuth: ["{business}:admin"]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateResourceRequest'
      responses:
        '200':
          description: 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceDetailResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      operationId: deleteResource
      summary: 리소스 삭제
      description: 리소스 삭제 (Admin 권한 필요)
      tags:
        - Resources
      security:
        - bearerAuth: ["{business}:admin"]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: 삭제 성공
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /{business}/admin/resources/{id}/status:
    patch:
      operationId: updateResourceStatus
      summary: 리소스 상태 변경
      description: 리소스 상태 변경 (Admin 권한 필요)
      tags:
        - Resources
      security:
        - bearerAuth: ["{business}:admin"]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStatusRequest'
      responses:
        '200':
          description: 상태 변경 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusChangeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /{business}/admin/logs/resources:
    get:
      operationId: getResourceLogs
      summary: 리소스 변경 이력 조회
      description: 리소스 변경 감사 로그 조회 (Admin 권한 필요)
      tags:
        - Resources
      security:
        - bearerAuth: ["{business}:admin"]
      parameters:
        - name: resource_id
          in: query
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT 인증. Core API에서 발급받은 토큰 사용.
        Scope: {business}:read, {business}:write, {business}:admin

  schemas:
    # === Enums ===
    ResourceStatus:
      type: string
      enum: [draft, active, inactive, archived]
      description: |
        리소스 상태
        - draft: 초안 (비공개)
        - active: 활성
        - inactive: 비활성
        - archived: 보관

    # === Common ===
    PaginationMeta:
      type: object
      required:
        - page
        - limit
        - total
        - total_pages
      properties:
        page:
          type: integer
        limit:
          type: integer
        total:
          type: integer
        total_pages:
          type: integer
        has_next:
          type: boolean
        has_prev:
          type: boolean

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: "에러 코드 ({BUSINESS}_XXX)"
            message:
              type: string
              description: 에러 메시지
            details:
              type: object
              description: 추가 에러 정보

    # === Resource ===
    ResourceSummary:
      type: object
      required:
        - id
        - name
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/ResourceStatus'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ResourceDetail:
      type: object
      required:
        - id
        - name
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        status:
          $ref: '#/components/schemas/ResourceStatus'
        metadata:
          type: object
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ResourceListResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/ResourceSummary'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    ResourceDetailResponse:
      type: object
      required:
        - data
      properties:
        data:
          $ref: '#/components/schemas/ResourceDetail'

    # === Requests ===
    CreateResourceRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 5000
        status:
          $ref: '#/components/schemas/ResourceStatus'

    UpdateResourceRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 200
        description:
          type: string
          maxLength: 5000

    UpdateStatusRequest:
      type: object
      required:
        - status
      properties:
        status:
          $ref: '#/components/schemas/ResourceStatus'
        reason:
          type: string
          maxLength: 500

    StatusChangeResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: object
          required:
            - id
            - status
            - previous_status
            - changed_at
          properties:
            id:
              type: string
              format: uuid
            status:
              $ref: '#/components/schemas/ResourceStatus'
            previous_status:
              $ref: '#/components/schemas/ResourceStatus'
            changed_at:
              type: string
              format: date-time
            changed_by:
              type: string
              format: uuid

    # === Audit Log ===
    AuditLogEntry:
      type: object
      required:
        - id
        - action
        - entity_type
        - entity_id
        - created_at
      properties:
        id:
          type: string
          format: uuid
        action:
          type: string
          enum: [CREATE, UPDATE, DELETE, STATUS_CHANGE]
        entity_type:
          type: string
        entity_id:
          type: string
          format: uuid
        changes:
          type: object
        user_id:
          type: string
          format: uuid
        user_name:
          type: string
        created_at:
          type: string
          format: date-time

    AuditLogListResponse:
      type: object
      required:
        - data
        - meta
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AuditLogEntry'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

  responses:
    BadRequest:
      description: 잘못된 요청
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: VALIDATION_ERROR
              message: Validation failed

    Unauthorized:
      description: 인증 필요
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "{BUSINESS}_401"
              message: Authentication required

    Forbidden:
      description: 권한 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "{BUSINESS}_403"
              message: Permission denied

    NotFound:
      description: 리소스 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "{BUSINESS}_001"
              message: Resource not found

    Conflict:
      description: 충돌
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "{BUSINESS}_409"
              message: Resource already exists

    InternalError:
      description: 서버 오류
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              code: "{BUSINESS}_500"
              message: Internal server error
