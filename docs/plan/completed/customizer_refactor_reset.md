# Customizer 코드 정비 및 안정화 계획

**작성일**: 2025-11-09
**상태**: 진행 예정
**우선순위**: 긴급

---

## 📋 현황 진단

### 문제점
1. **무한 새로고침**: Stage 1 Hotfix 배포 후에도 페이지 리로드 발생
2. **TypeError**: `columns.desktop` undefined 에러
3. **복잡한 의존성**: 인증/프리뷰/저장 로직이 얽혀있음
4. **재마운트 이슈**: AuthContext가 반복 마운트되며 retryCount 초기화

### 근본 원인
- 프리뷰(iframe)와 저장 로직의 강결합
- 교차 출처 호출 (admin → neture.co.kr)
- 재시도 로직의 상태 관리 문제
- 데이터 정규화/병합 로직의 중복

---

## 🎯 작업 원칙

1. **저장 기능 최우선**: 프리뷰 종속성 제거 후 저장부터 정상화
2. **단일 책임**: 인증/프리뷰/저장 파이프라인을 물리적으로 분리
3. **가시성**: 모든 실패는 로그화, 페이지 리로드 금지 (토스트 + 백오프)
4. **변경 동결 (48시간)**: 안정화 완료 전까지 외모/인증/프리뷰 관련 신규 수정 중단

---

## 📦 브랜치 전략

### 브랜치
- `stabilize/customizer-save` (안정화 전용)

### 체크포인트 태그
- `customizer-save-v1`: 저장 단독 정상 (프리뷰 OFF)
- `customizer-save-v2`: 프리뷰 ON 정상 (루프 0회)

### 롤백 규칙
- v2에서 회귀 시 즉시 v1로 롤백 + 프리뷰 OFF 유지

---

## 🧹 정리 대상

### 1. 중복/유사 유틸 정리
- [ ] `normalize`, `sanitize`, `merge` 유틸을 **하나**로 통합
- [ ] 모듈 경로 고정 (`@/utils/customizer-schema`)
- [ ] 사용되지 않는 과거 파일 격리 (`_deprecated/` 폴더)

### 2. AuthContext 단일화
- [ ] 앱 루트 1곳만 마운트 (다중 마운트 제거)
- [ ] 외부 라우팅/가드의 재마운트 유발 요소 제거
- [ ] 리다이렉트/전역 상태 변경 점검

### 3. 교차 호출 경로 차단
- [ ] Admin 상위창 → `neture.co.kr` 인증/활성 호출 경로 전수 목록화
- [ ] 해당 호출 차단 (iframe 내부에서만 수행)
- [ ] 원칙 문서화

### 4. 리로드 트리거 제거
- [ ] `location.reload()` 패턴 제거
- [ ] 강제 리다이렉트 패턴 제거
- [ ] 대체: 토스트 안내 + 지수 백오프 (최대 3회) + 세션 단위 비활성 플래그

---

## 🏗️ 모듈 경계 재설계

### A. 인증 계층 (`AuthContext.tsx`)

**책임**:
- 사용자 인증 상태 관리
- 로그인/로그아웃 처리
- `/me` API 호출 (자기 출처에서만)

**변경사항**:
- [ ] `isInIframe` 가드 강화 (효과 실행 금지까지 보장)
- [ ] 재시도 카운트 sessionStorage 기반 (세션 내 영구)
- [ ] 3회 실패 시 세션 종료 전까지 비활성
- [ ] 재마운트 시 sessionStorage 확인하여 재시도 방지

**설계 원칙**:
```typescript
// sessionStorage 키: _auth_retry_blocked
// 값: { count: number, blockedAt: timestamp }
// 3회 실패 시 block = true, 세션 종료까지 auth check 중단
```

### B. 저장 파이프라인 (`Customize.tsx`)

**책임**:
- Customizer 설정 로드/저장
- 스키마 정규화
- API 통신

**5단계 파이프라인**:
1. **입력**: 사용자 변경사항
2. **스키마 어댑터**: 타입 변환 및 검증
3. **정화/병합**: sanitizeSettings + normalize
4. **전송**: API PUT 요청
5. **응답 반영**: 서버 스냅샷만 반영 (로컬 값 병합 금지)

**변경사항**:
- [ ] 디바이스 3분기 스키마 어댑터 도입
  - `columns: number` → `{ desktop, tablet, mobile }`
- [ ] 저장 성공 시 서버 응답만 반영
- [ ] 에러 처리: 토스트 + 로그 (리로드 금지)

### C. 프리뷰 오케스트레이션 (`SimpleCustomizer.tsx`)

**책임**:
- 실시간 프리뷰 표시
- iframe 통신

**변경사항**:
- [ ] 프리뷰는 **옵션(보조)**로 격하
- [ ] 프리뷰 실패 시 저장 플로우에 영향 금지
- [ ] 지연 로드 (필요 시에만 iframe 로드)
- [ ] 실패 시 "조용한 강등" (토스트 안내만)

---

## 🛡️ 에러 안전장치

### 1. UI 가드
```typescript
// Bad: 직접 접근
settings.footer.widgets.columns.desktop

// Good: 어댑터 통과값 참조
const columns = getColumnsConfig(settings) // 기본값 보장
```

### 2. 에러 바운더리
- [ ] 섹션별 컴포넌트에 에러 바운더리 적용
- [ ] 예외 발생 시 해당 섹션만 비활성화
- [ ] 저장 패널은 항상 유지

### 3. 빈 데이터 전략
- [ ] API 실패 시 "읽기전용 + 안내 배너"로 전환
- [ ] 리로드 없음

---

## 📝 작업 순서

### Phase 0: 준비 (30분)
- [ ] 브랜치 생성: `stabilize/customizer-save`
- [ ] 현행 동작 스냅샷 보관 (로그 3분 구간)
- [ ] DB 샘플 1건 백업

### Phase 1: 인벤토리 작성 (1시간)
- [ ] 의존 그래프 작성 (인증/저장/프리뷰 분리)
- [ ] 죽은 코드/중복 유틸 목록화
- [ ] 교차 호출 경로 목록화
- [ ] 재마운트 원인 목록화

### Phase 2: AuthContext 안정화 (2시간)
- [ ] 단일 마운트 지점 확정
- [ ] sessionStorage 기반 재시도 로직 구현
- [ ] 재마운트 원인 제거
- [ ] iframe 가드 강화

### Phase 3: 저장 파이프라인 정리 (3시간)
- [ ] 유틸 통합 (`normalize-settings.ts` 단일화)
- [ ] 스키마 어댑터 도입
- [ ] 교차 호출 제거
- [ ] 에러 처리 강화

### Phase 4: UI 가드 적용 (1시간)
- [ ] 에러 바운더리 추가
- [ ] 섹션별 fallback UI
- [ ] 프리뷰 옵션화

### Phase 5: 스모크 테스트 v1 (프리뷰 OFF)
- [ ] S1: 저장 일관성 테스트
- [ ] S2: 동시성 테스트
- [ ] S3: 실패 경로 품질
- [ ] **태그 생성**: `customizer-save-v1`

### Phase 6: 프리뷰 복귀 (2시간)
- [ ] 프리뷰 ON 활성화
- [ ] iframe 로드 테스트
- [ ] 재시도 ≤3회 검증
- [ ] 루프/리로드 0회 검증

### Phase 7: 스모크 테스트 v2 (프리뷰 ON)
- [ ] S1, S2, S3 재검증
- [ ] **태그 생성**: `customizer-save-v2`

---

## ✅ 완료 기준 (DoD)

### v1 (프리뷰 OFF)
- [ ] 저장 성공률 100% (연속 10회)
- [ ] 새로고침 후 값 유지
- [ ] 리로드 0회
- [ ] `/me` 실패율 0% (상위창 기준)
- [ ] TypeError 0건
- [ ] 숫자 키 검출 0건

### v2 (프리뷰 ON)
- [ ] v1 기준 모두 통과
- [ ] iframe 로드 정상
- [ ] 재시도 ≤3회
- [ ] 무한 루프 0회
- [ ] 저장 경로에 프리뷰 영향 없음

---

## 🔧 API 서버 작업

### 필수 요구사항
1. **사전 동기화 필수**: 로컬 작업 전 서버 코드 pull
2. **검증 정책 유지**:
   - 숫자 키 차단
   - 알 수 없는 키 차단
   - 타입 불일치 400
3. **성공 시 최종 스냅샷 응답**
4. **로그 키 표준화**:
   - `save.success`
   - `save.reject.numeric_keys`
   - `save.fail`

---

## 📊 보고 양식

### 정비 결과
- 제거/병합 파일: N건 (목록)
- 교차 호출 제거: N건 (목록)
- 재마운트 제거: N곳 (원인·대응)

### 테스트 결과
- S1 (저장 일관성): Pass/Fail + 사유
- S2 (동시성): Pass/Fail + 사유
- S3 (실패 경로): Pass/Fail + 사유

### 배포 정보
- 태그 v1 생성: YYYY-MM-DD HH:MM
- 태그 v2 생성: YYYY-MM-DD HH:MM

---

## 📚 참고 문서

- [스모크 테스트 체크리스트](./customizer_smoke_tests.md)
- [교차 호출 인벤토리 템플릿](./cross_origin_inventory.md)
- [스키마 정의서](./customizer_schema_spec.md)
- [에러 처리 가이드](./customizer_error_handling.md)

---

## 🚨 리스크 및 대응

### 리스크 1: 기존 기능 회귀
- **대응**: 각 Phase 완료 시 기본 기능 테스트
- **롤백**: 태그 기반 즉시 롤백

### 리스크 2: 프리뷰 복귀 실패
- **대응**: v1에서 충분한 안정화 시간 확보
- **롤백**: v1으로 복귀, 프리뷰 OFF 유지

### 리스크 3: 교차 출처 호출 미발견
- **대응**: Chrome DevTools Network 탭 Initiator 추적
- **백업**: Nginx 임시 차단 규칙 준비

---

## 💬 팀장 보고용 요약

> "프리뷰 의존을 일시 제거해 저장을 먼저 정상화하고, 교차 호출을 원천 차단한 뒤 프리뷰를 복귀시키겠습니다.
> 브랜치 `stabilize/customizer-save` 에서 v1(프리뷰 OFF) 안정화 → v2(프리뷰 ON) 순으로 진행하고, 각 단계는 태그/롤백 지점으로 고정하겠습니다."

---

**다음 액션**: Phase 0 준비 작업 시작
