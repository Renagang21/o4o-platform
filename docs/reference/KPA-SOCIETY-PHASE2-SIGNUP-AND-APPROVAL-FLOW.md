# KPA-Society Phase 2: Signup and Approval Flow

> **Phase 2 설계 문서 — 구현 코드/SQL 없음**
>
> 작성일: 2026-02-06
> 상위 Work Order: WO-KPA-SOCIETY-PHASE2-MEMBERSHIP-DATAFLOW-V1

---

## 1. 가입 시작 지점

### 1.1 현행

| 진입점 | 위치 | 방식 |
|--------|------|------|
| RegisterModal | 커뮤니티 홈 | 모달 (URL 변경 없음) |
| RegisterPage | `/register` | **라우트 미등록** (레거시) |

### 1.2 설계

가입은 **단일 진입점(RegisterModal)**을 유지한다.

```
사용자가 "회원가입" 클릭
  → RegisterModal 오픈
  → Step 1: 회원 유형 선택 (약사 / 약대생)    ← 신규
  → Step 2: 공통 정보 입력
  → Step 3: 유형별 추가 정보 입력
  → Step 4: 약관 동의
  → 제출
```

---

## 2. 약사 vs 약대생 분기

### 2.1 분기 시점

**Step 1에서 분기** — 가입 첫 화면에서 유형을 선택한다.

```
┌─────────────────────────────────┐
│       회원가입                    │
│                                  │
│   ┌────────────┐ ┌────────────┐ │
│   │   약사     │ │  약대생     │ │
│   │            │ │            │ │
│   │ 면허번호   │ │ 대학/학년  │ │
│   │ 필요      │ │ 필요       │ │
│   └────────────┘ └────────────┘ │
│                                  │
└─────────────────────────────────┘
```

### 2.2 유형별 입력 필드

#### 공통 필드 (모든 유형)

| 필드 | 필수 | 비고 |
|------|------|------|
| 이메일 | O | Account 생성 |
| 비밀번호 | O | Account 생성 |
| 비밀번호 확인 | O | 검증 |
| 성명 | O | Account name |
| 연락처 | O | Account phone |

#### 약사 전용 필드

| 필드 | 필수 | 비고 |
|------|------|------|
| 약사면허번호 | O | SVC-A Membership (license_number) |
| 소속 분회 | X | SVC-A Membership (organization_id) |
| 약국명 | X | 선택사항 (약국 개설자가 아닐 수 있음) |

#### 약대생 전용 필드

| 필드 | 필수 | 비고 |
|------|------|------|
| 재학 대학명 | O | SVC-A Membership (university_name) |
| 학년 | O | SVC-A Membership (student_year) |

#### 공통 동의

| 필드 | 필수 |
|------|------|
| 이용약관 동의 | O |
| 개인정보처리방침 동의 | O |

### 2.3 membership_type 결정

| 선택 | membership_type | 승인 기준 |
|------|----------------|----------|
| "약사" 선택 | `pharmacist` | 약사면허번호 확인 후 승인 |
| "약대생" 선택 | `student` | 재학 정보 확인 후 승인 |

---

## 3. 가입 상태 전이 다이어그램

### 3.1 약사 가입 흐름

```
[가입 신청]
  │
  ▼
Account.status = PENDING
SVC-A Membership.status = pending
SVC-A Membership.type = pharmacist
  │
  ├── 승인 거부 ──→ Account.status = REJECTED
  │                 Membership.status = withdrawn
  │
  └── 운영자 승인 ──→ Account.status = ACTIVE
                      Membership.status = active
                      Membership.joined_at = NOW()
                        │
                        ▼
                    [첫 로그인]
                        │
                        ├── 직능/직역 미선택
                        │     → 직능 선택 게이트
                        │     → pharmacist_function 설정
                        │     → pharmacist_role 설정
                        │
                        └── 직능/직역 선택 완료
                              → 대시보드
```

### 3.2 약대생 가입 흐름

```
[가입 신청]
  │
  ▼
Account.status = PENDING
SVC-A Membership.status = pending
SVC-A Membership.type = student
  │
  ├── 승인 거부 ──→ Account.status = REJECTED
  │                 Membership.status = withdrawn
  │
  └── 운영자 승인 ──→ Account.status = ACTIVE
                      Membership.status = active
                      Membership.joined_at = NOW()
                        │
                        ▼
                    [첫 로그인]
                        │
                        └── 약대생 대시보드
                            (직능/직역 선택 불필요)
```

### 3.3 약대생 → 약사 전환

```
약대생 (Membership.type = student, active)
  │
  └── "약사 전환 신청" ──→ 약사면허번호 입력
                            │
                            ▼
                        Membership.type 변경 요청
                        (pending 상태로 전환)
                            │
                            └── 운영자 승인
                                  → type = pharmacist
                                  → status = active
```

---

## 4. 승인 전/후 가능한 행동

### 4.1 승인 전 (PENDING)

| 행동 | 가능 여부 | 비고 |
|------|----------|------|
| 로그인 시도 | X | Account.status = PENDING이므로 차단 |
| 서비스 이용 | X | Membership.status = pending |
| 가입 상태 조회 | O | 별도 페이지 (RegisterPendingPage) |
| 가입 취소 | O | 스스로 withdrawn 가능 |
| 정보 수정 | X | 로그인 불가 |

### 4.2 승인 후 (ACTIVE)

| 행동 | 가능 여부 | 비고 |
|------|----------|------|
| 로그인 | O | |
| 커뮤니티 이용 | O | SVC-A Membership active |
| 데모 서비스 이용 | O | Membership 불요 (로그인만) |
| 분회 서비스 이용 | 조건부 | SVC-C Membership 필요 (향후) |
| 약국 경영 서비스 | 조건부 | pharmacist_role = pharmacy_owner 필요 |
| 프로필 수정 | O | |
| 탈퇴 신청 | O | |

---

## 5. 약국 개설자 정보 입력 시점

### 5.1 선택지 분석

| 방식 | 장점 | 단점 |
|------|------|------|
| **(A) 가입 시** | 한 번에 완료 | 가입 폼이 길어짐, 약국 미개설 약사도 입력해야 하는 혼선 |
| **(B) 승인 후 첫 로그인 시** | 가입 폼 간결, 필요한 사람만 입력 | 추가 단계 필요, 개발 비용 |

### 5.2 결정: **(B) 승인 후 첫 로그인 시**

**근거:**

1. **모든 약사가 약국 개설자가 아님** — 가입 시 약국 정보를 받으면 불필요한 입력이 발생
2. **직능/직역 선택 게이트가 이미 존재** — 여기서 pharmacy_owner 선택 시 약국 정보 입력으로 연결하는 것이 자연스러움
3. **약국 경영 서비스는 별도 승인이 필요** — PharmacyApprovalGatePage가 이미 구현되어 있음
4. **단계적 온보딩** — 가입 폼은 최소화하고, 서비스별 추가 정보는 서비스 접근 시 수집

### 5.3 승인 후 약국 개설자 흐름

```
[약사 승인 완료 → 첫 로그인]
  │
  ▼
직능/직역 선택 게이트 (/demo/select-function)
  │
  ├── 직역 = general (일반 약사)
  │     → 커뮤니티 대시보드
  │
  ├── 직역 = pharmacy_owner (약국 개설자)
  │     → pharmacist_role = pharmacy_owner 저장
  │     → 약국 경영 서비스 배너 표시
  │     → "약국 서비스 신청" 클릭
  │     → PharmacyApprovalGatePage
  │        → 사업자등록증, 약국명, 전화번호 입력
  │        → 운영자 승인 대기
  │        → 승인 후 약국 대시보드 접근 가능
  │
  ├── 직역 = hospital (병원 약사)
  │     → 커뮤니티 대시보드
  │
  └── 직역 = other (기타)
        → 커뮤니티 대시보드
```

### 5.4 "승인 후 추가 입력" 정책 명문화

> **정책: 가입 시에는 최소 정보만 수집하고, 서비스별 추가 정보는 해당 서비스 접근 시점에 수집한다.**
>
> - 가입 폼: 이메일, 비밀번호, 성명, 연락처, 약사면허번호(또는 대학/학년)
> - 직능/직역: 첫 로그인 시 선택 (게이트 페이지)
> - 약국 정보: 약국 서비스 신청 시 입력 (PharmacyApprovalGatePage)
> - 분회 가입: 분회 서비스 접근 시 신청 (향후)

---

## 6. 대시보드 구조 개념 설계

### 6.1 역할별 대시보드 구조

```
┌───────────────────────────────────────────────────┐
│                   대시보드 허브                      │
│                                                    │
│  ┌──────────────┐  ┌──────────────┐               │
│  │  커뮤니티     │  │  약국 경영    │               │
│  │  대시보드     │  │  대시보드     │               │
│  │              │  │              │               │
│  │ - 포럼 활동   │  │ - 매출 현황   │               │
│  │ - 공지사항    │  │ - 재고 관리   │               │
│  │ - 학습 현황   │  │ - 직원 관리   │               │
│  │ - 분회 소식   │  │ - 서비스 신청  │               │
│  └──────────────┘  └──────────────┘               │
│                                                    │
│  ┌──────────────┐                                  │
│  │  분회 서비스   │                                  │
│  │  (향후)       │                                  │
│  │              │                                  │
│  │ - 분회 공지   │                                  │
│  │ - 분회 포럼   │                                  │
│  │ - 공동구매    │                                  │
│  └──────────────┘                                  │
└───────────────────────────────────────────────────┘
```

### 6.2 회원 유형별 대시보드 접근

| 회원 유형 | 커뮤니티 대시보드 | 약국 경영 대시보드 | 분회 대시보드 |
|----------|-----------------|-----------------|-------------|
| 약대생 | O (제한적) | X | X |
| 일반 약사 | O | X | 조건부 |
| 약국 개설자 | O | O (승인 후) | 조건부 |
| 병원 약사 | O | X | 조건부 |

### 6.3 통합 방식 판단

**질문: 커뮤니티 대시보드와 약국 경영 대시보드를 탭/섹션으로 통합하는 것이 타당한가?**

**판단: 분리 유지**

| 근거 | 설명 |
|------|------|
| 사용 맥락이 다름 | 커뮤니티는 정보/교류, 약국 경영은 업무 |
| 접근 조건이 다름 | 커뮤니티는 모든 회원, 약국은 pharmacy_owner + 서비스 승인 |
| 현행 구조와 일치 | 이미 별도 페이지(`/pharmacy`)로 분리되어 있음 |
| 내비게이션으로 연결 | 상단 메뉴 또는 사이드바로 서비스 간 이동 |

**구현 방향:**
- 커뮤니티 대시보드: 기본 랜딩 (모든 회원)
- 약국 경영 대시보드: `/pharmacy` 하위 (pharmacy_owner만)
- 서비스 간 이동: 상단 내비게이션의 "서비스 전환" 메뉴

---

## 7. 승인 단계 요약

### 7.1 승인 체계 전체 흐름

```
Phase 1: Account 승인
  가입 신청 → PENDING → 운영자 확인 → ACTIVE
  (약사면허 or 재학 정보 확인)

Phase 2: 서비스별 추가 승인 (필요한 경우에만)
  서비스 신청 → pending → 운영자 확인 → active
  (약국 경영: 사업자등록증 확인)
  (분회 가입: 분회 소속 확인) (향후)
```

### 7.2 승인 주체

| 승인 대상 | 승인자 | 확인 사항 |
|----------|--------|----------|
| 약사 가입 | KPA 운영자 (kpa:operator) | 약사면허번호 |
| 약대생 가입 | KPA 운영자 (kpa:operator) | 재학 정보 |
| 약국 경영 서비스 | KPA 운영자 (kpa:operator) | 사업자등록증 |
| 분회 가입 (향후) | 분회 관리자 (kpa:branch_admin) | 분회 소속 여부 |

---

*Phase 2 설계 문서 2/3*
*상태: Complete*
