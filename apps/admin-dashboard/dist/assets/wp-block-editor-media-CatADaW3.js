import{s as e,a as t}from"./wp-i18n-BuBz6Sgx.js";import{u as o,a as i,j as a,M as r}from"./wp-block-editor-misc-Bvzg-2Jv.js";import n from"./wp-api-COhbxmzY.js";import{j as s,D as l,aC as c,i as d,aD as u,aE as p,d as m,ah as h}from"./wp-misc-DyLrwF9p.js";import{r as g,j as x,e as b}from"./vendor-react-DqgGMt48.js";import{r as f,s as j}from"./wp-core-BVMytgUH.js";import{withFilters as C,DropdownMenu as y,MenuGroup as v,MenuItem as k,Spinner as _,Dropdown as w,__experimentalDropdownContentWrapper as S,RangeControl as D,ToolbarButton as P,ToolbarGroup as N,ToolbarItem as U,DropZone as I,FormFileUpload as F,Button as M,Placeholder as R,__experimentalInputControl as L,__experimentalInputControlSuffixWrapper as A}from"./wp-components-Uj2D7Nfy.js";import{c as T}from"./vendor-ui-CrFdsnXa.js";import{A as z}from"./wp-blocks-core-65VcejHr.js";import{s as E}from"./wp-block-editor-store-BOagVFfu.js";import{U as H}from"./wp-block-editor-menus-CucXu4UM.js";function W({fallback:e=null,children:t}){return o(e=>{const{getSettings:t}=e(E);return!!t().mediaUpload},[])?t:e}const Z=C("editor.MediaUpload")(()=>null),O={placement:"bottom-start"};const B=g.createContext({}),G=()=>g.useContext(B);function V({id:o,url:a,naturalWidth:r,naturalHeight:c,onFinishEditing:d,onSaveImage:u,children:p}){const m=function({url:e,naturalWidth:t,naturalHeight:o}){const[i,a]=g.useState(),[r,n]=g.useState(),[s,l]=g.useState({x:0,y:0}),[c,d]=g.useState(100),[u,p]=g.useState(0),m=t/o,[h,x]=g.useState(m),b=g.useCallback(()=>{const t=(u+90)%360;let o=m;if(u%180==90&&(o=1/m),0===t)return a(),p(t),x(m),void l(e=>({x:-e.y*o,y:e.x*o}));const i=new window.Image;i.src=e,i.onload=function(e){const i=document.createElement("canvas");let r=0,n=0;t%180?(i.width=e.target.height,i.height=e.target.width):(i.width=e.target.width,i.height=e.target.height),90!==t&&180!==t||(r=i.width),270!==t&&180!==t||(n=i.height);const s=i.getContext("2d");s.translate(r,n),s.rotate(t*Math.PI/180),s.drawImage(e.target,0,0),i.toBlob(e=>{a(URL.createObjectURL(e)),p(t),x(i.width/i.height),l(e=>({x:-e.y*o,y:e.x*o}))})};const r=f("media.crossOrigin",void 0,e);"string"==typeof r&&(i.crossOrigin=r)},[u,m,e]);return g.useMemo(()=>({editedUrl:i,setEditedUrl:a,crop:r,setCrop:n,position:s,setPosition:l,zoom:c,setZoom:d,rotation:u,setRotation:p,rotateClockwise:b,aspect:h,setAspect:x,defaultAspect:m}),[i,r,s,c,u,b,h,m])}({url:a,naturalWidth:r,naturalHeight:c}),h=function({crop:o,rotation:a,url:r,id:c,onSaveImage:d,onFinishEditing:u}){const{createErrorNotice:p}=i(s),[m,h]=g.useState(!1),x=g.useCallback(()=>{h(!1),u()},[u]),b=g.useCallback(()=>{h(!0);const i=[];if(a>0&&i.push({type:"rotate",args:{angle:a}}),(o.width<99.9||o.height<99.9)&&i.push({type:"crop",args:{left:o.x,top:o.y,width:o.width,height:o.height}}),0===i.length)return h(!1),void u();n({path:`/wp/v2/media/${c}/edit`,method:"POST",data:{src:r,modifiers:i}}).then(e=>{d({id:e.id,url:e.source_url})}).catch(o=>{p(e(t("Could not edit image. %s"),l(o.message)),{id:"image-editing-error",type:"snackbar"})}).finally(()=>{h(!1),u()})},[o,a,c,r,d,p,u]);return g.useMemo(()=>({isInProgress:m,apply:b,cancel:x}),[m,b,x])}({id:o,url:a,onSaveImage:u,onFinishEditing:d,...m}),b=g.useMemo(()=>({...m,...h}),[m,h]);return x.jsx(B.Provider,{value:b,children:p})}function $({aspectRatios:e,isDisabled:t,label:o,onClick:i,value:a}){return x.jsx(v,{label:o,children:e.map(({name:e,slug:o,ratio:r})=>x.jsx(k,{disabled:t,onClick:()=>{i(r)},role:"menuitemradio",isSelected:r===a,icon:r===a?d:void 0,children:e},o))})}function q(e){const[t,o,...i]=e.split("/").map(Number);return t<=0||o<=0||Number.isNaN(t)||Number.isNaN(o)||i.length?NaN:o?t/o:t}function J({ratio:e,...t}){return{ratio:q(e),...t}}function K({toggleProps:e}){const{isInProgress:o,aspect:i,setAspect:r,defaultAspect:n}=G(),[s,l,d]=a("dimensions.aspectRatios.default","dimensions.aspectRatios.theme","dimensions.defaultAspectRatios");return x.jsx(y,{icon:c,label:t("Aspect Ratio"),popoverProps:O,toggleProps:e,children:({onClose:e})=>x.jsxs(x.Fragment,{children:[x.jsx($,{isDisabled:o,onClick:t=>{r(t),e()},value:i,aspectRatios:[{slug:"original",name:t("Original"),aspect:n},...d?s.map(J).filter(({ratio:e})=>1===e):[]]}),l?.length>0&&x.jsx($,{label:t("Theme"),isDisabled:o,onClick:t=>{r(t),e()},value:i,aspectRatios:l}),d&&x.jsx($,{label:t("Landscape"),isDisabled:o,onClick:t=>{r(t),e()},value:i,aspectRatios:s.map(J).filter(({ratio:e})=>e>1)}),d&&x.jsx($,{label:t("Portrait"),isDisabled:o,onClick:t=>{r(t),e()},value:i,aspectRatios:s.map(J).filter(({ratio:e})=>e<1)})]})})}function Q({url:e,width:t,height:o,naturalHeight:i,naturalWidth:a,borderProps:r}){const{isInProgress:n,editedUrl:s,position:l,zoom:c,aspect:d,setPosition:u,setCrop:p,setZoom:m,rotation:h}=G(),[g,{width:f}]=j();let C=o||f*i/a;h%180==90&&(C=f*a/i);const y=x.jsxs("div",{className:T("wp-block-image__crop-area",r?.className,{"is-applying":n}),style:{...r?.style,width:t||f,height:C},children:[x.jsx(b,{image:s||e,disabled:n,minZoom:1,maxZoom:3,crop:l,zoom:c/100,aspect:d,onCropChange:e=>{u(e)},onCropComplete:e=>{p(e)},onZoomChange:e=>{m(100*e)}}),n&&x.jsx(_,{})]});return x.jsxs(x.Fragment,{children:[g,y]})}function X(){const{isInProgress:e,zoom:o,setZoom:i}=G();return x.jsx(w,{contentClassName:"wp-block-image__zoom",popoverProps:O,renderToggle:({isOpen:o,onToggle:i})=>x.jsx(P,{icon:u,label:t("Zoom"),onClick:i,"aria-expanded":o,disabled:e}),renderContent:()=>x.jsx(S,{paddingSize:"medium",children:x.jsx(D,{__next40pxDefaultSize:!0,__nextHasNoMarginBottom:!0,label:t("Zoom"),min:100,max:300,value:Math.round(o),onChange:i})})})}function Y(){const{isInProgress:e,rotateClockwise:o}=G();return x.jsx(P,{icon:p,label:t("Rotate"),onClick:o,disabled:e})}function ee(){const{isInProgress:e,apply:o,cancel:i}=G();return x.jsxs(x.Fragment,{children:[x.jsx(P,{onClick:o,disabled:e,children:t("Apply")}),x.jsx(P,{onClick:i,children:t("Cancel")})]})}function te({id:e,url:t,width:o,height:i,naturalHeight:a,naturalWidth:n,onSaveImage:s,onFinishEditing:l,borderProps:c}){return x.jsxs(V,{id:e,url:t,naturalWidth:n,naturalHeight:a,onSaveImage:s,onFinishEditing:l,children:[x.jsx(Q,{borderProps:c,url:t,width:o,height:i,naturalHeight:a,naturalWidth:n}),x.jsxs(r,{children:[x.jsxs(N,{children:[x.jsx(X,{}),x.jsx(U,{children:e=>x.jsx(K,{toggleProps:e})}),x.jsx(Y,{})]}),x.jsx(N,{children:x.jsx(ee,{})})]})]})}const oe=()=>{},ie=({src:e,onChange:o,onSubmit:i,onClose:a,popoverAnchor:r})=>x.jsx(H,{anchor:r,onClose:a,children:x.jsx("form",{className:"block-editor-media-placeholder__url-input-form",onSubmit:i,children:x.jsx(L,{__next40pxDefaultSize:!0,label:t("URL"),hideLabelFromVision:!0,placeholder:t("Paste or type URL"),onChange:o,value:e,suffix:x.jsx(A,{variant:"control",children:x.jsx(M,{size:"small",icon:h,label:t("Apply"),type:"submit"})})})})}),ae=({src:e,onChangeSrc:o,onSelectURL:i})=>{const[a,r]=g.useState(null),[n,s]=g.useState(!1),l=()=>{s(!1),a?.focus()};return x.jsxs("div",{className:"block-editor-media-placeholder__url-input-container",children:[x.jsx(M,{__next40pxDefaultSize:!0,className:"block-editor-media-placeholder__button",onClick:()=>{s(!0)},isPressed:n,variant:"secondary","aria-haspopup":"dialog",ref:r,children:t("Insert from URL")}),n&&x.jsx(ie,{src:e,onChange:o,onSubmit:t=>{t.preventDefault(),e&&i&&(i(e),l())},onClose:l,popoverAnchor:a})]})};const re=C("editor.MediaPlaceholder")(function({value:e={},allowedTypes:i,className:a,icon:r,labels:n={},mediaPreview:s,notices:l,isAppender:c,accept:d,addToGallery:u,multiple:p=!1,handleUpload:h=!0,disableDropZone:b,disableMediaButtons:f,onError:j,onSelect:C,onCancel:y,onSelectURL:v,onToggleFeaturedImage:k,onDoubleClick:_,onFilesPreUpload:w=oe,onHTMLDrop:S,children:D,mediaLibraryButton:P,placeholder:N,style:U}){S&&m("wp.blockEditor.MediaPlaceholder onHTMLDrop prop",{since:"6.2",version:"6.4"});const L=o(e=>{const{getSettings:t}=e(E);return t().mediaUpload},[]),[A,H]=g.useState("");g.useEffect(()=>{var t;H(null!==(t=e?.src)&&void 0!==t?t:"")},[e?.src]);const O=t=>{if(!h||"function"==typeof h&&!h(t))return C(t);let o;if(w(t),p)if(u){let t=[];o=o=>{const i=(null!=e?e:[]).filter(e=>e.id?!t.some(({id:t})=>Number(t)===Number(e.id)):!t.some(({urlSlug:t})=>e.url.includes(t)));C(i.concat(o)),t=o.map(e=>{const t=e.url.lastIndexOf("."),o=e.url.slice(0,t);return{id:e.id,urlSlug:o}})}}else o=C;else o=([e])=>C(e);L({allowedTypes:i,filesList:t,onFileChange:o,onError:j})};async function B(e){const t=z({HTML:e});return await async function(e){if(!e||!Array.isArray(e))return;const t=function e(t){return t.flatMap(t=>"core/image"!==t.name&&"core/audio"!==t.name&&"core/video"!==t.name||!t.attributes.url?e(t.innerBlocks):[t])}(e);if(!t.length)return;const o=await Promise.all(t.map(e=>e.attributes.id?e.attributes:new Promise((t,o)=>{window.fetch(e.attributes.url).then(e=>e.blob()).then(a=>L({filesList:[a],additionalData:{title:e.attributes.title,alt_text:e.attributes.alt,caption:e.attributes.caption},onFileChange:([e])=>{e.id&&t(e)},allowedTypes:i,onError:o})).catch(()=>t(e.attributes.url))}))).catch(e=>j(e));C(p?o:o[0])}(t)}const G=e=>{O(e.target.files)},V=null!=N?N:e=>{let{instructions:o,title:d}=n;if(L||v||(o=t("To edit this block, you need permission to upload media.")),void 0===o||void 0===d){const e=null!=i?i:[],[a]=e,r=1===e.length,n=r&&"audio"===a,s=r&&"image"===a,l=r&&"video"===a;void 0===o&&L&&(o=t("Upload a media file or pick one from your media library."),n?o=t("Upload or drag an audio file here, or pick one from your library."):s?o=t("Upload or drag an image file here, or pick one from your library."):l&&(o=t("Upload or drag a video file here, or pick one from your library."))),void 0===d&&(d=t("Media"),n?d=t("Audio"):s?d=t("Image"):l&&(d=t("Video")))}const u=T("block-editor-media-placeholder",a,{"is-appender":c});return x.jsxs(R,{icon:r,label:d,instructions:o,className:u,notices:l,onDoubleClick:_,preview:s,style:U,children:[e,D]})},$=()=>b?null:x.jsx(I,{onFilesDrop:O,onHTMLDrop:B}),q=()=>y&&x.jsx(M,{__next40pxDefaultSize:!0,className:"block-editor-media-placeholder__cancel-button",title:t("Cancel"),variant:"link",onClick:y,children:t("Cancel")}),J=()=>v&&x.jsx(ae,{src:A,onChangeSrc:H,onSelectURL:v}),K=()=>k&&x.jsx("div",{className:"block-editor-media-placeholder__url-input-container",children:x.jsx(M,{__next40pxDefaultSize:!0,className:"block-editor-media-placeholder__button",onClick:k,variant:"secondary",children:t("Use featured image")})});return f?x.jsx(W,{children:$()}):x.jsx(W,{fallback:V(J()),children:(()=>{const o=null!=P?P:({open:e})=>x.jsx(M,{__next40pxDefaultSize:!0,variant:"secondary",onClick:()=>{e()},children:t("Media Library")}),a=x.jsx(Z,{addToGallery:u,gallery:p&&!(!i||0===i.length)&&i.every(e=>"image"===e||e.startsWith("image/")),multiple:p,onSelect:C,allowedTypes:i,mode:"browse",value:Array.isArray(e)?e.map(({id:e})=>e):e.id,render:o});if(L&&c)return x.jsxs(x.Fragment,{children:[$(),x.jsx(F,{onChange:G,accept:d,multiple:!!p,render:({openFileDialog:e})=>{const o=x.jsxs(x.Fragment,{children:[x.jsx(M,{__next40pxDefaultSize:!0,variant:"primary",className:T("block-editor-media-placeholder__button","block-editor-media-placeholder__upload-button"),onClick:e,children:t("Upload")}),a,J(),K(),q()]});return V(o)}})]});if(L){const e=x.jsxs(x.Fragment,{children:[$(),x.jsx(F,{render:({openFileDialog:e})=>x.jsx(M,{__next40pxDefaultSize:!0,onClick:e,variant:"primary",className:T("block-editor-media-placeholder__button","block-editor-media-placeholder__upload-button"),children:t("Upload")}),onChange:G,accept:d,multiple:!!p}),a,J(),K(),q()]});return V(e)}return V(a)})()})});export{te as I,W as M,Z as a,re as i};
