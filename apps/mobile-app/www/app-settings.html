<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>앱 설정 - O4O Mobile</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: #f5f5f5;
        color: #333;
        min-height: 100vh;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #667eea;
      }

      .version {
        color: #666;
        font-size: 0.9rem;
      }

      .section {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
      }

      .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
      }

      .setting-item:last-child {
        border-bottom: none;
      }

      .setting-label {
        font-size: 0.95rem;
        color: #555;
      }

      .setting-value {
        font-size: 0.9rem;
        color: #999;
      }

      .permission-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .permission-granted {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .permission-denied {
        background: #ffebee;
        color: #c62828;
      }

      .permission-prompt {
        background: #fff3e0;
        color: #e65100;
      }

      .button {
        display: block;
        width: 100%;
        padding: 14px;
        margin-top: 10px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .button:hover {
        background: #5568d3;
      }

      .button-danger {
        background: #f44336;
      }

      .button-danger:hover {
        background: #d32f2f;
      }

      .button-secondary {
        background: #9e9e9e;
      }

      .button-secondary:hover {
        background: #757575;
      }

      .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 12px;
        margin-top: 15px;
        border-radius: 4px;
        font-size: 0.9rem;
        color: #1565c0;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #999;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>앱 설정</h1>
      <div class="version" id="appVersion">버전: 로딩 중...</div>
    </div>

    <div class="section">
      <div class="section-title">앱 정보</div>
      <div class="setting-item">
        <div class="setting-label">플랫폼</div>
        <div class="setting-value" id="platform">-</div>
      </div>
      <div class="setting-item">
        <div class="setting-label">앱 버전</div>
        <div class="setting-value" id="version">-</div>
      </div>
      <div class="setting-item">
        <div class="setting-label">빌드 번호</div>
        <div class="setting-value" id="build">-</div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">권한 상태</div>
      <div class="setting-item">
        <div class="setting-label">카메라</div>
        <div class="permission-status" id="cameraPermission">확인 중...</div>
      </div>
      <div class="setting-item">
        <div class="setting-label">알림</div>
        <div class="permission-status" id="pushPermission">확인 중...</div>
      </div>
      <div class="setting-item">
        <div class="setting-label">위치</div>
        <div class="permission-status" id="locationPermission">확인 중...</div>
      </div>
      <div class="setting-item">
        <div class="setting-label">바코드 스캔</div>
        <div class="permission-status" id="barcodePermission">확인 중...</div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">캐시 관리</div>
      <button class="button button-secondary" onclick="clearAppCache()">캐시 삭제</button>
      <div class="info-box">
        캐시를 삭제하면 임시 파일과 이미지가 제거됩니다.
      </div>
    </div>

    <div class="section">
      <div class="section-title">테스트</div>
      <button class="button" onclick="testCamera()">카메라 테스트</button>
      <button class="button" onclick="testLocation()">위치 테스트</button>
      <button class="button" onclick="testBarcode()">바코드 스캔 테스트</button>
    </div>

    <div class="section">
      <div class="section-title">계정</div>
      <button class="button button-danger" onclick="logout()">로그아웃</button>
    </div>

    <script type="module">
      // main.ts 로드 (window.O4O 사용 가능하도록)
      import '../src/main.ts';

      // 앱 정보 로드
      async function loadAppInfo() {
        const { mobile } = window.O4O;

        // 플랫폼
        document.getElementById('platform').textContent = mobile.platform.getPlatform();

        // 앱 정보
        if (mobile.platform.isNative()) {
          const appInfo = await mobile.utils.getAppInfo();
          if (appInfo) {
            document.getElementById('version').textContent = appInfo.version;
            document.getElementById('build').textContent = appInfo.build;
            document.getElementById('appVersion').textContent = `버전 ${appInfo.version} (${appInfo.build})`;
          }
        } else {
          document.getElementById('version').textContent = 'Web';
          document.getElementById('build').textContent = '-';
        }

        // 권한 확인
        await checkPermissions();
      }

      // 권한 확인
      async function checkPermissions() {
        const { mobile } = window.O4O;

        // 카메라
        const cameraStatus = await mobile.camera.checkPermissions();
        updatePermissionUI('cameraPermission', cameraStatus);

        // 푸시
        const pushStatus = await mobile.push.checkPermissions();
        updatePermissionUI('pushPermission', pushStatus);

        // 위치
        const locationStatus = await mobile.location.checkPermissions();
        updatePermissionUI('locationPermission', locationStatus?.location || 'unknown');

        // 바코드
        const barcodeStatus = await mobile.barcode.checkPermissions();
        updatePermissionUI('barcodePermission', barcodeStatus);
      }

      // 권한 UI 업데이트
      function updatePermissionUI(elementId, status) {
        const element = document.getElementById(elementId);
        element.className = 'permission-status';

        if (status === 'granted') {
          element.classList.add('permission-granted');
          element.textContent = '허용됨';
        } else if (status === 'denied') {
          element.classList.add('permission-denied');
          element.textContent = '거부됨';
        } else {
          element.classList.add('permission-prompt');
          element.textContent = '미설정';
        }
      }

      // 캐시 삭제
      window.clearAppCache = async function () {
        const { mobile } = window.O4O;
        const success = await mobile.file.clearCache();
        if (success) {
          alert('캐시가 삭제되었습니다.');
        } else {
          alert('캐시 삭제에 실패했습니다.');
        }
      };

      // 카메라 테스트
      window.testCamera = async function () {
        const { mobile } = window.O4O;
        const image = await mobile.camera.pickImage();
        if (image) {
          alert('카메라 테스트 성공!\n이미지 크기: ' + image.length + ' bytes');
        } else {
          alert('카메라 테스트 실패');
        }
      };

      // 위치 테스트
      window.testLocation = async function () {
        const { mobile } = window.O4O;
        const location = await mobile.location.getSimpleLocation();
        if (location) {
          alert(`위치 테스트 성공!\n위도: ${location.lat}\n경도: ${location.lng}`);
        } else {
          alert('위치 테스트 실패');
        }
      };

      // 바코드 스캔 테스트
      window.testBarcode = async function () {
        const { mobile } = window.O4O;
        const result = await mobile.barcode.scan();
        if (result) {
          alert('바코드 스캔 성공!\n내용: ' + result);
        } else {
          alert('바코드 스캔 취소 또는 실패');
        }
      };

      // 로그아웃
      window.logout = function () {
        if (confirm('정말 로그아웃하시겠습니까?')) {
          // TODO: 실제 로그아웃 로직 구현
          alert('로그아웃 되었습니다.');
          window.location.href = '/';
        }
      };

      // 페이지 로드 시 실행
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(loadAppInfo, 500); // main.ts 로드 대기
      });
    </script>
  </body>
</html>
