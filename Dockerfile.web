# O4O Platform - Web Service Dockerfile
# monorepo 루트에서 빌드, 특정 서비스만 배포
#
# Usage:
#   docker build -f Dockerfile.web --build-arg SERVICE_PATH=services/web-glycopharm -t glycopharm-web .
#   docker build -f Dockerfile.web --build-arg SERVICE_PATH=apps/glucoseview-web -t glucoseview-web .

# Build stage
FROM node:20-alpine AS builder

# 빌드할 서비스 경로 지정 (예: services/web-glycopharm, apps/glucoseview-web)
ARG SERVICE_PATH
ENV SERVICE_PATH=${SERVICE_PATH}

# Vite 빌드 시 API URL
ARG VITE_API_BASE_URL=https://o4o-core-api-117791934476.asia-northeast3.run.app
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL

WORKDIR /app

# pnpm 설치
RUN npm install -g pnpm@9

# 의존성 파일 복사
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# 서비스 package.json 복사
COPY ${SERVICE_PATH}/package.json ./${SERVICE_PATH}/

# 의존성 설치 (서비스만)
RUN pnpm install --filter "./${SERVICE_PATH}" --frozen-lockfile

# 서비스 소스 복사
COPY ${SERVICE_PATH} ./${SERVICE_PATH}

# 빌드
RUN pnpm --filter "./${SERVICE_PATH}" build

# Production stage
FROM node:20-alpine AS runner

WORKDIR /app

# serve 설치 (정적 파일 서빙)
RUN npm install -g serve

# 빌드 결과물 복사
ARG SERVICE_PATH
COPY --from=builder /app/${SERVICE_PATH}/dist ./dist

# Cloud Run PORT
ENV PORT=8080
EXPOSE 8080

# 정적 파일 서빙
CMD ["serve", "-s", "dist", "-l", "8080"]
